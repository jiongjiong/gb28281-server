# GB28181è§†é¢‘å¹³å°å‰ç«¯è¯¦ç»†è®¾è®¡æ–¹æ¡ˆ (ä¼˜åŒ–ç‰ˆ)

æŠ€æœ¯æ ˆç¡®å®šä¸é¡¹ç›®åˆå§‹åŒ–ï¼šVue3 + TypeScript + Vite + Pinia + Element Plus + Tailwind CSS + æ’­æ”¾å™¨é›†æˆ

## ğŸš€ ä¼˜åŒ–äº®ç‚¹

- **åŸºäºæˆç†Ÿè„šæ‰‹æ¶**: ä½¿ç”¨ vue-element-plus-admin å‡å°‘åŸºç¡€å¼€å‘å·¥ä½œ
- **Tailwind CSSé›†æˆ**: æ›¿ä»£SCSSï¼Œæå‡å¼€å‘æ•ˆç‡å’Œæ ·å¼ä¸€è‡´æ€§  
- **Element Plusç”Ÿæ€**: ä¸°å¯Œçš„ç»„ä»¶åº“å’Œå®Œå–„çš„æ–‡æ¡£æ”¯æŒ
- **å¼€ç®±å³ç”¨**: é›†æˆæƒé™ç®¡ç†ã€å›½é™…åŒ–ã€ä¸»é¢˜åˆ‡æ¢ç­‰åŠŸèƒ½

## 1. æŠ€æœ¯æ ˆç¡®å®šä¸é¡¹ç›®åˆå§‹åŒ–

### 1.1 ä¼˜åŒ–åçš„æ ¸å¿ƒæŠ€æœ¯æ ˆ

```json
{
  "framework": "Vue 3.4+",
  "language": "TypeScript 5.0+", 
  "bundler": "Vite 5.0+",
  "state": "Pinia 2.1+",
  "ui": "Element Plus 2.4+ (æ›¿ä»£Antd Vue)",
  "styling": "Tailwind CSS 3.4+ (æ›¿ä»£SCSS)",
  "base": "vue-element-plus-admin è„šæ‰‹æ¶",
  "router": "Vue Router 4.0+",
  "http": "Axios 1.6+",
  "websocket": "åŸç”ŸWebSocket + é‡è¿æœºåˆ¶",
  "players": ["Jessibuca 3.0+", "H265Web.js"],
  "build": "Docker + Nginx",
  "extras": ["å›½é™…åŒ–", "æƒé™ç®¡ç†", "ä¸»é¢˜åˆ‡æ¢", "Mockæ•°æ®"]
}
```

### 1.2 Tailwind CSS é…ç½®

```bash
# å®‰è£… Tailwind CSS
npm install -D tailwindcss@latest postcss@latest autoprefixer@latest

# åˆå§‹åŒ–é…ç½®
npx tailwindcss init -p
```

```javascript
// tailwind.config.js
module.exports = {
  content: [
    "./index.html",
    "./src/**/*.{vue,js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {
      colors: {
        // GB28181å¹³å°ä¸“ç”¨è‰²å½©
        'video-primary': '#1890ff',
        'video-success': '#52c41a', 
        'video-warning': '#faad14',
        'video-error': '#ff4d4f',
        'device-online': '#52c41a',
        'device-offline': '#d9d9d9',
        'stream-active': '#1890ff',
        'player-bg': '#000000',
      },
      spacing: {
        // è§†é¢‘æ’­æ”¾å™¨ä¸“ç”¨å°ºå¯¸
        'player-sm': '240px',
        'player-md': '360px', 
        'player-lg': '480px',
        'player-xl': '720px',
        'control-bar': '48px',
      },
      animation: {
        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
        'blink': 'blink 1s step-start infinite',
      }
    },
  },
  plugins: [
    require('@tailwindcss/forms'),
    require('@tailwindcss/aspect-ratio'),
  ],
}
```

```css
/* src/assets/styles/tailwind.css */
@tailwind base;
@tailwind components; 
@tailwind utilities;

/* GB28181è§†é¢‘å¹³å°è‡ªå®šä¹‰ç»„ä»¶æ ·å¼ */
@layer components {
  .video-player-container {
    @apply relative bg-black rounded-lg overflow-hidden shadow-lg;
  }
  
  .device-status-online {
    @apply inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800;
  }
  
  .device-status-offline {
    @apply inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800;
  }
  
  .stream-control-btn {
    @apply inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-video-primary hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out;
  }
  
  .ptz-control-pad {
    @apply grid grid-cols-3 gap-1 w-24 h-24 bg-gray-100 rounded-lg p-2;
  }
  
  .ptz-control-btn {
    @apply flex items-center justify-center bg-white hover:bg-gray-50 border border-gray-300 rounded-md shadow-sm cursor-pointer transition-colors duration-150;
  }
}

@layer utilities {
  .text-device-online {
    color: theme('colors.device-online');
  }
  
  .text-device-offline {
    color: theme('colors.device-offline');
  }
  
  .aspect-video-player {
    aspect-ratio: 16 / 9;
  }
}
```

### 1.3 åŸºäºè„šæ‰‹æ¶çš„é¡¹ç›®åˆå§‹åŒ–

```bash
# 1. å…‹éš†è„šæ‰‹æ¶é¡¹ç›®
git clone https://github.com/kailong321200875/vue-element-plus-admin.git gb28181-video-platform
cd gb28181-video-platform

# 2. å®‰è£…ä¾èµ–
pnpm install

# 3. æ·»åŠ  GB28181 ä¸“ç”¨ä¾èµ–
pnpm add jessibuca h265web-js
pnpm add -D tailwindcss postcss autoprefixer @tailwindcss/forms @tailwindcss/aspect-ratio

# 4. åˆå§‹åŒ– Tailwind CSS
npx tailwindcss init -p
```

```json
// package.json (åŸºäºè„šæ‰‹æ¶æ‰©å±•)
{
  "name": "gb28181-video-platform",
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite --host 0.0.0.0 --port 3000",
    "build:prod": "vue-tsc && vite build --mode production",
    "build:dev": "vue-tsc && vite build --mode development", 
    "preview": "vite preview",
    "lint": "eslint . --ext .vue,.js,.jsx,.cjs,.mjs,.ts,.tsx,.cts,.mts --fix",
    "type-check": "vue-tsc --noEmit",
    "test": "vitest",
    "video:dev": "vite --mode video-dev",
    "tailwind:watch": "tailwindcss -i ./src/assets/styles/tailwind.css -o ./src/assets/styles/output.css --watch"
  },
  "dependencies": {
    // ç»§æ‰¿è„šæ‰‹æ¶ä¾èµ–
    "vue": "^3.4.0",
    "vue-router": "^4.2.0", 
    "pinia": "^2.1.0",
    "element-plus": "^2.4.0",
    "axios": "^1.6.0",
    "dayjs": "^1.11.0",
    "lodash-es": "^4.17.0",
    "echarts": "^5.4.0",
    "vue-i18n": "^9.8.0",
    
    // GB28181 ä¸“ç”¨ä¾èµ–
    "jessibuca": "^3.0.0",
    "h265web-js": "^1.0.0",
    "@types/jessibuca": "^1.0.0"
  },
  "devDependencies": {
    // ç»§æ‰¿è„šæ‰‹æ¶å¼€å‘ä¾èµ–
    "@types/node": "^20.0.0",
    "@types/lodash-es": "^4.17.0", 
    "@vitejs/plugin-vue": "^4.5.0",
    "typescript": "^5.0.0",
    "vite": "^5.0.0",
    "vue-tsc": "^1.8.0",
    "eslint": "^8.0.0",
    "vitest": "^1.0.0",
    
    // Tailwind CSS
    "tailwindcss": "^3.4.0",
    "postcss": "^8.4.0", 
    "autoprefixer": "^10.4.0",
    "@tailwindcss/forms": "^0.5.0",
    "@tailwindcss/aspect-ratio": "^0.4.0"
  }
}
```

### 1.4 Vite é…ç½®ä¼˜åŒ–

```typescript
// vite.config.ts (åŸºäºè„šæ‰‹æ¶æ‰©å±•)
import { defineConfig, loadEnv } from 'vite'
import vue from '@vitejs/plugin-vue'
import { resolve } from 'path'
import { createSvgIconsPlugin } from 'vite-plugin-svg-icons'

export default defineConfig(({ mode }) => {
  const env = loadEnv(mode, process.cwd())
  
  return {
    plugins: [
      vue(),
      createSvgIconsPlugin({
        iconDirs: [resolve(process.cwd(), 'src/assets/icons')],
        symbolId: 'icon-[dir]-[name]'
      })
    ],
    resolve: {
      alias: {
        '@': resolve(__dirname, 'src'),
        '@business': resolve(__dirname, 'src/components/business'),
        '@players': resolve(__dirname, 'public/players')
      }
    },
    css: {
      postcss: {
        plugins: [
          require('tailwindcss'),
          require('autoprefixer')
        ]
      }
    },
    server: {
      host: '0.0.0.0',
      port: Number(env.VITE_PORT) || 3000,
      proxy: {
        '/api': {
          target: env.VITE_API_BASE_URL,
          changeOrigin: true,
          rewrite: (path) => path.replace(/^\/api/, '')
        },
        '/ws': {
          target: env.VITE_WS_BASE_URL,
          ws: true,
          changeOrigin: true
        }
      }
    },
    build: {
      rollupOptions: {
        output: {
          manualChunks: {
            'element-plus': ['element-plus'],
            'video-players': ['jessibuca', 'h265web-js'],
            'vue-vendor': ['vue', 'vue-router', 'pinia']
          }
        }
      }
    }
  }
})
```

## 2. åŸºäºè„šæ‰‹æ¶çš„ä¼˜åŒ–æ¶æ„è®¾è®¡

### 2.1 é¡¹ç›®ç›®å½•ç»“æ„ä¼˜åŒ–

åŸºäº vue-element-plus-admin è„šæ‰‹æ¶ï¼Œæ•´åˆ GB28181 è§†é¢‘å¹³å°åŠŸèƒ½ï¼š

```
gb28181-video-platform/
â”œâ”€â”€ public/
â”‚   â”œâ”€â”€ players/                     # æ’­æ”¾å™¨èµ„æº
â”‚   â”‚   â”œâ”€â”€ jessibuca/              # Jessibucaæ’­æ”¾å™¨
â”‚   â”‚   â””â”€â”€ h265web/                # H265Web.jsæ’­æ”¾å™¨
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ business/               # GB28181ä¸šåŠ¡ç»„ä»¶ (æ–°å¢)
â”‚   â”‚   â”‚   â”œâ”€â”€ VideoPlayer/        # è§†é¢‘æ’­æ”¾å™¨ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ DeviceTree/         # è®¾å¤‡æ ‘ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ PTZControl/         # äº‘å°æ§åˆ¶ç»„ä»¶
â”‚   â”‚   â”‚   â””â”€â”€ StreamMonitor/      # æµç›‘æ§ç»„ä»¶
â”‚   â”‚   â””â”€â”€ common/                 # ç»§æ‰¿è„šæ‰‹æ¶åŸºç¡€ç»„ä»¶
â”‚   â”œâ”€â”€ views/
â”‚   â”‚   â”œâ”€â”€ device/                 # è®¾å¤‡ç®¡ç†é¡µé¢ (æ–°å¢)
â”‚   â”‚   â”œâ”€â”€ monitor/                # å®æ—¶ç›‘æ§é¡µé¢ (æ–°å¢)
â”‚   â”‚   â”œâ”€â”€ playback/               # å½•åƒå›æ”¾é¡µé¢ (æ–°å¢)
â”‚   â”‚   â””â”€â”€ dashboard/              # ä»ªè¡¨æ¿ (ç»§æ‰¿å¹¶æ‰©å±•)
â”‚   â”œâ”€â”€ stores/modules/
â”‚   â”‚   â”œâ”€â”€ device.ts               # è®¾å¤‡çŠ¶æ€ç®¡ç† (æ–°å¢)
â”‚   â”‚   â”œâ”€â”€ stream.ts               # æµçŠ¶æ€ç®¡ç† (æ–°å¢)
â”‚   â”‚   â””â”€â”€ record.ts               # å½•åƒçŠ¶æ€ç®¡ç† (æ–°å¢)
â”‚   â”œâ”€â”€ assets/styles/
â”‚   â”‚   â”œâ”€â”€ tailwind.css            # Tailwind CSSä¸»æ–‡ä»¶
â”‚   â”‚   â””â”€â”€ video-components.css    # è§†é¢‘ç»„ä»¶ä¸“ç”¨æ ·å¼
â”‚   â””â”€â”€ composables/                # GB28181ä¸“ç”¨composables
â”‚       â”œâ”€â”€ usePlayer.ts            # æ’­æ”¾å™¨ç®¡ç†
â”‚       â”œâ”€â”€ useDevice.ts            # è®¾å¤‡æ“ä½œ
â”‚       â””â”€â”€ useStream.ts            # æµç®¡ç†
```

### 2.2 Tailwind CSS é›†æˆä¼˜åŠ¿

1. **å¼€å‘æ•ˆç‡æå‡**: åŸå­åŒ–CSSç±»ï¼Œå¿«é€Ÿæ„å»ºç•Œé¢
2. **æ ·å¼ä¸€è‡´æ€§**: ç»Ÿä¸€çš„è®¾è®¡ç³»ç»Ÿå’Œé¢œè‰²è§„èŒƒ
3. **å“åº”å¼è®¾è®¡**: å†…ç½®å“åº”å¼å·¥å…·ç±»
4. **ä½“ç§¯ä¼˜åŒ–**: ç”Ÿäº§ç¯å¢ƒè‡ªåŠ¨æ¸…ç†æœªä½¿ç”¨çš„æ ·å¼
5. **ç»´æŠ¤æˆæœ¬ä½**: å‡å°‘è‡ªå®šä¹‰CSSç¼–å†™å’Œç»´æŠ¤

### 2.3 Element Plus + Tailwind CSS ç»„ä»¶å®ç°ç¤ºä¾‹

#### 2.3.1 ä¼˜åŒ–åçš„è§†é¢‘æ’­æ”¾å™¨ç»„ä»¶

```vue
<!-- src/components/business/VideoPlayer/index.vue -->
<template>
  <div class="video-player-container aspect-video-player">
    <!-- æ’­æ”¾å™¨åŒºåŸŸ -->
    <div class="relative w-full h-full bg-player-bg rounded-lg overflow-hidden">
      <!-- Jessibucaæ’­æ”¾å™¨ -->
      <div 
        v-if="currentPlayerType === 'jessibuca'" 
        :id="playerId" 
        class="w-full h-full"
      ></div>
      
      <!-- æ§åˆ¶æ  -->
      <div 
        v-show="showControls" 
        class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-4 opacity-0 hover:opacity-100 transition-opacity duration-300"
      >
        <div class="flex items-center justify-between text-white">
          <!-- å·¦ä¾§æ§åˆ¶ -->
          <div class="flex items-center space-x-2">
            <el-button 
              :type="isPlaying ? 'default' : 'primary'" 
              @click="togglePlay"
              size="small"
              class="stream-control-btn"
            >
              <el-icon><VideoPause v-if="isPlaying" /><VideoPlay v-else /></el-icon>
            </el-button>
            
            <el-button @click="handleSnapshot" size="small" class="stream-control-btn">
              <el-icon><Camera /></el-icon>
              æˆªå›¾
            </el-button>
          </div>
          
          <!-- å³ä¾§æ§åˆ¶ -->
          <div class="flex items-center space-x-2">
            <el-select 
              v-model="currentStreamType" 
              size="small" 
              @change="handleStreamChange"
              class="w-24"
            >
              <el-option label="ä¸»ç æµ" value="main" />
              <el-option label="å­ç æµ" value="sub" />
            </el-select>
            
            <el-button @click="toggleFullscreen" size="small" class="stream-control-btn">
              <el-icon><FullScreen /></el-icon>
            </el-button>
          </div>
        </div>
      </div>
      
      <!-- åŠ è½½çŠ¶æ€ -->
      <div 
        v-show="loading" 
        class="absolute inset-0 flex flex-col items-center justify-center bg-black/50 text-white"
      >
        <el-icon class="animate-spin text-4xl mb-4"><Loading /></el-icon>
        <p>æ­£åœ¨åŠ è½½è§†é¢‘æµ...</p>
      </div>
    </div>
    
    <!-- äº‘å°æ§åˆ¶é¢æ¿ -->
    <PTZControl 
      v-if="showPTZ && ptzEnabled" 
      :device-id="deviceId" 
      :channel-id="channelId"
      class="absolute top-4 right-4"
    />
  </div>
</template>

<script setup lang="ts">
import { ref, computed } from 'vue'
import { ElButton, ElSelect, ElOption, ElIcon } from 'element-plus'
import { VideoPlay, VideoPause, Camera, FullScreen, Loading } from '@element-plus/icons-vue'
import { usePlayer } from '@/composables/usePlayer'
import PTZControl from '../PTZControl/index.vue'

interface Props {
  deviceId: string
  channelId: string
  streamType?: 'main' | 'sub'
  showControls?: boolean
  showPTZ?: boolean
  autoPlay?: boolean
}

const props = withDefaults(defineProps<Props>(), {
  streamType: 'main',
  showControls: true,
  showPTZ: false,
  autoPlay: true
})

// ä½¿ç”¨æ’­æ”¾å™¨ç®¡ç†composable
const {
  playerId,
  currentPlayerType,
  isPlaying,
  loading,
  togglePlay,
  toggleFullscreen
} = usePlayer()

const currentStreamType = ref(props.streamType)
const ptzEnabled = computed(() => true) // ç®€åŒ–ç¤ºä¾‹

const handleSnapshot = () => { /* æˆªå›¾é€»è¾‘ */ }
const handleStreamChange = () => { /* æµåˆ‡æ¢é€»è¾‘ */ }
</script>

<style scoped>
.video-player-container {
  @apply relative w-full bg-black rounded-lg overflow-hidden shadow-lg;
}

.stream-control-btn {
  @apply inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-video-primary hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out;
}
</style>
```

#### 2.3.2 è®¾å¤‡çŠ¶æ€ç»„ä»¶

```vue
<!-- src/components/business/DeviceStatus/index.vue -->
<template>
  <div class="device-status-card bg-white rounded-lg shadow-md p-6">
    <div class="flex items-center justify-between">
      <div class="flex items-center">
        <el-icon class="mr-3 text-2xl" :class="deviceIconClass">
          <Camera v-if="device.deviceType === 'IPC'" />
          <VideoCamera v-else-if="device.deviceType === 'NVR'" />
          <Monitor v-else />
        </el-icon>
        <div>
          <h3 class="text-lg font-semibold text-gray-900">{{ device.name }}</h3>
          <p class="text-sm text-gray-500">{{ device.deviceId }}</p>
        </div>
      </div>
      
      <div class="text-right">
        <span :class="statusClass">
          <span class="w-2 h-2 rounded-full inline-block mr-2" 
                :class="device.status === 'online' ? 'bg-green-500 animate-pulse-slow' : 'bg-gray-400'">
          </span>
          {{ device.status === 'online' ? 'åœ¨çº¿' : 'ç¦»çº¿' }}
        </span>
        <p class="text-sm text-gray-500 mt-1">
          é€šé“: {{ device.channels?.length || 0 }}
        </p>
      </div>
    </div>
    
    <!-- è®¾å¤‡æ“ä½œ -->
    <div class="mt-4 flex space-x-2">
      <el-button size="small" @click="$emit('view', device)">æŸ¥çœ‹</el-button>
      <el-button size="small" type="primary" @click="$emit('edit', device)">ç¼–è¾‘</el-button>
      <el-button size="small" @click="$emit('channels', device)">é€šé“</el-button>
    </div>
  </div>
</template>

<script setup lang="ts">
import { computed } from 'vue'
import { ElButton, ElIcon } from 'element-plus'
import { Camera, VideoCamera, Monitor } from '@element-plus/icons-vue'

interface Props {
  device: {
    id: string
    name: string
    deviceId: string
    deviceType: 'IPC' | 'NVR' | 'DVR'
    status: 'online' | 'offline'
    channels?: any[]
  }
}

const props = defineProps<Props>()

defineEmits<{
  view: [device: Props['device']]
  edit: [device: Props['device']]
  channels: [device: Props['device']]
}>()

const deviceIconClass = computed(() => ({
  'text-green-500': props.device.status === 'online',
  'text-gray-400': props.device.status === 'offline'
}))

const statusClass = computed(() => 
  props.device.status === 'online' 
    ? 'device-status-online' 
    : 'device-status-offline'
)
</script>

<style scoped>
.device-status-online {
  @apply inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800;
}

.device-status-offline {
  @apply inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800;
}
</style>
```

## 3. ä¼˜åŒ–æ–¹æ¡ˆæ•ˆç›Šæ€»ç»“

### 3.1 å¼€å‘æ•ˆç‡æå‡

#### 3.1.1 ä½¿ç”¨è„šæ‰‹æ¶çš„ä¼˜åŠ¿

âœ… **ç«‹å³å¯ç”¨çš„åŠŸèƒ½**:
- ç”¨æˆ·è®¤è¯å’Œæƒé™ç®¡ç†ç³»ç»Ÿ
- å›½é™…åŒ–æ”¯æŒ (i18n)
- ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
- è·¯ç”±å’Œå¯¼èˆªç®¡ç†
- Mock æ•°æ®æ”¯æŒ
- ESLint/Prettier ä»£ç è§„èŒƒ
- å•å…ƒæµ‹è¯•æ¡†æ¶

âœ… **å‡å°‘å¼€å‘å·¥ä½œé‡**:
```bash
# åŸæ–¹æ¡ˆéœ€è¦ä»å¤´å¼€å‘çš„åŠŸèƒ½
- ç”¨æˆ·ç™»å½•/æ³¨é”€: ~3å¤©
- æƒé™ç®¡ç†: ~5å¤©  
- å›½é™…åŒ–: ~2å¤©
- ä¸»é¢˜åˆ‡æ¢: ~2å¤©
- è·¯ç”±é…ç½®: ~1å¤©
- åŸºç¡€å¸ƒå±€: ~3å¤©

# æ€»è®¡èŠ‚çœ: ~16å¤©å¼€å‘æ—¶é—´
```

#### 3.1.2 Tailwind CSS çš„ä¼˜åŠ¿

âœ… **å¿«é€ŸåŸå‹å¼€å‘**:
```html
<!-- ä¼ ç»Ÿæ–¹å¼: éœ€è¦å†™CSSç±» -->
<div class="video-player-container">
  <div class="player-controls">
    <button class="control-button primary">æ’­æ”¾</button>
  </div>
</div>

<!-- Tailwindæ–¹å¼: ç›´æ¥ä½¿ç”¨å·¥å…·ç±» -->
<div class="relative w-full h-64 bg-black rounded-lg shadow-lg">
  <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 p-4">
    <button class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">æ’­æ”¾</button>
  </div>
</div>
```

âœ… **æ ·å¼ä¸€è‡´æ€§**:
- ç»Ÿä¸€çš„é¢œè‰²ç³»ç»Ÿ
- ä¸€è‡´çš„é—´è·å’Œå­—ä½“å¤§å°
- æ ‡å‡†åŒ–çš„é˜´å½±å’Œåœ†è§’
- å“åº”å¼æ–­ç‚¹ç»Ÿä¸€

### 3.2 ç»´æŠ¤æˆæœ¬é™ä½

#### 3.2.1 ä»£ç å¤ç”¨æå‡

```typescript
// åŸæ–¹æ¡ˆ: æ¯ä¸ªç»„ä»¶éƒ½éœ€è¦å•ç‹¬æ ·å¼
// DeviceCard.vue - éœ€è¦å†™ 50+ è¡ŒCSS
// StreamCard.vue - éœ€è¦å†™ 40+ è¡ŒCSS  
// PlayerCard.vue - éœ€è¦å†™ 60+ è¡ŒCSS

// ä¼˜åŒ–æ–¹æ¡ˆ: å¤ç”¨Tailwindç±»
const cardClasses = "bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow"
const statusClasses = {
  online: "inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800",
  offline: "inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800"
}
```

#### 3.2.2 ç‰ˆæœ¬å‡çº§ç®€åŒ–

```json
{
  "åŸæ–¹æ¡ˆå‡çº§å¤æ‚åº¦": {
    "Ant Design Vue": "éœ€è¦ä¿®æ”¹å¤§é‡ç»„ä»¶å¼•ç”¨å’Œæ ·å¼è¦†ç›–",
    "è‡ªå®šä¹‰SCSS": "éœ€è¦æ£€æŸ¥å’Œä¿®å¤æ ·å¼å†²çª",
    "ä¼°è®¡å·¥ä½œé‡": "3-5å¤©"
  },
  "ä¼˜åŒ–æ–¹æ¡ˆå‡çº§ç®€åŒ–": {
    "Element Plus": "è„šæ‰‹æ¶ä¼šå®šæœŸæ›´æ–°ï¼Œå‡çº§æˆæœ¬ä½",
    "Tailwind CSS": "å‘åå…¼å®¹æ€§å¥½ï¼Œå‡çº§é£é™©å°",
    "ä¼°è®¡å·¥ä½œé‡": "0.5-1å¤©"
  }
}
```

### 3.3 æ€§èƒ½ä¼˜åŒ–æ•ˆæœ

#### 3.3.1 æ„å»ºä½“ç§¯å¯¹æ¯”

```bash
# åŸæ–¹æ¡ˆ (Ant Design Vue + SCSS)
- node_modules: ~180MB
- æ„å»ºäº§ç‰©: ~2.1MB (gzipped)
- CSSæ–‡ä»¶: ~450KB

# ä¼˜åŒ–æ–¹æ¡ˆ (Element Plus + Tailwind CSS)  
- node_modules: ~165MB (-15MB)
- æ„å»ºäº§ç‰©: ~1.8MB (gzipped, -300KB)
- CSSæ–‡ä»¶: ~280KB (-170KB)
```

#### 3.3.2 è¿è¡Œæ—¶æ€§èƒ½

```typescript
// Tailwind CSS ä¼˜åŠ¿
{
  "CSSè§£æé€Ÿåº¦": "æ›´å¿« (åŸå­åŒ–ç±»å‡å°‘CSSè§£æå¤æ‚åº¦)",
  "æ ·å¼è®¡ç®—": "æ›´å¿« (ç®€å•çš„ç±»ååŒ¹é…)",
  "é‡ç»˜/é‡æ’": "æ›´å°‘ (ç²¾ç¡®çš„æ ·å¼æ§åˆ¶)",
  "ç¼“å­˜æ•ˆç‡": "æ›´é«˜ (å·¥å…·ç±»å¯ä»¥è·¨ç»„ä»¶å¤ç”¨)"
}
```

### 3.4 å›¢é˜Ÿåä½œä¼˜åŠ¿

#### 3.4.1 å­¦ä¹ æˆæœ¬

```bash
# åŸæ–¹æ¡ˆå­¦ä¹ è·¯å¾„
1. Vue3 + TypeScript + Vite (åŸºç¡€)
2. Ant Design Vue API (ç»„ä»¶åº“)  
3. SCSSè¯­æ³•å’Œé¡¹ç›®ç»“æ„ (æ ·å¼ç³»ç»Ÿ)
4. è‡ªå®šä¹‰ç»„ä»¶å¼€å‘ (ä¸šåŠ¡é€»è¾‘)
5. æƒé™ã€è·¯ç”±ã€çŠ¶æ€ç®¡ç† (ç³»ç»Ÿæ¶æ„)

# ä¼˜åŒ–æ–¹æ¡ˆå­¦ä¹ è·¯å¾„
1. Vue3 + TypeScript + Vite (åŸºç¡€)
2. Element Plus API (ç»„ä»¶åº“, æ–‡æ¡£æ›´å®Œå–„)
3. Tailwind CSS å·¥å…·ç±» (æ ·å¼ç³»ç»Ÿ, å­¦ä¹ æ›²çº¿å¹³ç¼“)
4. è„šæ‰‹æ¶åŠŸèƒ½ä½¿ç”¨ (å¼€ç®±å³ç”¨)
5. GB28181ä¸šåŠ¡ç»„ä»¶å¼€å‘ (ä¸“æ³¨æ ¸å¿ƒä¸šåŠ¡)
```

#### 3.4.2 ä»£ç è§„èŒƒç»Ÿä¸€

```css
/* åŸæ–¹æ¡ˆ: å®¹æ˜“å‡ºç°ä¸ç»Ÿä¸€çš„æ ·å¼ */
.button-primary { background: #1890ff; }
.btn-main { background: #1890ff; }  
.primary-btn { background: #2b7ce6; } /* é¢œè‰²ä¸ä¸€è‡´ */

/* ä¼˜åŒ–æ–¹æ¡ˆ: ç»Ÿä¸€çš„è®¾è®¡ç³»ç»Ÿ */
.bg-video-primary /* å§‹ç»ˆæ˜¯ #1890ff */
.text-device-online /* å§‹ç»ˆæ˜¯ #52c41a */
.rounded-lg /* å§‹ç»ˆæ˜¯ 0.5rem */
```

### 3.5 å®æ–½å»ºè®®

#### 3.5.1 è¿ç§»ç­–ç•¥

```bash
# ç¬¬ä¸€é˜¶æ®µ: åŸºç¡€æ¡†æ¶æ­å»º (1-2å‘¨)
1. å…‹éš† vue-element-plus-admin è„šæ‰‹æ¶
2. é…ç½® Tailwind CSS
3. æ·»åŠ  GB28181 ä¸“ç”¨ä¾èµ–
4. é…ç½®æ’­æ”¾å™¨èµ„æº

# ç¬¬äºŒé˜¶æ®µ: æ ¸å¿ƒç»„ä»¶å¼€å‘ (2-3å‘¨)  
1. è§†é¢‘æ’­æ”¾å™¨ç»„ä»¶
2. è®¾å¤‡ç®¡ç†ç»„ä»¶
3. äº‘å°æ§åˆ¶ç»„ä»¶
4. æµç›‘æ§ç»„ä»¶

# ç¬¬ä¸‰é˜¶æ®µ: é¡µé¢é›†æˆ (1-2å‘¨)
1. è®¾å¤‡ç®¡ç†é¡µé¢
2. å®æ—¶ç›‘æ§é¡µé¢  
3. å½•åƒå›æ”¾é¡µé¢
4. ç³»ç»Ÿé…ç½®é¡µé¢

# ç¬¬å››é˜¶æ®µ: ä¼˜åŒ–ä¸æµ‹è¯• (1å‘¨)
1. æ€§èƒ½ä¼˜åŒ–
2. å…¼å®¹æ€§æµ‹è¯•
3. ç”¨æˆ·ç•Œé¢ä¼˜åŒ–
```

#### 3.5.2 é£é™©æ§åˆ¶

```typescript
interface RiskMitigation {
  æŠ€æœ¯é£é™©: {
    "æ’­æ”¾å™¨å…¼å®¹æ€§": "æä¾›å¤šæ’­æ”¾å™¨é™çº§æ–¹æ¡ˆ",
    "Element Pluså‡çº§": "é”å®šç¨³å®šç‰ˆæœ¬ï¼Œå®šæœŸå‡çº§æµ‹è¯•",
    "Tailwindå­¦ä¹ æˆæœ¬": "æä¾›å›¢é˜ŸåŸ¹è®­å’Œæœ€ä½³å®è·µæ–‡æ¡£"
  }
  
  é¡¹ç›®é£é™©: {
    "å¼€å‘å‘¨æœŸ": "åˆ†é˜¶æ®µå®æ–½ï¼Œä¼˜å…ˆæ ¸å¿ƒåŠŸèƒ½",
    "åŠŸèƒ½å®Œæ•´æ€§": "åŸºäºè„šæ‰‹æ¶å·²æœ‰åŠŸèƒ½ï¼Œç¡®ä¿åŸºç¡€åŠŸèƒ½ç¨³å®š",
    "ç»´æŠ¤è´Ÿæ‹…": "å……åˆ†åˆ©ç”¨ç¤¾åŒºç”Ÿæ€ï¼Œå‡å°‘è‡ªå®šä¹‰ä»£ç "
  }
}
```

## 4. åŸæœ‰æ¶æ„ä¿ç•™ (ç»§ç»­ä½¿ç”¨ç°æœ‰è®¾è®¡)

### 4.1 ç›®å½•ç»“æ„ï¼ˆä¼˜åŒ–ç‰ˆï¼‰

```
web-frontend/
â”œâ”€â”€ public/                          # é™æ€èµ„æº
â”‚   â”œâ”€â”€ favicon.ico
â”‚   â”œâ”€â”€ index.html
â”‚   â”œâ”€â”€ players/                     # æ’­æ”¾å™¨èµ„æº
â”‚   â”‚   â”œâ”€â”€ jessibuca/              # Jessibucaæ’­æ”¾å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ jessibuca.js
â”‚   â”‚   â”‚   â””â”€â”€ decoder.wasm
â”‚   â”‚   â””â”€â”€ h265web/                # H265Web.jsæ’­æ”¾å™¨
â”‚   â”‚       â”œâ”€â”€ h265web.js
â”‚   â”‚       â””â”€â”€ h265web.wasm
â”‚   â””â”€â”€ config/                     # é…ç½®æ–‡ä»¶
â”‚       â””â”€â”€ app.config.js
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ api/                        # APIæ¥å£å±‚
â”‚   â”‚   â”œâ”€â”€ modules/               # æŒ‰æ¨¡å—åˆ†ç±»çš„API
â”‚   â”‚   â”‚   â”œâ”€â”€ device.ts          # è®¾å¤‡ç®¡ç†API
â”‚   â”‚   â”‚   â”œâ”€â”€ stream.ts          # æµåª’ä½“API
â”‚   â”‚   â”‚   â”œâ”€â”€ record.ts          # å½•åƒç›¸å…³API
â”‚   â”‚   â”‚   â”œâ”€â”€ user.ts            # ç”¨æˆ·ç®¡ç†API
â”‚   â”‚   â”‚   â””â”€â”€ system.ts          # ç³»ç»Ÿé…ç½®API
â”‚   â”‚   â”œâ”€â”€ types/                 # APIç±»å‹å®šä¹‰
â”‚   â”‚   â”‚   â”œâ”€â”€ device.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ stream.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ record.ts
â”‚   â”‚   â”‚   â””â”€â”€ common.ts
â”‚   â”‚   â”œâ”€â”€ request.ts             # å¢å¼ºHTTPå®¢æˆ·ç«¯(é‡è¯•+ç¼“å­˜)
â”‚   â”‚   â”œâ”€â”€ websocket.ts           # æ™ºèƒ½WebSocketå®¢æˆ·ç«¯(æ–­çº¿é‡è¿)
â”‚   â”‚   â”œâ”€â”€ errorHandler.ts        # ç»Ÿä¸€é”™è¯¯å¤„ç†ä¸­å¿ƒ
â”‚   â”‚   â”œâ”€â”€ interceptors.ts        # è¯·æ±‚/å“åº”æ‹¦æˆªå™¨
â”‚   â”‚   â””â”€â”€ index.ts               # APIç»Ÿä¸€å¯¼å‡º
â”‚   â”œâ”€â”€ assets/                    # èµ„æºæ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ images/               # å›¾ç‰‡èµ„æº
â”‚   â”‚   â”œâ”€â”€ icons/                # å›¾æ ‡èµ„æº
â”‚   â”‚   â””â”€â”€ styles/               # å…¨å±€æ ·å¼
â”‚   â”‚       â”œâ”€â”€ variables.scss    # SCSSå˜é‡
â”‚   â”‚       â”œâ”€â”€ mixins.scss       # SCSSæ··å…¥
â”‚   â”‚       â”œâ”€â”€ reset.scss        # æ ·å¼é‡ç½®
â”‚   â”‚       â””â”€â”€ global.scss       # å…¨å±€æ ·å¼
â”‚   â”œâ”€â”€ components/               # é€šç”¨ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ common/              # åŸºç¡€ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ AppHeader/       # é¡µé¢å¤´éƒ¨
â”‚   â”‚   â”‚   â”œâ”€â”€ AppSidebar/      # ä¾§è¾¹æ 
â”‚   â”‚   â”‚   â”œâ”€â”€ AppFooter/       # é¡µé¢åº•éƒ¨
â”‚   â”‚   â”‚   â”œâ”€â”€ Loading/         # åŠ è½½ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ Empty/           # ç©ºçŠ¶æ€ç»„ä»¶
â”‚   â”‚   â”‚   â””â”€â”€ Exception/       # å¼‚å¸¸ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ business/            # ä¸šåŠ¡ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ DeviceTree/      # è®¾å¤‡æ ‘ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ VideoPlayer/     # è§†é¢‘æ’­æ”¾å™¨ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ PTZControl/      # äº‘å°æ§åˆ¶ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ RecordPlayer/    # å½•åƒæ’­æ”¾ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ StreamList/      # æµåˆ—è¡¨ç»„ä»¶
â”‚   â”‚   â”‚   â””â”€â”€ DeviceStatus/    # è®¾å¤‡çŠ¶æ€ç»„ä»¶
â”‚   â”‚   â””â”€â”€ ui/                  # UIç»„ä»¶æ‰©å±•
â”‚   â”‚       â”œâ”€â”€ SmartTable/      # æ™ºèƒ½è¡¨æ ¼
â”‚   â”‚       â”œâ”€â”€ SmartForm/       # æ™ºèƒ½è¡¨å•
â”‚   â”‚       â””â”€â”€ SmartModal/      # æ™ºèƒ½å¼¹çª—
â”‚   â”œâ”€â”€ composables/             # ç»„åˆå¼API
â”‚   â”‚   â”œâ”€â”€ useWebSocket.ts      # å¢å¼ºWebSocketç®¡ç†(æ–­çº¿é‡è¿)
â”‚   â”‚   â”œâ”€â”€ usePlayer.ts         # æ’­æ”¾å™¨ç®¡ç†(é”™è¯¯æ¢å¤)
â”‚   â”‚   â”œâ”€â”€ useDevice.ts         # è®¾å¤‡æ“ä½œ(çŠ¶æ€åŒæ­¥)
â”‚   â”‚   â”œâ”€â”€ useStream.ts         # æµç®¡ç†(æ•…éšœè½¬ç§»)
â”‚   â”‚   â”œâ”€â”€ usePermission.ts     # æƒé™æ§åˆ¶
â”‚   â”‚   â”œâ”€â”€ useErrorHandler.ts   # ç»Ÿä¸€é”™è¯¯å¤„ç†
â”‚   â”‚   â”œâ”€â”€ useRetry.ts          # é‡è¯•æœºåˆ¶
â”‚   â”‚   â”œâ”€â”€ useOfflineCache.ts   # ç¦»çº¿ç¼“å­˜
â”‚   â”‚   â””â”€â”€ useTable.ts          # è¡¨æ ¼æ“ä½œ
â”‚   â”œâ”€â”€ layouts/                 # å¸ƒå±€ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ DefaultLayout.vue    # é»˜è®¤å¸ƒå±€
â”‚   â”‚   â”œâ”€â”€ BlankLayout.vue      # ç©ºç™½å¸ƒå±€
â”‚   â”‚   â””â”€â”€ PlayerLayout.vue     # æ’­æ”¾å™¨å¸ƒå±€
â”‚   â”œâ”€â”€ plugins/                 # æ’ä»¶
â”‚   â”‚   â”œâ”€â”€ antd.ts             # Ant Design Vueé…ç½®
â”‚   â”‚   â”œâ”€â”€ axios.ts            # Axiosé…ç½®
â”‚   â”‚   â””â”€â”€ players.ts          # æ’­æ”¾å™¨æ’ä»¶é…ç½®
â”‚   â”œâ”€â”€ router/                  # è·¯ç”±é…ç½®
â”‚   â”‚   â”œâ”€â”€ index.ts            # è·¯ç”±ä¸»æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ routes.ts           # è·¯ç”±é…ç½®
â”‚   â”‚   â””â”€â”€ guards.ts           # è·¯ç”±å®ˆå«
â”‚   â”œâ”€â”€ stores/                  # PiniaçŠ¶æ€ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ modules/            # æŒ‰æ¨¡å—åˆ†ç±»çš„store
â”‚   â”‚   â”‚   â”œâ”€â”€ user.ts         # ç”¨æˆ·çŠ¶æ€
â”‚   â”‚   â”‚   â”œâ”€â”€ device.ts       # è®¾å¤‡çŠ¶æ€
â”‚   â”‚   â”‚   â”œâ”€â”€ stream.ts       # æµçŠ¶æ€
â”‚   â”‚   â”‚   â”œâ”€â”€ record.ts       # å½•åƒçŠ¶æ€
â”‚   â”‚   â”‚   â””â”€â”€ system.ts       # ç³»ç»ŸçŠ¶æ€
â”‚   â”‚   â”œâ”€â”€ types/              # Storeç±»å‹å®šä¹‰
â”‚   â”‚   â””â”€â”€ index.ts            # Storeç»Ÿä¸€å¯¼å‡º
â”‚   â”œâ”€â”€ utils/                   # å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ common.ts           # é€šç”¨å·¥å…·
â”‚   â”‚   â”œâ”€â”€ format.ts           # æ ¼å¼åŒ–å·¥å…·
â”‚   â”‚   â”œâ”€â”€ validate.ts         # éªŒè¯å·¥å…·
â”‚   â”‚   â”œâ”€â”€ storage.ts          # å­˜å‚¨å·¥å…·
â”‚   â”‚   â”œâ”€â”€ date.ts             # æ—¥æœŸå·¥å…·
â”‚   â”‚   â””â”€â”€ device.ts           # è®¾å¤‡ç›¸å…³å·¥å…·
â”‚   â”œâ”€â”€ views/                   # é¡µé¢ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ login/              # ç™»å½•é¡µé¢
â”‚   â”‚   â”œâ”€â”€ dashboard/          # ä»ªè¡¨æ¿
â”‚   â”‚   â”œâ”€â”€ device/             # è®¾å¤‡ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ DeviceList.vue  # è®¾å¤‡åˆ—è¡¨
â”‚   â”‚   â”‚   â”œâ”€â”€ DeviceDetail.vue # è®¾å¤‡è¯¦æƒ…
â”‚   â”‚   â”‚   â””â”€â”€ ChannelList.vue # é€šé“åˆ—è¡¨
â”‚   â”‚   â”œâ”€â”€ monitor/            # å®æ—¶ç›‘æ§
â”‚   â”‚   â”‚   â”œâ”€â”€ LiveView.vue    # å®æ—¶é¢„è§ˆ
â”‚   â”‚   â”‚   â”œâ”€â”€ MultiView.vue   # å¤šç”»é¢
â”‚   â”‚   â”‚   â””â”€â”€ FullScreen.vue  # å…¨å±æ’­æ”¾
â”‚   â”‚   â”œâ”€â”€ playback/          # å½•åƒå›æ”¾
â”‚   â”‚   â”‚   â”œâ”€â”€ RecordList.vue  # å½•åƒåˆ—è¡¨
â”‚   â”‚   â”‚   â””â”€â”€ RecordPlay.vue  # å½•åƒæ’­æ”¾
â”‚   â”‚   â”œâ”€â”€ system/            # ç³»ç»Ÿç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ UserManage.vue  # ç”¨æˆ·ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ RoleManage.vue  # è§’è‰²ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ ConfigManage.vue # é…ç½®ç®¡ç†
â”‚   â”‚   â”‚   â””â”€â”€ LogManage.vue   # æ—¥å¿—ç®¡ç†
â”‚   â”‚   â””â”€â”€ exception/         # å¼‚å¸¸é¡µé¢
â”‚   â”‚       â”œâ”€â”€ 403.vue
â”‚   â”‚       â”œâ”€â”€ 404.vue
â”‚   â”‚       â””â”€â”€ 500.vue
â”‚   â”œâ”€â”€ App.vue                 # æ ¹ç»„ä»¶
â”‚   â”œâ”€â”€ main.ts                 # å…¥å£æ–‡ä»¶
â”‚   â””â”€â”€ vite-env.d.ts          # Viteç±»å‹å£°æ˜
â”œâ”€â”€ types/                      # å…¨å±€ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ global.d.ts            # å…¨å±€ç±»å‹
â”‚   â”œâ”€â”€ api.d.ts               # APIç±»å‹
â”‚   â””â”€â”€ components.d.ts        # ç»„ä»¶ç±»å‹
â”œâ”€â”€ docker/                     # Dockerç›¸å…³
â”‚   â”œâ”€â”€ Dockerfile             # Dockeræ„å»ºæ–‡ä»¶
â”‚   â””â”€â”€ nginx.conf             # Nginxé…ç½®
â”œâ”€â”€ .env.development           # å¼€å‘ç¯å¢ƒé…ç½®
â”œâ”€â”€ .env.production            # ç”Ÿäº§ç¯å¢ƒé…ç½®

## 3. å¢å¼ºçš„é”™è¯¯å¤„ç†ç³»ç»Ÿ

### 3.1 ç»Ÿä¸€é”™è¯¯å¤„ç†ä¸­å¿ƒ

```typescript
// api/errorHandler.ts - ç»Ÿä¸€é”™è¯¯å¤„ç†
interface ErrorContext {
  api: string;
  method: string; 
  params?: any;
  timestamp: number;
  userId?: string;
}

interface ErrorHandlerConfig {
  maxRetries: number;
  retryDelay: number;
  fallbackStrategy: 'cache' | 'mock' | 'offline';
  showNotification: boolean;
  logLevel: 'error' | 'warn' | 'info';
}

export class ErrorHandler {
  private config: ErrorHandlerConfig;
  private retryQueue: Map<string, number> = new Map();
  
  constructor(config: ErrorHandlerConfig) {
    this.config = config;
  }
  
  // ç»Ÿä¸€é”™è¯¯å¤„ç†å…¥å£
  async handle(error: Error, context: ErrorContext): Promise<any> {
    const errorKey = `${context.api}_${context.method}`;
    
    // 1. é”™è¯¯åˆ†ç±»å¤„ç†
    if (error instanceof NetworkError) {
      return this.handleNetworkError(error, context);
    }
    
    if (error instanceof ValidationError) {
      return this.handleValidationError(error, context);
    }
    
    if (error instanceof AuthenticationError) {
      return this.handleAuthError(error, context);
    }
    
    // 2. é‡è¯•æœºåˆ¶
    const retryCount = this.retryQueue.get(errorKey) || 0;
    if (retryCount < this.config.maxRetries) {
      return this.retryRequest(error, context, retryCount + 1);
    }
    
    // 3. é™çº§ç­–ç•¥
    return this.executeFallbackStrategy(error, context);
  }
  
  // ç½‘ç»œé”™è¯¯å¤„ç†
  private async handleNetworkError(error: NetworkError, context: ErrorContext) {
    // æ£€æŸ¥ç¦»çº¿çŠ¶æ€
    if (!navigator.onLine) {
      return this.handleOfflineMode(context);
    }
    
    // æœåŠ¡å™¨é”™è¯¯é‡è¯•
    if (error.status >= 500) {
      return this.scheduleRetry(context);
    }
    
    // æ˜¾ç¤ºç½‘ç»œé”™è¯¯æç¤º
    notification.error({
      message: 'ç½‘ç»œè¿æ¥å¼‚å¸¸',
      description: 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•',
      duration: 5
    });
    
    throw error;
  }
  
  // ç¦»çº¿æ¨¡å¼å¤„ç†
  private async handleOfflineMode(context: ErrorContext) {
    const cachedData = await OfflineCache.get(context.api);
    if (cachedData) {
      notification.warning({
        message: 'ç¦»çº¿æ¨¡å¼',
        description: 'å½“å‰æ˜¾ç¤ºç¼“å­˜æ•°æ®ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥',
      });
      return cachedData;
    }
    
    throw new Error('ç½‘ç»œä¸å¯ç”¨ä¸”æ— ç¼“å­˜æ•°æ®');
  }
}
```

### 3.2 æ™ºèƒ½WebSocketç®¡ç†

```typescript
// api/websocket.ts - æ™ºèƒ½WebSocketå®¢æˆ·ç«¯
interface WebSocketConfig {
  url: string;
  protocols?: string[];
  reconnectInterval: number;
  maxReconnectAttempts: number;
  heartbeatInterval: number;
  messageQueueSize: number;
}

interface QueuedMessage {
  id: string;
  data: any;
  timestamp: number;
  priority: 'high' | 'normal' | 'low';
}

export class SmartWebSocket {
  private ws: WebSocket | null = null;
  private config: WebSocketConfig;
  private reconnectCount = 0;
  private isConnecting = false;
  private messageQueue: QueuedMessage[] = [];
  private heartbeatTimer?: number;
  private reconnectTimer?: number;
  
  // äº‹ä»¶ç›‘å¬å™¨
  private listeners: Map<string, Function[]> = new Map();
  
  constructor(config: WebSocketConfig) {
    this.config = config;
    this.connect();
    
    // ç›‘å¬ç½‘ç»œçŠ¶æ€å˜åŒ–
    window.addEventListener('online', () => this.handleOnline());
    window.addEventListener('offline', () => this.handleOffline());
  }
  
  // å»ºç«‹è¿æ¥
  private async connect(): Promise<void> {
    if (this.isConnecting) return;
    
    this.isConnecting = true;
    
    try {
      this.ws = new WebSocket(this.config.url, this.config.protocols);
      
      this.ws.onopen = (event) => this.handleOpen(event);
      this.ws.onmessage = (event) => this.handleMessage(event);
      this.ws.onclose = (event) => this.handleClose(event);
      this.ws.onerror = (event) => this.handleError(event);
      
    } catch (error) {
      console.error('WebSocketè¿æ¥å¤±è´¥:', error);
      this.scheduleReconnect();
    } finally {
      this.isConnecting = false;
    }
  }
  
  // è¿æ¥æˆåŠŸå¤„ç†
  private handleOpen(event: Event): void {
    console.log('WebSocketè¿æ¥å·²å»ºç«‹');
    this.reconnectCount = 0;
    
    // å‘é€é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯
    this.flushMessageQueue();
    
    // å¯åŠ¨å¿ƒè·³
    this.startHeartbeat();
    
    // è§¦å‘è¿æ¥æˆåŠŸäº‹ä»¶
    this.emit('connected', event);
  }
  
  // å®‰æ’é‡è¿
  private scheduleReconnect(): void {
    if (this.reconnectCount >= this.config.maxReconnectAttempts) {
      console.error('WebSocketé‡è¿æ¬¡æ•°è¶…è¿‡é™åˆ¶');
      this.emit('reconnectFailed');
      return;
    }
    
    const delay = Math.min(1000 * Math.pow(2, this.reconnectCount), 30000);
    this.reconnectCount++;
    
    console.log(`WebSocketå°†åœ¨${delay}msåé‡è¿ (ç¬¬${this.reconnectCount}æ¬¡)`);
    
    this.reconnectTimer = window.setTimeout(() => {
      this.connect();
    }, delay);
  }
  
  // å‘é€æ¶ˆæ¯
  send(data: any, priority: 'high' | 'normal' | 'low' = 'normal'): void {
    const message: QueuedMessage = {
      id: Date.now().toString(),
      data,
      timestamp: Date.now(),
      priority
    };
    
    if (this.isConnected()) {
      this.sendMessage(message);
    } else {
      this.queueMessage(message);
    }
  }
  
  // å·¥å…·æ–¹æ³•
  private isConnected(): boolean {
    return this.ws?.readyState === WebSocket.OPEN;
  }
  
  // é”€æ¯è¿æ¥
  destroy(): void {
    if (this.reconnectTimer) {
      clearTimeout(this.reconnectTimer);
    }
    
    if (this.ws) {
      this.ws.close(1000, 'å®¢æˆ·ç«¯ä¸»åŠ¨å…³é—­');
    }
    
    this.listeners.clear();
    this.messageQueue = [];
  }
}
```

### 3.3 å¢å¼ºçš„Composableså®ç°

```typescript
// composables/useErrorHandler.ts - é”™è¯¯å¤„ç†ç»„åˆå¼API
export function useErrorHandler() {
  const errorHandler = new ErrorHandler({
    maxRetries: 3,
    retryDelay: 1000,
    fallbackStrategy: 'cache',
    showNotification: true,
    logLevel: 'error'
  });
  
  // åŒ…è£…APIè°ƒç”¨
  const withErrorHandling = async <T>(
    apiCall: () => Promise<T>,
    context: Partial<ErrorContext>
  ): Promise<T> => {
    try {
      return await apiCall();
    } catch (error) {
      return await errorHandler.handle(error as Error, {
        api: context.api || 'unknown',
        method: context.method || 'unknown',
        params: context.params,
        timestamp: Date.now()
      });
    }
  };
  
  return {
    withErrorHandling,
    errorHandler
  };
}

// composables/useWebSocket.ts - WebSocketç»„åˆå¼API
export function useWebSocket() {
  const ws = ref<SmartWebSocket | null>(null);
  const isConnected = ref(false);
  const connectionStatus = ref<'connecting' | 'connected' | 'disconnected' | 'error'>('disconnected');
  
  // åˆå§‹åŒ–WebSocketè¿æ¥
  const connect = (url: string, options?: Partial<WebSocketConfig>) => {
    const config: WebSocketConfig = {
      url,
      reconnectInterval: 5000,
      maxReconnectAttempts: 5,
      heartbeatInterval: 30000,
      messageQueueSize: 100,
      ...options
    };
    
    ws.value = new SmartWebSocket(config);
    
    // ç›‘å¬è¿æ¥çŠ¶æ€å˜åŒ–
    ws.value.on('connected', () => {
      isConnected.value = true;
      connectionStatus.value = 'connected';
    });
    
    ws.value.on('disconnected', () => {
      isConnected.value = false;
      connectionStatus.value = 'disconnected';
    });
    
    ws.value.on('error', () => {
      connectionStatus.value = 'error';
    });
  };
  
  // å‘é€æ¶ˆæ¯
  const send = (data: any, priority?: 'high' | 'normal' | 'low') => {
    ws.value?.send(data, priority);
  };
  
  // ç›‘å¬æ¶ˆæ¯
  const on = (event: string, callback: Function) => {
    ws.value?.on(event, callback);
  };
  
  // ç»„ä»¶å¸è½½æ—¶æ¸…ç†
  onUnmounted(() => {
    ws.value?.destroy();
  });
  
  return {
    ws,
    isConnected: readonly(isConnected),
    connectionStatus: readonly(connectionStatus),
    connect,
    send,
    on
  };
}
```
â”œâ”€â”€ vite.config.ts             # Viteé…ç½®
â”œâ”€â”€ tsconfig.json              # TypeScripté…ç½®
â”œâ”€â”€ package.json               # é¡¹ç›®é…ç½®
â””â”€â”€ README.md                  # é¡¹ç›®è¯´æ˜
```

### 2.2 æ¨¡å—æ¶æ„è®¾è®¡

typescript

```
// src/types/global.d.ts - å…¨å±€ç±»å‹å®šä¹‰
declare global {
  interface Window {
    APP_CONFIG: {
      apiBaseUrl: string;
      wsBaseUrl: string;
      title: string;
      version: string;
    };
    // æ’­æ”¾å™¨å…¨å±€å˜é‡
    Jessibuca: any;
    H265webjs: any;
  }
}

// è®¾å¤‡ç›¸å…³ç±»å‹
export interface Device {
  id: string;
  deviceId: string;
  name: string;
  deviceType: 'IPC' | 'NVR' | 'DVR';
  ip: string;
  port: number;
  status: 'online' | 'offline';
  manufacturer: string;
  model: string;
  firmware: string;
  channels?: DeviceChannel[];
  createTime: string;
  updateTime: string;
}

export interface DeviceChannel {
  id: string;
  deviceId: string;
  channelId: string;
  name: string;
  status: 'on' | 'off';
  ptzType: number;
  h265Enabled: boolean;
  streamProfile?: StreamProfile;
}

// æµåª’ä½“ç›¸å…³ç±»å‹
export interface StreamProfile {
  streamId: string;
  codec: 'h264' | 'h265';
  resolution: string;
  frameRate: number;
  bitRate: number;
  urls: {
    rtsp: string;
    rtmp: string;
    flv: string;
    hls: string;
    wsflv: string;
  };
}

// WebSocketæ¶ˆæ¯ç±»å‹
export interface WSMessage {
  type: 'device-online' | 'device-offline' | 'stream-start' | 'stream-stop' | 'ptz-status' | 'record-status';
  data: any;
  timestamp: number;
}
```

## 3. æ ¸å¿ƒåŠŸèƒ½æ¨¡å—è®¾è®¡

###

```
æ ¸å¿ƒåŠŸèƒ½æ¨¡å—è®¾è®¡ï¼šè®¾å¤‡ç®¡ç†ã€è§†é¢‘æ’­æ”¾ã€äº‘å°æ§åˆ¶ã€å½•åƒå›æ”¾ã€ç”¨æˆ·æƒé™
```

### 3.1 è®¾å¤‡ç®¡ç†æ¨¡å—

#### 3.1.1 è®¾å¤‡æ ‘ç»„ä»¶

```
<!-- src/components/business/DeviceTree/index.vue -->
<template>
  <div class="device-tree">
    <a-input-search
      v-model:value="searchValue"
      placeholder="æœç´¢è®¾å¤‡..."
      allow-clear
      @search="handleSearch"
      class="search-input"
    />
  
    <a-tree
      v-model:selectedKeys="selectedKeys"
      v-model:expandedKeys="expandedKeys"
      :tree-data="treeData"
      :field-names="fieldNames"
      :show-icon="true"
      :show-line="true"
      @select="handleSelect"
      @expand="handleExpand"
    >
      <template #icon="{ dataRef }">
        <component :is="getDeviceIcon(dataRef)" />
      </template>
  
      <template #title="{ dataRef }">
        <div class="tree-node-title">
          <span>{{ dataRef.name }}</span>
          <div class="node-status">
            <a-badge :status="getStatusBadge(dataRef.status)" />
            <span class="status-text">{{ getStatusText(dataRef.status) }}</span>
          </div>
        </div>
      </template>
    </a-tree>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, watch, onMounted } from 'vue'
import { useDeviceStore } from '@/stores/modules/device'
import { useWebSocket } from '@/composables/useWebSocket'
import type { Device, DeviceChannel } from '@/types/global'

const deviceStore = useDeviceStore()
const { subscribe } = useWebSocket()

const searchValue = ref('')
const selectedKeys = ref<string[]>([])
const expandedKeys = ref<string[]>([])

const fieldNames = {
  children: 'children',
  title: 'name',
  key: 'key'
}

// è®¾å¤‡æ ‘æ•°æ®è½¬æ¢
const treeData = computed(() => {
  return deviceStore.devices
    .filter(device => 
      searchValue.value === '' || 
      device.name.toLowerCase().includes(searchValue.value.toLowerCase())
    )
    .map(device => ({
      key: `device-${device.id}`,
      name: device.name,
      type: 'device',
      status: device.status,
      deviceType: device.deviceType,
      data: device,
      children: device.channels?.map(channel => ({
        key: `channel-${device.id}-${channel.channelId}`,
        name: channel.name || `é€šé“${channel.channelId}`,
        type: 'channel',
        status: channel.status,
        data: channel,
        parent: device
      })) || []
    }))
})

// è·å–è®¾å¤‡å›¾æ ‡
const getDeviceIcon = (node: any) => {
  if (node.type === 'device') {
    switch (node.deviceType) {
      case 'IPC': return 'CameraOutlined'
      case 'NVR': return 'VideoCameraOutlined'
      case 'DVR': return 'DesktopOutlined'
      default: return 'QuestionCircleOutlined'
    }
  } else {
    return 'PlayCircleOutlined' // é€šé“å›¾æ ‡
  }
}

// è·å–çŠ¶æ€å¾½ç« 
const getStatusBadge = (status: string) => {
  const statusMap = {
    'online': 'success',
    'offline': 'error',
    'on': 'success',
    'off': 'default'
  }
  return statusMap[status] || 'default'
}

// å¤„ç†èŠ‚ç‚¹é€‰æ‹©
const handleSelect = (keys: string[], info: any) => {
  const node = info.node.dataRef
  if (node.type === 'channel') {
    // é€‰æ‹©é€šé“æ—¶ï¼Œè§¦å‘æ’­æ”¾
    emit('channel-select', {
      device: node.parent,
      channel: node.data
    })
  }
}

// WebSocketäº‹ä»¶ç›‘å¬
onMounted(() => {
  // ç›‘å¬è®¾å¤‡çŠ¶æ€å˜åŒ–
  subscribe('device-online', (data) => {
    deviceStore.updateDeviceStatus(data.deviceId, 'online')
  })
  
  subscribe('device-offline', (data) => {
    deviceStore.updateDeviceStatus(data.deviceId, 'offline')
  })
  
  // åŠ è½½è®¾å¤‡åˆ—è¡¨
  deviceStore.loadDevices()
})

const emit = defineEmits<{
  'channel-select': [{ device: Device; channel: DeviceChannel }]
}>()
</script>
```

#### 3.1.2 è®¾å¤‡åˆ—è¡¨é¡µé¢

vue

```
<!-- src/views/device/DeviceList.vue -->
<template>
  <div class="device-list-page">
    <div class="page-header">
      <h1>è®¾å¤‡ç®¡ç†</h1>
      <div class="header-actions">
        <a-button type="primary" @click="handleAdd">
          <template #icon><PlusOutlined /></template>
          æ·»åŠ è®¾å¤‡
        </a-button>
        <a-button @click="handleRefresh">
          <template #icon><ReloadOutlined /></template>
          åˆ·æ–°
        </a-button>
      </div>
    </div>
  
    <div class="search-form">
      <a-form layout="inline" :model="searchForm">
        <a-form-item label="è®¾å¤‡åç§°">
          <a-input 
            v-model:value="searchForm.name" 
            placeholder="è¯·è¾“å…¥è®¾å¤‡åç§°"
            allow-clear
          />
        </a-form-item>
        <a-form-item label="è®¾å¤‡ç±»å‹">
          <a-select 
            v-model:value="searchForm.deviceType" 
            placeholder="è¯·é€‰æ‹©è®¾å¤‡ç±»å‹"
            allow-clear
          >
            <a-select-option value="IPC">ç½‘ç»œæ‘„åƒæœº</a-select-option>
            <a-select-option value="NVR">ç½‘ç»œå½•åƒæœº</a-select-option>
            <a-select-option value="DVR">ç¡¬ç›˜å½•åƒæœº</a-select-option>
          </a-select>
        </a-form-item>
        <a-form-item label="çŠ¶æ€">
          <a-select 
            v-model:value="searchForm.status" 
            placeholder="è¯·é€‰æ‹©çŠ¶æ€"
            allow-clear
          >
            <a-select-option value="online">åœ¨çº¿</a-select-option>
            <a-select-option value="offline">ç¦»çº¿</a-select-option>
          </a-select>
        </a-form-item>
        <a-form-item>
          <a-button type="primary" @click="handleSearch">æœç´¢</a-button>
          <a-button @click="handleReset">é‡ç½®</a-button>
        </a-form-item>
      </a-form>
    </div>
  
    <a-table
      :columns="columns"
      :data-source="deviceStore.devices"
      :loading="loading"
      :pagination="pagination"
      row-key="id"
      @change="handleTableChange"
    >
      <template #bodyCell="{ column, record }">
        <template v-if="column.key === 'status'">
          <a-badge 
            :status="record.status === 'online' ? 'success' : 'error'"
            :text="record.status === 'online' ? 'åœ¨çº¿' : 'ç¦»çº¿'"
          />
        </template>
  
        <template v-if="column.key === 'actions'">
          <a-space>
            <a-button size="small" @click="handleView(record)">æŸ¥çœ‹</a-button>
            <a-button size="small" @click="handleEdit(record)">ç¼–è¾‘</a-button>
            <a-button size="small" @click="handleChannels(record)">é€šé“</a-button>
            <a-popconfirm
              title="ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè®¾å¤‡å—ï¼Ÿ"
              @confirm="handleDelete(record)"
            >
              <a-button size="small" danger>åˆ é™¤</a-button>
            </a-popconfirm>
          </a-space>
        </template>
      </template>
    </a-table>
  
    <!-- è®¾å¤‡ç¼–è¾‘å¼¹çª— -->
    <DeviceModal
      v-model:visible="modalVisible"
      :device="currentDevice"
      @submit="handleModalSubmit"
    />
  </div>
</template>

<script setup lang="ts">
import { ref, reactive, onMounted } from 'vue'
import { useDeviceStore } from '@/stores/modules/device'
import { useTable } from '@/composables/useTable'
import DeviceModal from './components/DeviceModal.vue'
import type { Device } from '@/types/global'

const deviceStore = useDeviceStore()
const { loading, pagination, handleTableChange } = useTable()

const searchForm = reactive({
  name: '',
  deviceType: undefined,
  status: undefined
})

const modalVisible = ref(false)
const currentDevice = ref<Device | null>(null)

// è¡¨æ ¼åˆ—å®šä¹‰
const columns = [
  {
    title: 'è®¾å¤‡åç§°',
    dataIndex: 'name',
    key: 'name',
    sorter: true
  },
  {
    title: 'è®¾å¤‡ID',
    dataIndex: 'deviceId',
    key: 'deviceId'
  },
  {
    title: 'è®¾å¤‡ç±»å‹',
    dataIndex: 'deviceType',
    key: 'deviceType',
    customRender: ({ text }) => {
      const typeMap = {
        'IPC': 'ç½‘ç»œæ‘„åƒæœº',
        'NVR': 'ç½‘ç»œå½•åƒæœº',
        'DVR': 'ç¡¬ç›˜å½•åƒæœº'
      }
      return typeMap[text] || text
    }
  },
  {
    title: 'IPåœ°å€',
    dataIndex: 'ip',
    key: 'ip'
  },
  {
    title: 'ç«¯å£',
    dataIndex: 'port',
    key: 'port'
  },
  {
    title: 'çŠ¶æ€',
    key: 'status'
  },
  {
    title: 'é€šé“æ•°',
    key: 'channelCount',
    customRender: ({ record }) => record.channels?.length || 0
  },
  {
    title: 'åˆ›å»ºæ—¶é—´',
    dataIndex: 'createTime',
    key: 'createTime',
    sorter: true
  },
  {
    title: 'æ“ä½œ',
    key: 'actions',
    width: 200
  }
]

// äº‹ä»¶å¤„ç†
const handleAdd = () => {
  currentDevice.value = null
  modalVisible.value = true
}

const handleEdit = (record: Device) => {
  currentDevice.value = record
  modalVisible.value = true
}

const handleView = (record: Device) => {
  // è·³è½¬åˆ°è®¾å¤‡è¯¦æƒ…é¡µ
  router.push(`/device/detail/${record.id}`)
}

const handleChannels = (record: Device) => {
  // è·³è½¬åˆ°é€šé“ç®¡ç†é¡µ
  router.push(`/device/channels/${record.id}`)
}

const handleDelete = async (record: Device) => {
  await deviceStore.deleteDevice(record.id)
  handleRefresh()
}

const handleRefresh = () => {
  deviceStore.loadDevices()
}

const handleSearch = () => {
  deviceStore.searchDevices(searchForm)
}

const handleReset = () => {
  Object.assign(searchForm, {
    name: '',
    deviceType: undefined,
    status: undefined
  })
  handleSearch()
}

const handleModalSubmit = async (device: Device) => {
  if (currentDevice.value) {
    await deviceStore.updateDevice(device.id, device)
  } else {
    await deviceStore.createDevice(device)
  }
  modalVisible.value = false
  handleRefresh()
}

onMounted(() => {
  handleRefresh()
})
</script>
```

### 3.2 è§†é¢‘æ’­æ”¾æ¨¡å—

#### 3.2.1 æ™ºèƒ½æ’­æ”¾å™¨ç»„ä»¶

```
<!-- src/components/business/VideoPlayer/index.vue -->
<template>
  <div class="video-player-container" :class="playerClass">
    <div class="player-wrapper" ref="playerRef">
      <!-- Jessibucaæ’­æ”¾å™¨ -->
      <div 
        v-if="currentPlayerType === 'jessibuca'" 
        :id="playerId" 
        class="jessibuca-player"
      ></div>
  
      <!-- H265Web.jsæ’­æ”¾å™¨ -->
      <div 
        v-if="currentPlayerType === 'h265web'" 
        class="h265web-player"
      >
        <canvas :id="canvasId" ref="canvasRef"></canvas>
      </div>
  
      <!-- æ’­æ”¾å™¨æ§åˆ¶æ  -->
      <div class="player-controls" v-show="showControls">
        <div class="controls-left">
          <a-button 
            :type="isPlaying ? 'default' : 'primary'" 
            @click="togglePlay"
            size="small"
          >
            <template #icon>
              <PauseOutlined v-if="isPlaying" />
              <PlayCircleOutlined v-else />
            </template>
            {{ isPlaying ? 'æš‚åœ' : 'æ’­æ”¾' }}
          </a-button>
    
          <a-button @click="handleStop" size="small">
            <template #icon><StopOutlined /></template>
            åœæ­¢
          </a-button>
    
          <a-button @click="handleSnapshot" size="small">
            <template #icon><CameraOutlined /></template>
            æˆªå›¾
          </a-button>
    
          <a-button @click="toggleRecord" size="small">
            <template #icon><VideoCameraOutlined /></template>
            {{ isRecording ? 'åœæ­¢å½•åƒ' : 'å¼€å§‹å½•åƒ' }}
          </a-button>
        </div>
  
        <div class="controls-center">
          <span class="stream-info">
            {{ streamInfo?.resolution }} | {{ streamInfo?.codec?.toUpperCase() }} | {{ streamInfo?.frameRate }}fps
          </span>
        </div>
  
        <div class="controls-right">
          <a-select 
            v-model:value="currentStreamType" 
            size="small" 
            @change="handleStreamChange"
            style="width: 100px"
          >
            <a-select-option value="main">ä¸»ç æµ</a-select-option>
            <a-select-option value="sub">å­ç æµ</a-select-option>
          </a-select>
    
          <a-button @click="toggleFullscreen" size="small">
            <template #icon>
              <FullscreenExitOutlined v-if="isFullscreen" />
              <FullscreenOutlined v-else />
            </template>
          </a-button>
        </div>
      </div>
  
      <!-- åŠ è½½çŠ¶æ€ -->
      <div v-show="loading" class="player-loading">
        <a-spin size="large" />
        <p>æ­£åœ¨åŠ è½½è§†é¢‘æµ...</p>
      </div>
  
      <!-- é”™è¯¯çŠ¶æ€ -->
      <div v-show="error" class="player-error">
        <ExclamationCircleOutlined class="error-icon" />
        <p>{{ error }}</p>
        <a-button @click="handleReplay">é‡æ–°æ’­æ”¾</a-button>
      </div>
    </div>
  
    <!-- äº‘å°æ§åˆ¶é¢æ¿ -->
    <PTZControl 
      v-if="showPTZ && ptzEnabled" 
      :device-id="deviceId" 
      :channel-id="channelId"
      @command="handlePTZCommand"
    />
  </div>
</template>

<script setup lang="ts">
import { ref, computed, watch, onMounted, onUnmounted, nextTick } from 'vue'
import { usePlayer } from '@/composables/usePlayer'
import { useStreamStore } from '@/stores/modules/stream'
import { message } from 'ant-design-vue'
import PTZControl from '../PTZControl/index.vue'
import type { StreamProfile, PTZCommand } from '@/types/global'

interface Props {
  deviceId: string
  channelId: string
  streamType?: 'main' | 'sub'
  showControls?: boolean
  showPTZ?: boolean
  autoPlay?: boolean
  width?: string | number
  height?: string | number
}

const props = withDefaults(defineProps<Props>(), {
  streamType: 'main',
  showControls: true,
  showPTZ: false,
  autoPlay: true,
  width: '100%',
  height: '100%'
})

const streamStore = useStreamStore()

// æ’­æ”¾å™¨å®ä¾‹ç®¡ç†
const {
  playerId,
  canvasId,
  playerRef,
  canvasRef,
  currentPlayerType,
  isPlaying,
  isRecording,
  isFullscreen,
  loading,
  error,
  initPlayer,
  startPlay,
  stopPlay,
  togglePlay,
  toggleRecord,
  toggleFullscreen,
  destroy
} = usePlayer()

const currentStreamType = ref(props.streamType)
const showControls = ref(props.showControls)
const streamInfo = ref<StreamProfile | null>(null)

// è®¡ç®—å±æ€§
const playerClass = computed(() => ({
  'player-playing': isPlaying.value,
  'player-fullscreen': isFullscreen.value,
  'player-loading': loading.value,
  'player-error': !!error.value
}))

const ptzEnabled = computed(() => {
  return streamStore.getChannelPTZStatus(props.deviceId, props.channelId)
})

// ç›‘å¬å±æ€§å˜åŒ–
watch([() => props.deviceId, () => props.channelId, currentStreamType], async () => {
  if (props.deviceId && props.channelId) {
    await loadStream()
  }
}, { immediate: true })

// åŠ è½½æµä¿¡æ¯
const loadStream = async () => {
  try {
    loading.value = true
    error.value = ''
  
    // è·å–æµä¿¡æ¯
    streamInfo.value = await streamStore.getStreamProfile(
      props.deviceId, 
      props.channelId, 
      currentStreamType.value
    )
  
    if (!streamInfo.value) {
      throw new Error('æ— æ³•è·å–æµä¿¡æ¯')
    }
  
    // æ ¹æ®ç¼–è§£ç æ ¼å¼é€‰æ‹©æ’­æ”¾å™¨
    const playerType = streamInfo.value.codec === 'h265' ? 'h265web' : 'jessibuca'
  
    // åˆå§‹åŒ–æ’­æ”¾å™¨
    await initPlayer(playerType)
  
    // å¼€å§‹æ’­æ”¾
    if (props.autoPlay) {
      const streamUrl = getStreamUrl(streamInfo.value, playerType)
      await startPlay(streamUrl)
    }
  
  } catch (err) {
    error.value = err.message || 'æ’­æ”¾å¤±è´¥'
    message.error(error.value)
  } finally {
    loading.value = false
  }
}

// è·å–æµåœ°å€
const getStreamUrl = (stream: StreamProfile, playerType: string) => {
  if (playerType === 'h265web') {
    return stream.urls.hls // H265ä½¿ç”¨HLS
  } else {
    return stream.urls.wsflv // H264ä½¿ç”¨WebSocket-FLV
  }
}

// äº‹ä»¶å¤„ç†
const handleStop = async () => {
  await stopPlay()
  streamStore.stopStream(props.deviceId, props.channelId)
}

const handleSnapshot = async () => {
  try {
    const imageData = await captureSnapshot()
    downloadImage(imageData, `snapshot_${props.deviceId}_${props.channelId}_${Date.now()}.jpg`)
    message.success('æˆªå›¾æˆåŠŸ')
  } catch (err) {
    message.error('æˆªå›¾å¤±è´¥')
  }
}

const handleStreamChange = async (type: 'main' | 'sub') => {
  currentStreamType.value = type
  await loadStream()
}

const handleReplay = () => {
  loadStream()
}

const handlePTZCommand = (command: PTZCommand) => {
  streamStore.sendPTZCommand(props.deviceId, props.channelId, command)
}

// æˆªå›¾åŠŸèƒ½
const captureSnapshot = async (): Promise<string> => {
  if (currentPlayerType.value === 'jessibuca') {
    // Jessibucaæˆªå›¾
    return new Promise((resolve, reject) => {
      const player = window[`jessibuca_${playerId.value}`]
      if (player && player.screenshot) {
        player.screenshot('image/jpeg', '', 'base64', (base64) => {
          resolve(base64)
        })
      } else {
        reject(new Error('æ’­æ”¾å™¨ä¸æ”¯æŒæˆªå›¾'))
      }
    })
  } else if (currentPlayerType.value === 'h265web') {
    // H265Web.jsæˆªå›¾
    const canvas = canvasRef.value
    if (canvas) {
      return canvas.toDataURL('image/jpeg')
    } else {
      throw new Error('æ— æ³•è·å–ç”»å¸ƒ')
    }
  }
  throw new Error('æœªçŸ¥æ’­æ”¾å™¨ç±»å‹')
}

// ä¸‹è½½å›¾ç‰‡
const downloadImage = (dataUrl: string, filename: string) => {
  const link = document.createElement('a')
  link.download = filename
  link.href = dataUrl
  link.click()
}

// ç”Ÿå‘½å‘¨æœŸ
onMounted(() => {
  if (props.deviceId && props.channelId) {
    loadStream()
  }
})

onUnmounted(() => {
  destroy()
})

// æš´éœ²æ–¹æ³•ç»™çˆ¶ç»„ä»¶
defineExpose({
  startPlay: loadStream,
  stopPlay: handleStop,
  togglePlay,
  snapshot: handleSnapshot,
  switchStream: handleStreamChange
})
</script>

<style lang="scss" scoped>
.video-player-container {
  position: relative;
  width: 100%;
  height: 100%;
  background: #000;
  border-radius: 4px;
  overflow: hidden;

  .player-wrapper {
    position: relative;
    width: 100%;
    height: 100%;

    .jessibuca-player,
    .h265web-player {
      width: 100%;
      height: 100%;
    }

    .h265web-player canvas {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
  }

  .player-controls {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    background: linear-gradient(transparent, rgba(0, 0, 0, 0.7));
    color: white;
    opacity: 0;
    transition: opacity 0.3s;

    .controls-left,
    .controls-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .controls-center {
      flex: 1;
      text-align: center;

      .stream-info {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.8);
      }
    }
  }

  &:hover .player-controls {
    opacity: 1;
  }

  .player-loading,
  .player-error {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    color: white;

    .error-icon {
      font-size: 48px;
      color: #ff4d4f;
      margin-bottom: 16px;
    }

    p {
      margin: 16px 0;
      font-size: 14px;
    }
  }

  &.player-fullscreen {
    position: fixed !important;
    top: 0;
    left: 0;
    width: 100vw !important;
    height: 100vh !important;
    z-index: 9999;
  }
}
</style>
```

## 4. çŠ¶æ€ç®¡ç†è®¾è®¡ (Pinia Store)

çŠ¶æ€ç®¡ç†è®¾è®¡ï¼šPinia Store ç»“æ„ã€æ•°æ®æµã€ç¼“å­˜ç­–ç•¥

### 4.1 Store æ¶æ„è®¾è®¡

#### 4.1.1 ç”¨æˆ·çŠ¶æ€ç®¡ç†

```
// src/stores/modules/user.ts
import { defineStore } from 'pinia'
import { ref, computed } from 'vue'
import { userAPI } from '@/api/modules/user'
import { storage } from '@/utils/storage'
import type { User, LoginForm, UserPermission } from '@/types/global'

export const useUserStore = defineStore('user', () => {
  // çŠ¶æ€
  const user = ref<User | null>(null)
  const token = ref<string>('')
  const permissions = ref<UserPermission[]>([])
  const roles = ref<string[]>([])
  const isLoggedIn = ref(false)

  // è®¡ç®—å±æ€§
  const userInfo = computed(() => user.value)
  const hasPermission = computed(() => (permission: string) => {
    return permissions.value.some(p => p.code === permission)
  })
  const hasRole = computed(() => (role: string) => {
    return roles.value.includes(role)
  })

  // Actions
  const login = async (loginForm: LoginForm) => {
    try {
      const response = await userAPI.login(loginForm)
      const { token: authToken, user: userData } = response.data
  
      // ä¿å­˜tokenå’Œç”¨æˆ·ä¿¡æ¯
      token.value = authToken
      user.value = userData
      isLoggedIn.value = true
  
      // æŒä¹…åŒ–å­˜å‚¨
      storage.setToken(authToken)
      storage.setUserInfo(userData)
  
      // è·å–ç”¨æˆ·æƒé™
      await getUserPermissions()
  
      return response
    } catch (error) {
      throw error
    }
  }

  const logout = async () => {
    try {
      await userAPI.logout()
    } catch (error) {
      console.error('Logout API failed:', error)
    } finally {
      // æ¸…é™¤çŠ¶æ€
      user.value = null
      token.value = ''
      permissions.value = []
      roles.value = []
      isLoggedIn.value = false
  
      // æ¸…é™¤å­˜å‚¨
      storage.clearAuth()
    }
  }

  const getUserPermissions = async () => {
    try {
      const response = await userAPI.getPermissions()
      permissions.value = response.data.permissions
      roles.value = response.data.roles
    } catch (error) {
      console.error('Get permissions failed:', error)
    }
  }

  const updateUserInfo = async (userInfo: Partial<User>) => {
    try {
      const response = await userAPI.updateProfile(userInfo)
      user.value = { ...user.value, ...response.data }
      storage.setUserInfo(user.value)
      return response
    } catch (error) {
      throw error
    }
  }

  const initializeAuth = () => {
    const savedToken = storage.getToken()
    const savedUser = storage.getUserInfo()
  
    if (savedToken && savedUser) {
      token.value = savedToken
      user.value = savedUser
      isLoggedIn.value = true
      getUserPermissions()
    }
  }

  return {
    // çŠ¶æ€
    user,
    token,
    permissions,
    roles,
    isLoggedIn,
    // è®¡ç®—å±æ€§
    userInfo,
    hasPermission,
    hasRole,
    // Actions
    login,
    logout,
    getUserPermissions,
    updateUserInfo,
    initializeAuth
  }
})
```

#### 4.1.2 è®¾å¤‡çŠ¶æ€ç®¡ç†

```
// src/stores/modules/device.ts
import { defineStore } from 'pinia'
import { ref, computed } from 'vue'
import { deviceAPI } from '@/api/modules/device'
import { useWebSocket } from '@/composables/useWebSocket'
import type { Device, DeviceChannel, DeviceFilter } from '@/types/global'

export const useDeviceStore = defineStore('device', () => {
  // çŠ¶æ€
  const devices = ref<Device[]>([])
  const selectedDevice = ref<Device | null>(null)
  const selectedChannel = ref<DeviceChannel | null>(null)
  const loading = ref(false)
  const filter = ref<DeviceFilter>({
    name: '',
    deviceType: '',
    status: '',
    page: 1,
    pageSize: 20
  })

  // ç¼“å­˜æ˜ å°„
  const deviceMap = ref(new Map<string, Device>())
  const channelMap = ref(new Map<string, DeviceChannel>())

  // è®¡ç®—å±æ€§
  const onlineDevices = computed(() => 
    devices.value.filter(device => device.status === 'online')
  )
  
  const offlineDevices = computed(() => 
    devices.value.filter(device => device.status === 'offline')
  )
  
  const deviceStats = computed(() => ({
    total: devices.value.length,
    online: onlineDevices.value.length,
    offline: offlineDevices.value.length,
    channels: devices.value.reduce((sum, device) => sum + (device.channels?.length || 0), 0)
  }))

  const filteredDevices = computed(() => {
    let result = devices.value
  
    if (filter.value.name) {
      result = result.filter(device => 
        device.name.toLowerCase().includes(filter.value.name.toLowerCase())
      )
    }
  
    if (filter.value.deviceType) {
      result = result.filter(device => device.deviceType === filter.value.deviceType)
    }
  
    if (filter.value.status) {
      result = result.filter(device => device.status === filter.value.status)
    }
  
    return result
  })

  // Actions
  const loadDevices = async (params?: Partial<DeviceFilter>) => {
    try {
      loading.value = true
      const searchParams = { ...filter.value, ...params }
      const response = await deviceAPI.getDevices(searchParams)
  
      devices.value = response.data.list
  
      // æ›´æ–°ç¼“å­˜
      updateDeviceCache(devices.value)
  
      return response
    } catch (error) {
      throw error
    } finally {
      loading.value = false
    }
  }

  const getDevice = async (deviceId: string): Promise<Device | null> => {
    // å…ˆä»ç¼“å­˜æŸ¥æ‰¾
    if (deviceMap.value.has(deviceId)) {
      return deviceMap.value.get(deviceId)!
    }
  
    // ä»æœåŠ¡å™¨è·å–
    try {
      const response = await deviceAPI.getDevice(deviceId)
      const device = response.data
  
      // æ›´æ–°ç¼“å­˜
      deviceMap.value.set(deviceId, device)
  
      return device
    } catch (error) {
      console.error('Get device failed:', error)
      return null
    }
  }

  const createDevice = async (deviceData: Omit<Device, 'id' | 'createTime' | 'updateTime'>) => {
    const response = await deviceAPI.createDevice(deviceData)
    const newDevice = response.data
  
    devices.value.unshift(newDevice)
    deviceMap.value.set(newDevice.deviceId, newDevice)
  
    return response
  }

  const updateDevice = async (deviceId: string, deviceData: Partial<Device>) => {
    const response = await deviceAPI.updateDevice(deviceId, deviceData)
    const updatedDevice = response.data
  
    // æ›´æ–°åˆ—è¡¨
    const index = devices.value.findIndex(d => d.id === deviceId)
    if (index !== -1) {
      devices.value[index] = updatedDevice
    }
  
    // æ›´æ–°ç¼“å­˜
    deviceMap.value.set(updatedDevice.deviceId, updatedDevice)
  
    return response
  }

  const deleteDevice = async (deviceId: string) => {
    await deviceAPI.deleteDevice(deviceId)
  
    // ä»åˆ—è¡¨ä¸­ç§»é™¤
    const index = devices.value.findIndex(d => d.id === deviceId)
    if (index !== -1) {
      const device = devices.value[index]
      devices.value.splice(index, 1)
      deviceMap.value.delete(device.deviceId)
    }
  }

  const updateDeviceStatus = (deviceId: string, status: 'online' | 'offline') => {
    const device = deviceMap.value.get(deviceId)
    if (device) {
      device.status = status
  
      // æ›´æ–°åˆ—è¡¨ä¸­çš„è®¾å¤‡çŠ¶æ€
      const listDevice = devices.value.find(d => d.deviceId === deviceId)
      if (listDevice) {
        listDevice.status = status
      }
    }
  }

  const getDeviceChannels = async (deviceId: string): Promise<DeviceChannel[]> => {
    try {
      const response = await deviceAPI.getDeviceChannels(deviceId)
      const channels = response.data
  
      // æ›´æ–°é€šé“ç¼“å­˜
      channels.forEach(channel => {
        const channelKey = `${deviceId}_${channel.channelId}`
        channelMap.value.set(channelKey, channel)
      })
  
      return channels
    } catch (error) {
      console.error('Get device channels failed:', error)
      return []
    }
  }

  const selectDevice = (device: Device | null) => {
    selectedDevice.value = device
    selectedChannel.value = null
  }

  const selectChannel = (channel: DeviceChannel | null) => {
    selectedChannel.value = channel
  }

  const searchDevices = (searchFilter: Partial<DeviceFilter>) => {
    filter.value = { ...filter.value, ...searchFilter }
    return loadDevices()
  }

  const updateDeviceCache = (deviceList: Device[]) => {
    deviceMap.value.clear()
    deviceList.forEach(device => {
      deviceMap.value.set(device.deviceId, device)
  
      // ç¼“å­˜é€šé“ä¿¡æ¯
      device.channels?.forEach(channel => {
        const channelKey = `${device.deviceId}_${channel.channelId}`
        channelMap.value.set(channelKey, channel)
      })
    })
  }

  // WebSocketäº‹ä»¶å¤„ç†
  const { subscribe } = useWebSocket()
  
  // ç›‘å¬è®¾å¤‡çŠ¶æ€å˜åŒ–
  subscribe('device-online', (data) => {
    updateDeviceStatus(data.deviceId, 'online')
  })
  
  subscribe('device-offline', (data) => {
    updateDeviceStatus(data.deviceId, 'offline')
  })

  return {
    // çŠ¶æ€
    devices,
    selectedDevice,
    selectedChannel,
    loading,
    filter,
    // è®¡ç®—å±æ€§
    onlineDevices,
    offlineDevices,
    deviceStats,
    filteredDevices,
    // Actions
    loadDevices,
    getDevice,
    createDevice,
    updateDevice,
    deleteDevice,
    updateDeviceStatus,
    getDeviceChannels,
    selectDevice,
    selectChannel,
    searchDevices
  }
})
```

#### 4.1.3 æµåª’ä½“çŠ¶æ€ç®¡ç†

```
typescript// src/stores/modules/stream.ts
import { defineStore } from 'pinia'
import { ref, computed } from 'vue'
import { streamAPI } from '@/api/modules/stream'
import type { StreamProfile, StreamSession, PTZCommand } from '@/types/global'

export const useStreamStore = defineStore('stream', () => {
  // çŠ¶æ€
  const activeStreams = ref<Map<string, StreamSession>>(new Map())
  const streamProfiles = ref<Map<string, StreamProfile>>(new Map())
  const loading = ref(false)

  // è®¡ç®—å±æ€§
  const streamCount = computed(() => activeStreams.value.size)
  const totalBandwidth = computed(() => {
    let total = 0
    activeStreams.value.forEach(stream => {
      total += stream.bandwidth || 0
    })
    return total
  })

  // Actions
  const startStream = async (
    deviceId: string, 
    channelId: string, 
    streamType: 'main' | 'sub' = 'main'
  ): Promise<StreamProfile> => {
    try {
      loading.value = true
      const streamKey = `${deviceId}_${channelId}_${streamType}`
  
      // æ£€æŸ¥æ˜¯å¦å·²æœ‰æ´»è·ƒæµ
      if (activeStreams.value.has(streamKey)) {
        const session = activeStreams.value.get(streamKey)!
        return streamProfiles.value.get(streamKey)!
      }
  
      // è¯·æ±‚å¼€å§‹æ’­æ”¾
      const response = await streamAPI.startPlay({
        deviceId,
        channelId,
        streamType
      })
  
      const streamProfile = response.data
  
      // ä¿å­˜æµä¿¡æ¯
      streamProfiles.value.set(streamKey, streamProfile)
  
      // åˆ›å»ºæµä¼šè¯
      const session: StreamSession = {
        streamId: streamProfile.streamId,
        deviceId,
        channelId,
        streamType,
        status: 'playing',
        startTime: Date.now(),
        viewers: 1,
        bandwidth: streamProfile.bitRate
      }
  
      activeStreams.value.set(streamKey, session)
  
      return streamProfile
  
    } catch (error) {
      throw error
    } finally {
      loading.value = false
    }
  }

  const stopStream = async (deviceId: string, channelId: string, streamType: 'main' | 'sub' = 'main') => {
    try {
      const streamKey = `${deviceId}_${channelId}_${streamType}`
  
      // åœæ­¢æµ
      await streamAPI.stopPlay({
        deviceId,
        channelId,
        streamType
      })
  
      // æ¸…é™¤çŠ¶æ€
      activeStreams.value.delete(streamKey)
      streamProfiles.value.delete(streamKey)
  
    } catch (error) {
      console.error('Stop stream failed:', error)
    }
  }

  const getStreamProfile = async (
    deviceId: string, 
    channelId: string, 
    streamType: 'main' | 'sub' = 'main'
  ): Promise<StreamProfile | null> => {
    const streamKey = `${deviceId}_${channelId}_${streamType}`
  
    // å…ˆä»ç¼“å­˜è·å–
    if (streamProfiles.value.has(streamKey)) {
      return streamProfiles.value.get(streamKey)!
    }
  
    // ä»æœåŠ¡å™¨è·å–
    try {
      const response = await streamAPI.getStreamInfo({
        deviceId,
        channelId,
        streamType
      })
  
      const profile = response.data
      streamProfiles.value.set(streamKey, profile)
  
      return profile
    } catch (error) {
      console.error('Get stream profile failed:', error)
      return null
    }
  }

  const sendPTZCommand = async (
    deviceId: string, 
    channelId: string, 
    command: PTZCommand
  ) => {
    try {
      await streamAPI.sendPTZCommand({
        deviceId,
        channelId,
        command: command.command,
        parameter1: command.parameter1,
        parameter2: command.parameter2,
        parameter3: command.parameter3
      })
    } catch (error) {
      throw error
    }
  }

  const getChannelPTZStatus = (deviceId: string, channelId: string): boolean => {
    // ä»è®¾å¤‡storeè·å–é€šé“ä¿¡æ¯ï¼Œåˆ¤æ–­æ˜¯å¦æ”¯æŒäº‘å°
    const deviceStore = useDeviceStore()
    const device = deviceStore.deviceMap.get(deviceId)
    if (device && device.channels) {
      const channel = device.channels.find(c => c.channelId === channelId)
      return channel ? channel.ptzType > 0 : false
    }
    return false
  }

  const startRecord = async (deviceId: string, channelId: string) => {
    try {
      const response = await streamAPI.startRecord({
        deviceId,
        channelId
      })
  
      // æ›´æ–°æµä¼šè¯çŠ¶æ€
      const streamKey = `${deviceId}_${channelId}_main`
      const session = activeStreams.value.get(streamKey)
      if (session) {
        session.recording = true
        session.recordId = response.data.recordId
      }
  
      return response
    } catch (error) {
      throw error
    }
  }

  const stopRecord = async (deviceId: string, channelId: string) => {
    try {
      const streamKey = `${deviceId}_${channelId}_main`
      const session = activeStreams.value.get(streamKey)
  
      if (session && session.recordId) {
        await streamAPI.stopRecord({
          recordId: session.recordId
        })
  
        session.recording = false
        delete session.recordId
      }
    } catch (error) {
      throw error
    }
  }

  const getStreamStats = () => {
    const stats = {
      totalStreams: activeStreams.value.size,
      recordingStreams: 0,
      totalViewers: 0,
      totalBandwidth: 0
    }
  
    activeStreams.value.forEach(stream => {
      if (stream.recording) stats.recordingStreams++
      stats.totalViewers += stream.viewers || 0
      stats.totalBandwidth += stream.bandwidth || 0
    })
  
    return stats
  }

  const clearInactiveStreams = () => {
    const now = Date.now()
    const timeout = 30 * 60 * 1000 // 30åˆ†é’Ÿè¶…æ—¶
  
    activeStreams.value.forEach((session, key) => {
      if (now - session.startTime > timeout && !session.recording) {
        activeStreams.value.delete(key)
        streamProfiles.value.delete(key)
      }
    })
  }

  return {
    // çŠ¶æ€
    activeStreams,
    streamProfiles,
    loading,
    // è®¡ç®—å±æ€§
    streamCount,
    totalBandwidth,
    // Actions
    startStream,
    stopStream,
    getStreamProfile,
    sendPTZCommand,
    getChannelPTZStatus,
    startRecord,
    stopRecord,
    getStreamStats,
    clearInactiveStreams
  }
})
```

### 4.2 ç¼“å­˜ç­–ç•¥è®¾è®¡

#### 4.2.1 æœ¬åœ°å­˜å‚¨ç®¡ç†

```
// src/utils/storage.ts
interface StorageData {
  token: string | null
  userInfo: any | null
  deviceCache: Map<string, any>
  streamCache: Map<string, any>
  appSettings: Record<string, any>
}

class StorageManager {
  private readonly TOKEN_KEY = 'gb28181_token'
  private readonly USER_KEY = 'gb28181_user'
  private readonly DEVICE_CACHE_KEY = 'gb28181_device_cache'
  private readonly STREAM_CACHE_KEY = 'gb28181_stream_cache'
  private readonly SETTINGS_KEY = 'gb28181_settings'
  
  // Tokenç®¡ç†
  setToken(token: string) {
    localStorage.setItem(this.TOKEN_KEY, token)
  }
  
  getToken(): string | null {
    return localStorage.getItem(this.TOKEN_KEY)
  }
  
  removeToken() {
    localStorage.removeItem(this.TOKEN_KEY)
  }
  
  // ç”¨æˆ·ä¿¡æ¯ç®¡ç†
  setUserInfo(user: any) {
    localStorage.setItem(this.USER_KEY, JSON.stringify(user))
  }
  
  getUserInfo(): any | null {
    const userStr = localStorage.getItem(this.USER_KEY)
    return userStr ? JSON.parse(userStr) : null
  }
  
  removeUserInfo() {
    localStorage.removeItem(this.USER_KEY)
  }
  
  // è®¾å¤‡ç¼“å­˜ç®¡ç†
  setDeviceCache(devices: Map<string, any>) {
    const data = Array.from(devices.entries())
    sessionStorage.setItem(this.DEVICE_CACHE_KEY, JSON.stringify(data))
  }
  
  getDeviceCache(): Map<string, any> {
    const dataStr = sessionStorage.getItem(this.DEVICE_CACHE_KEY)
    if (dataStr) {
      const data = JSON.parse(dataStr)
      return new Map(data)
    }
    return new Map()
  }
  
  // æµç¼“å­˜ç®¡ç†
  setStreamCache(streams: Map<string, any>) {
    const data = Array.from(streams.entries())
    sessionStorage.setItem(this.STREAM_CACHE_KEY, JSON.stringify(data))
  }
  
  getStreamCache(): Map<string, any> {
    const dataStr = sessionStorage.getItem(this.STREAM_CACHE_KEY)
    if (dataStr) {
      const data = JSON.parse(dataStr)
      return new Map(data)
    }
    return new Map()
  }
  
  // åº”ç”¨è®¾ç½®ç®¡ç†
  setSetting(key: string, value: any) {
    const settings = this.getSettings()
    settings[key] = value
    localStorage.setItem(this.SETTINGS_KEY, JSON.stringify(settings))
  }
  
  getSetting(key: string, defaultValue?: any) {
    const settings = this.getSettings()
    return settings[key] ?? defaultValue
  }
  
  getSettings(): Record<string, any> {
    const settingsStr = localStorage.getItem(this.SETTINGS_KEY)
    return settingsStr ? JSON.parse(settingsStr) : {}
  }
  
  // æ¸…é™¤è®¤è¯ä¿¡æ¯
  clearAuth() {
    this.removeToken()
    this.removeUserInfo()
  }
  
  // æ¸…é™¤æ‰€æœ‰ç¼“å­˜
  clearAll() {
    localStorage.clear()
    sessionStorage.clear()
  }
}

export const storage = new StorageManager()
```

#### 4.2.2 æ•°æ®æµè®¾è®¡å›¾

è®©æˆ‘ä¸ºæ‚¨åˆ›å»ºä¸€ä¸ªæ•°æ®æµè®¾è®¡å›¾ï¼š

graph TD
A[å‰ç«¯ç»„ä»¶] --> B[Pinia Store]
B --> C[API Layer]
C --> D[HTTP/WebSocket]
D --> E[åç«¯æœåŠ¡]

```
B --> F[Local Storage]
B --> G[Session Storage]
B --> H[Memory Cache]

I[WebSocket Events] --> B

subgraph "Store Modules"
    J[User Store]
    K[Device Store]
    L[Stream Store]
    M[Record Store]
    N[System Store]
end

B --> J
B --> K
B --> L
B --> M
B --> N

subgraph "Cache Strategy"
    O[Token Cache]
    P[Device Cache]
    Q[Stream Cache]
    R[User Preferences]
end

F --> O
G --> P
G --> Q
F --> R

style A fill:#e1f5fe
style B fill:#f3e5f5
style E fill:#e8f5e8
style I fill:#fff3e0
```

## 5. è·¯ç”±ä¸é¡µé¢è®¾è®¡

è·¯ç”±ä¸é¡µé¢è®¾è®¡ï¼šé¡µé¢ç»“æ„ã€æƒé™æ§åˆ¶ã€å¯¼èˆªè®¾è®¡

### 5.1 è·¯ç”±é…ç½®

#### 5.1.1 è·¯ç”±ä¸»æ–‡ä»¶

```
// src/router/index.ts
import { createRouter, createWebHistory } from 'vue-router'
import { setupRouterGuards } from './guards'
import { routes } from './routes'

const router = createRouter({
  history: createWebHistory(import.meta.env.BASE_URL),
  routes,
  scrollBehavior(to, from, savedPosition) {
    if (savedPosition) {
      return savedPosition
    } else {
      return { top: 0 }
    }
  }
})

// è®¾ç½®è·¯ç”±å®ˆå«
setupRouterGuards(router)

export default router
```

#### 5.1.2 è·¯ç”±é…ç½®æ–‡ä»¶

typescript

```
// src/router/routes.ts
import type { RouteRecordRaw } from 'vue-router'

// å¸ƒå±€ç»„ä»¶æ‡’åŠ è½½
const DefaultLayout = () => import('@/layouts/DefaultLayout.vue')
const BlankLayout = () => import('@/layouts/BlankLayout.vue')
const PlayerLayout = () => import('@/layouts/PlayerLayout.vue')

export const routes: RouteRecordRaw[] = [
  // ç™»å½•è·¯ç”±
  {
    path: '/login',
    name: 'Login',
    component: () => import('@/views/login/LoginView.vue'),
    meta: {
      title: 'ç”¨æˆ·ç™»å½•',
      requiresAuth: false,
      hideInMenu: true
    }
  },
  
  // ä¸»åº”ç”¨è·¯ç”±
  {
    path: '/',
    component: DefaultLayout,
    redirect: '/dashboard',
    meta: {
      title: 'GB28181è§†é¢‘å¹³å°',
      requiresAuth: true
    },
    children: [
      // ä»ªè¡¨æ¿
      {
        path: 'dashboard',
        name: 'Dashboard',
        component: () => import('@/views/dashboard/DashboardView.vue'),
        meta: {
          title: 'æ§åˆ¶å°',
          icon: 'DashboardOutlined',
          requiresAuth: true,
          keepAlive: true
        }
      },
  
      // å®æ—¶ç›‘æ§
      {
        path: 'monitor',
        name: 'Monitor',
        meta: {
          title: 'å®æ—¶ç›‘æ§',
          icon: 'VideoCameraOutlined',
          requiresAuth: true
        },
        children: [
          {
            path: 'live',
            name: 'LiveView',
            component: () => import('@/views/monitor/LiveView.vue'),
            meta: {
              title: 'å®æ—¶é¢„è§ˆ',
              requiresAuth: true,
              permissions: ['monitor:live:view']
            }
          },
          {
            path: 'multi',
            name: 'MultiView',
            component: () => import('@/views/monitor/MultiView.vue'),
            meta: {
              title: 'å¤šç”»é¢ç›‘æ§',
              requiresAuth: true,
              permissions: ['monitor:multi:view']
            }
          }
        ]
      },
  
      // è®¾å¤‡ç®¡ç†
      {
        path: 'device',
        name: 'Device',
        meta: {
          title: 'è®¾å¤‡ç®¡ç†',
          icon: 'CameraOutlined',
          requiresAuth: true
        },
        children: [
          {
            path: 'list',
            name: 'DeviceList',
            component: () => import('@/views/device/DeviceList.vue'),
            meta: {
              title: 'è®¾å¤‡åˆ—è¡¨',
              requiresAuth: true,
              permissions: ['device:list:view']
            }
          },
          {
            path: 'detail/:id',
            name: 'DeviceDetail',
            component: () => import('@/views/device/DeviceDetail.vue'),
            meta: {
              title: 'è®¾å¤‡è¯¦æƒ…',
              requiresAuth: true,
              hideInMenu: true,
              permissions: ['device:detail:view']
            }
          },
          {
            path: 'channels/:deviceId',
            name: 'ChannelList',
            component: () => import('@/views/device/ChannelList.vue'),
            meta: {
              title: 'é€šé“ç®¡ç†',
              requiresAuth: true,
              hideInMenu: true,
              permissions: ['device:channel:view']
            }
          }
        ]
      },
  
      // å½•åƒå›æ”¾
      {
        path: 'playback',
        name: 'Playback',
        meta: {
          title: 'å½•åƒå›æ”¾',
          icon: 'PlayCircleOutlined',
          requiresAuth: true
        },
        children: [
          {
            path: 'record',
            name: 'RecordList',
            component: () => import('@/views/playback/RecordList.vue'),
            meta: {
              title: 'å½•åƒåˆ—è¡¨',
              requiresAuth: true,
              permissions: ['record:list:view']
            }
          },
          {
            path: 'play/:recordId',
            name: 'RecordPlay',
            component: () => import('@/views/playback/RecordPlay.vue'),
            meta: {
              title: 'å½•åƒæ’­æ”¾',
              requiresAuth: true,
              hideInMenu: true,
              permissions: ['record:play:view']
            }
          }
        ]
      },
  
      // ç³»ç»Ÿç®¡ç†
      {
        path: 'system',
        name: 'System',
        meta: {
          title: 'ç³»ç»Ÿç®¡ç†',
          icon: 'SettingOutlined',
          requiresAuth: true,
          roles: ['admin', 'manager']
        },
        children: [
          {
            path: 'user',
            name: 'UserManage',
            component: () => import('@/views/system/UserManage.vue'),
            meta: {
              title: 'ç”¨æˆ·ç®¡ç†',
              requiresAuth: true,
              permissions: ['system:user:manage']
            }
          },
          {
            path: 'role',
            name: 'RoleManage',
            component: () => import('@/views/system/RoleManage.vue'),
            meta: {
              title: 'è§’è‰²ç®¡ç†',
              requiresAuth: true,
              permissions: ['system:role:manage']
            }
          },
          {
            path: 'config',
            name: 'ConfigManage',
            component: () => import('@/views/system/ConfigManage.vue'),
            meta: {
              title: 'ç³»ç»Ÿé…ç½®',
              requiresAuth: true,
              permissions: ['system:config:manage']
            }
          },
          {
            path: 'log',
            name: 'LogManage',
            component: () => import('@/views/system/LogManage.vue'),
            meta: {
              title: 'æ—¥å¿—ç®¡ç†',
              requiresAuth: true,
              permissions: ['system:log:view']
            }
          }
        ]
      }
    ]
  },
  
  // å…¨å±æ’­æ”¾è·¯ç”±
  {
    path: '/player',
    component: PlayerLayout,
    children: [
      {
        path: 'fullscreen/:deviceId/:channelId',
        name: 'FullscreenPlayer',
        component: () => import('@/views/monitor/FullScreen.vue'),
        meta: {
          title: 'å…¨å±æ’­æ”¾',
          requiresAuth: true,
          hideInMenu: true
        }
      }
    ]
  },
  
  // å¼‚å¸¸é¡µé¢
  {
    path: '/exception',
    component: BlankLayout,
    children: [
      {
        path: '403',
        name: 'Exception403',
        component: () => import('@/views/exception/403.vue'),
        meta: {
          title: 'æ— æƒé™',
          hideInMenu: true
        }
      },
      {
        path: '404',
        name: 'Exception404',
        component: () => import('@/views/exception/404.vue'),
        meta: {
          title: 'é¡µé¢ä¸å­˜åœ¨',
          hideInMenu: true
        }
      },
      {
        path: '500',
        name: 'Exception500',
        component: () => import('@/views/exception/500.vue'),
        meta: {
          title: 'æœåŠ¡å™¨é”™è¯¯',
          hideInMenu: true
        }
      }
    ]
  },
  
  // 404è·¯ç”± - å¿…é¡»æ”¾åœ¨æœ€å
  {
    path: '/:pathMatch(.*)*',
    redirect: '/exception/404'
  }
]
```

#### 5.1.3 è·¯ç”±å®ˆå«

typescript

```
// src/router/guards.ts
import type { Router } from 'vue-router'
import { useUserStore } from '@/stores/modules/user'
import { message } from 'ant-design-vue'

export function setupRouterGuards(router: Router) {
  // å…¨å±€å‰ç½®å®ˆå«
  router.beforeEach(async (to, from, next) => {
    const userStore = useUserStore()
  
    // è®¾ç½®é¡µé¢æ ‡é¢˜
    if (to.meta.title) {
      document.title = `${to.meta.title} - GB28181è§†é¢‘å¹³å°`
    }
  
    // æ£€æŸ¥æ˜¯å¦éœ€è¦è®¤è¯
    if (to.meta.requiresAuth) {
      if (!userStore.isLoggedIn) {
        // æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
        message.warning('è¯·å…ˆç™»å½•')
        next({
          path: '/login',
          query: { redirect: to.fullPath }
        })
        return
      }
  
      // æ£€æŸ¥æƒé™
      if (to.meta.permissions && Array.isArray(to.meta.permissions)) {
        const hasPermission = to.meta.permissions.some(permission => 
          userStore.hasPermission(permission)
        )
  
        if (!hasPermission) {
          message.error('æ‚¨æ²¡æœ‰è®¿é—®è¯¥é¡µé¢çš„æƒé™')
          next('/exception/403')
          return
        }
      }
  
      // æ£€æŸ¥è§’è‰²
      if (to.meta.roles && Array.isArray(to.meta.roles)) {
        const hasRole = to.meta.roles.some(role => 
          userStore.hasRole(role)
        )
  
        if (!hasRole) {
          message.error('æ‚¨çš„è§’è‰²æ— æ³•è®¿é—®è¯¥é¡µé¢')
          next('/exception/403')
          return
        }
      }
    }
  
    // å·²ç™»å½•çŠ¶æ€ä¸‹è®¿é—®ç™»å½•é¡µï¼Œè·³è½¬åˆ°é¦–é¡µ
    if (to.path === '/login' && userStore.isLoggedIn) {
      next('/')
      return
    }
  
    next()
  })
  
  // å…¨å±€åç½®å®ˆå«
  router.afterEach((to, from) => {
    // é¡µé¢è®¿é—®ç»Ÿè®¡
    if (to.name && typeof to.name === 'string') {
      console.log(`Page accessed: ${to.name}`)
    }
  })
}
```

### 5.2 å¯¼èˆªè®¾è®¡

#### 5.2.1 ä¾§è¾¹æ ç»„ä»¶

####

```
<!-- src/components/common/AppSidebar/index.vue -->
<template>
  <a-layout-sider
    v-model:collapsed="collapsed"
    :trigger="null"
    collapsible
    :width="sidebarWidth"
    :collapsed-width="collapsedWidth"
    class="app-sidebar"
  >
    <!-- LogoåŒºåŸŸ -->
    <div class="sidebar-logo">
      <img src="@/assets/images/logo.png" alt="Logo" class="logo-img" />
      <h1 v-show="!collapsed" class="logo-title">GB28181å¹³å°</h1>
    </div>
  
    <!-- èœå•åŒºåŸŸ -->
    <a-menu
      v-model:selectedKeys="selectedKeys"
      v-model:openKeys="openKeys"
      mode="inline"
      theme="dark"
      :inline-collapsed="collapsed"
      @click="handleMenuClick"
    >
      <template v-for="route in menuRoutes" :key="route.path">
        <a-menu-item v-if="!route.children" :key="route.path">
          <template #icon>
            <component :is="route.meta.icon" />
          </template>
          <span>{{ route.meta.title }}</span>
        </a-menu-item>
  
        <a-sub-menu v-else :key="route.path">
          <template #icon>
            <component :is="route.meta.icon" />
          </template>
          <template #title>{{ route.meta.title }}</template>
    
          <a-menu-item 
            v-for="child in route.children.filter(c => !c.meta?.hideInMenu)" 
            :key="child.path"
          >
            {{ child.meta.title }}
          </a-menu-item>
        </a-sub-menu>
      </template>
    </a-menu>
  
    <!-- åº•éƒ¨æŠ˜å æŒ‰é’® -->
    <div class="sidebar-trigger" @click="toggleCollapsed">
      <MenuFoldOutlined v-if="!collapsed" />
      <MenuUnfoldOutlined v-else />
    </div>
  </a-layout-sider>
</template>

<script setup lang="ts">
import { ref, computed, watch } from 'vue'
import { useRouter, useRoute } from 'vue-router'
import { useUserStore } from '@/stores/modules/user'
import { routes } from '@/router/routes'
import type { RouteRecordRaw } from 'vue-router'

const router = useRouter()
const route = useRoute()
const userStore = useUserStore()

// ä¾§è¾¹æ çŠ¶æ€
const collapsed = ref(false)
const sidebarWidth = 240
const collapsedWidth = 80

const selectedKeys = ref<string[]>([])
const openKeys = ref<string[]>([])

// è¿‡æ»¤èœå•è·¯ç”±
const menuRoutes = computed(() => {
  return filterMenuRoutes(routes)
})

// è¿‡æ»¤æœ‰æƒé™çš„èœå•è·¯ç”±
const filterMenuRoutes = (routes: RouteRecordRaw[]): RouteRecordRaw[] => {
  return routes.filter(route => {
    // è¿‡æ»¤éšè—èœå•é¡¹
    if (route.meta?.hideInMenu) return false
  
    // æ£€æŸ¥æ˜¯å¦éœ€è¦è®¤è¯
    if (route.meta?.requiresAuth && !userStore.isLoggedIn) return false
  
    // æ£€æŸ¥æƒé™
    if (route.meta?.permissions && Array.isArray(route.meta.permissions)) {
      const hasPermission = route.meta.permissions.some(permission => 
        userStore.hasPermission(permission)
      )
      if (!hasPermission) return false
    }
  
    // æ£€æŸ¥è§’è‰²
    if (route.meta?.roles && Array.isArray(route.meta.roles)) {
      const hasRole = route.meta.roles.some(role => 
        userStore.hasRole(role)
      )
      if (!hasRole) return false
    }
  
    // é€’å½’è¿‡æ»¤å­è·¯ç”±
    if (route.children) {
      route.children = filterMenuRoutes(route.children)
    }
  
    return true
  })
}

// ç›‘å¬è·¯ç”±å˜åŒ–ï¼Œæ›´æ–°èœå•é€‰ä¸­çŠ¶æ€
watch(() => route.path, (newPath) => {
  updateMenuState(newPath)
}, { immediate: true })

const updateMenuState = (path: string) => {
  selectedKeys.value = [path]
  
  // è®¾ç½®å±•å¼€çš„èœå•é¡¹
  const pathSegments = path.split('/').filter(Boolean)
  const openKeysList: string[] = []
  
  for (let i = 0; i < pathSegments.length; i++) {
    const currentPath = '/' + pathSegments.slice(0, i + 1).join('/')
    openKeysList.push(currentPath)
  }
  
  openKeys.value = openKeysList
}

// èœå•ç‚¹å‡»å¤„ç†
const handleMenuClick = ({ key }: { key: string }) => {
  if (key !== route.path) {
    router.push(key)
  }
}

// åˆ‡æ¢æŠ˜å çŠ¶æ€
const toggleCollapsed = () => {
  collapsed.value = !collapsed.value
}

// æš´éœ²ç»™çˆ¶ç»„ä»¶
defineExpose({
  collapsed,
  toggleCollapsed
})
</script>

<style lang="scss" scoped>
.app-sidebar {
  height: 100vh;
  position: fixed;
  left: 0;
  top: 0;
  z-index: 100;
  box-shadow: 2px 0 6px rgba(0, 21, 41, 0.35);

  .sidebar-logo {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 64px;
    padding: 16px;
    background: rgba(255, 255, 255, 0.1);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);

    .logo-img {
      width: 32px;
      height: 32px;
    }

    .logo-title {
      margin: 0 0 0 12px;
      color: white;
      font-size: 16px;
      font-weight: 600;
      white-space: nowrap;
    }
  }

  .sidebar-trigger {
    position: absolute;
    bottom: 16px;
    left: 50%;
    transform: translateX(-50%);
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    cursor: pointer;
    color: white;
    transition: all 0.3s;

    &:hover {
      background: rgba(255, 255, 255, 0.2);
    }
  }

  :deep(.ant-menu) {
    background: transparent;
    border-right: none;

    .ant-menu-item,
    .ant-menu-submenu-title {
      height: 48px;
      line-height: 48px;
      margin: 0;
      border-radius: 0;
    }

    .ant-menu-item-selected {
      background: #1890ff !important;
    }
  }
}
</style>
```

#### 5.2.2 é¡µé¢å¤´éƒ¨ç»„ä»¶

vue

```
// src/router/index.ts
import { createRouter, createWebHistory } from 'vue-router'
import { setupRouterGuards } from './guards'
import { routes } from './routes'

const router = createRouter({
  history: createWebHistory(import.meta.env.BASE_URL),
  routes,
  scrollBehavior(to, from, savedPosition) {
    if (savedPosition) {
      return savedPosition
    } else {
      return { top: 0 }
    }
  }
})

// è®¾ç½®è·¯ç”±å®ˆå«
setupRouterGuards(router)

export default router
```

## 6. APIæ¥å£è®¾è®¡

APIæ¥å£è®¾è®¡ï¼šHTTPå®¢æˆ·ç«¯ã€WebSocketé€šä¿¡ã€é”™è¯¯å¤„ç†

### 6.1 HTTPå®¢æˆ·ç«¯å°è£…

#### 6.1.1 è¯·æ±‚å®¢æˆ·ç«¯

```
// src/api/request.ts
import axios, { AxiosInstance, AxiosRequestConfig, AxiosResponse } from 'axios'
import { message } from 'ant-design-vue'
import { useUserStore } from '@/stores/modules/user'
import { storage } from '@/utils/storage'
import router from '@/router'

// å“åº”æ•°æ®æ¥å£
export interface ApiResponse<T = any> {
  code: number
  message: string
  data: T
  timestamp: number
}

// è¯·æ±‚é…ç½®æ¥å£
export interface RequestConfig extends AxiosRequestConfig {
  skipAuth?: boolean
  skipErrorHandler?: boolean
  showLoading?: boolean
  showSuccessMessage?: boolean
}

class RequestClient {
  private instance: AxiosInstance
  private loadingCount = 0

  constructor() {
    this.instance = axios.create({
      baseURL: import.meta.env.VITE_API_BASE_URL || '/api',
      timeout: 30000,
      headers: {
        'Content-Type': 'application/json'
      }
    })

    this.setupInterceptors()
  }

  private setupInterceptors() {
    // è¯·æ±‚æ‹¦æˆªå™¨
    this.instance.interceptors.request.use(
      (config: RequestConfig) => {
        // æ·»åŠ è®¤è¯token
        if (!config.skipAuth) {
          const token = storage.getToken()
          if (token) {
            config.headers = config.headers || {}
            config.headers.Authorization = `Bearer ${token}`
          }
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        if (config.showLoading) {
          this.showLoading()
        }

        // æ·»åŠ è¯·æ±‚æ—¶é—´æˆ³ï¼Œé˜²æ­¢ç¼“å­˜
        if (config.method === 'get') {
          config.params = {
            ...config.params,
            _t: Date.now()
          }
        }

        return config
      },
      (error) => {
        return Promise.reject(error)
      }
    )

    // å“åº”æ‹¦æˆªå™¨
    this.instance.interceptors.response.use(
      (response: AxiosResponse<ApiResponse>) => {
        this.hideLoading()

        const { data } = response
        const config = response.config as RequestConfig

        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        if (config.showSuccessMessage && data.message) {
          message.success(data.message)
        }

        // ç»Ÿä¸€å¤„ç†ä¸šåŠ¡é”™è¯¯
        if (data.code !== 200) {
          if (!config.skipErrorHandler) {
            this.handleBusinessError(data.code, data.message)
          }
          return Promise.reject(new Error(data.message))
        }

        return response
      },
      (error) => {
        this.hideLoading()

        const config = error.config as RequestConfig
  
        if (!config?.skipErrorHandler) {
          this.handleHttpError(error)
        }

        return Promise.reject(error)
      }
    )
  }

  private showLoading() {
    this.loadingCount++
    // è¿™é‡Œå¯ä»¥æ˜¾ç¤ºå…¨å±€loading
  }

  private hideLoading() {
    this.loadingCount--
    if (this.loadingCount <= 0) {
      this.loadingCount = 0
      // è¿™é‡Œå¯ä»¥éšè—å…¨å±€loading
    }
  }

  private handleBusinessError(code: number, msg: string) {
    switch (code) {
      case 401:
        message.error('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•')
        this.handleLogout()
        break
      case 403:
        message.error('æ²¡æœ‰æƒé™è®¿é—®è¯¥èµ„æº')
        break
      case 404:
        message.error('è¯·æ±‚çš„èµ„æºä¸å­˜åœ¨')
        break
      case 500:
        message.error('æœåŠ¡å™¨å†…éƒ¨é”™è¯¯')
        break
      default:
        message.error(msg || 'è¯·æ±‚å¤±è´¥')
    }
  }

  private handleHttpError(error: any) {
    if (error.response) {
      const { status, statusText } = error.response
      switch (status) {
        case 401:
          this.handleLogout()
          break
        case 403:
          router.push('/exception/403')
          break
        case 404:
          router.push('/exception/404')
          break
        case 500:
          router.push('/exception/500')
          break
        default:
          message.error(`è¯·æ±‚å¤±è´¥: ${status} ${statusText}`)
      }
    } else if (error.request) {
      message.error('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®')
    } else {
      message.error('è¯·æ±‚é…ç½®é”™è¯¯')
    }
  }

  private handleLogout() {
    const userStore = useUserStore()
    userStore.logout().then(() => {
      router.push('/login')
    })
  }

  // é€šç”¨è¯·æ±‚æ–¹æ³•
  public request<T = any>(config: RequestConfig): Promise<ApiResponse<T>> {
    return this.instance.request<any, AxiosResponse<ApiResponse<T>>>(config)
      .then(response => response.data)
  }

  // GETè¯·æ±‚
  public get<T = any>(
    url: string, 
    params?: any, 
    config?: RequestConfig
  ): Promise<ApiResponse<T>> {
    return this.request<T>({
      method: 'GET',
      url,
      params,
      ...config
    })
  }

  // POSTè¯·æ±‚
  public post<T = any>(
    url: string, 
    data?: any, 
    config?: RequestConfig
  ): Promise<ApiResponse<T>> {
    return this.request<T>({
      method: 'POST',
      url,
      data,
      ...config
    })
  }

  // PUTè¯·æ±‚
  public put<T = any>(
    url: string, 
    data?: any, 
    config?: RequestConfig
  ): Promise<ApiResponse<T>> {
    return this.request<T>({
      method: 'PUT',
      url,
      data,
      ...config
    })
  }

  // DELETEè¯·æ±‚
  public delete<T = any>(
    url: string, 
    config?: RequestConfig
  ): Promise<ApiResponse<T>> {
    return this.request<T>({
      method: 'DELETE',
      url,
      ...config
    })
  }

  // æ–‡ä»¶ä¸Šä¼ 
  public upload<T = any>(
    url: string, 
    file: File, 
    onProgress?: (progress: number) => void,
    config?: RequestConfig
  ): Promise<ApiResponse<T>> {
    const formData = new FormData()
    formData.append('file', file)

    return this.request<T>({
      method: 'POST',
      url,
      data: formData,
      headers: {
        'Content-Type': 'multipart/form-data'
      },
      onUploadProgress: (progressEvent) => {
        if (onProgress && progressEvent.total) {
          const progress = (progressEvent.loaded / progressEvent.total) * 100
          onProgress(Math.round(progress))
        }
      },
      ...config
    })
  }

  // æ–‡ä»¶ä¸‹è½½
  public download(url: string, filename?: string, config?: RequestConfig): Promise<void> {
    return this.request({
      method: 'GET',
      url,
      responseType: 'blob',
      ...config
    }).then((response: any) => {
      const blob = new Blob([response])
      const downloadUrl = window.URL.createObjectURL(blob)
      const link = document.createElement('a')
      link.href = downloadUrl
      link.download = filename || 'download'
      document.body.appendChild(link)
      link.click()
      document.body.removeChild(link)
      window.URL.revokeObjectURL(downloadUrl)
    })
  }
}

export const httpClient = new RequestClient()
```

#### 6.1.2 APIæ¨¡å—å®šä¹‰

typescript

```
// src/api/modules/device.ts
import { httpClient } from '../request'
import type { Device, DeviceChannel, DeviceFilter } from '@/types/global'

export interface DeviceListResponse {
  list: Device[]
  total: number
  page: number
  pageSize: number
}

export interface DeviceCreateRequest {
  deviceId: string
  name: string
  deviceType: 'IPC' | 'NVR' | 'DVR'
  ip: string
  port: number
  sipId?: string
  password?: string
}

export interface DeviceUpdateRequest extends Partial<DeviceCreateRequest> {}

export const deviceAPI = {
  // è·å–è®¾å¤‡åˆ—è¡¨
  getDevices: (params: DeviceFilter) => 
    httpClient.get<DeviceListResponse>('/devices', params),

  // è·å–è®¾å¤‡è¯¦æƒ…
  getDevice: (deviceId: string) => 
    httpClient.get<Device>(`/devices/${deviceId}`),

  // åˆ›å»ºè®¾å¤‡
  createDevice: (data: DeviceCreateRequest) => 
    httpClient.post<Device>('/devices', data, { showSuccessMessage: true }),

  // æ›´æ–°è®¾å¤‡
  updateDevice: (deviceId: string, data: DeviceUpdateRequest) => 
    httpClient.put<Device>(`/devices/${deviceId}`, data, { showSuccessMessage: true }),

  // åˆ é™¤è®¾å¤‡
  deleteDevice: (deviceId: string) => 
    httpClient.delete(`/devices/${deviceId}`, { showSuccessMessage: true }),

  // è·å–è®¾å¤‡é€šé“
  getDeviceChannels: (deviceId: string) => 
    httpClient.get<DeviceChannel[]>(`/devices/${deviceId}/channels`),

  // åŒæ­¥è®¾å¤‡é€šé“
  syncDeviceChannels: (deviceId: string) => 
    httpClient.post(`/devices/${deviceId}/sync-channels`, {}, { 
      showLoading: true, 
      showSuccessMessage: true 
    }),

  // è®¾å¤‡æ§åˆ¶
  controlDevice: (deviceId: string, action: 'reboot' | 'reset') => 
    httpClient.post(`/devices/${deviceId}/control`, { action }, { 
      showSuccessMessage: true 
    }),

  // è·å–è®¾å¤‡ç»Ÿè®¡
  getDeviceStats: () => 
    httpClient.get('/devices/stats')
}
```

### 6.2 WebSocketé€šä¿¡è®¾è®¡

#### 6.2.1 WebSocketå®¢æˆ·ç«¯

```
// src/api/websocket.ts
import { ref, reactive } from 'vue'
import { message } from 'ant-design-vue'
import { storage } from '@/utils/storage'

export interface WSMessage {
  type: string
  data: any
  timestamp: number
}

export interface WSConfig {
  url?: string
  protocols?: string | string[]
  reconnectInterval?: number
  maxReconnectAttempts?: number
  heartbeatInterval?: number
  enableHeartbeat?: boolean
}

export type WSEventHandler = (data: any) => void

class WebSocketClient {
  private ws: WebSocket | null = null
  private config: Required<WSConfig>
  private reconnectTimer: NodeJS.Timeout | null = null
  private heartbeatTimer: NodeJS.Timeout | null = null
  private eventHandlers: Map<string, WSEventHandler[]> = new Map()
  private reconnectAttempts = 0

  // å“åº”å¼çŠ¶æ€
  public connected = ref(false)
  public connecting = ref(false)
  public lastError = ref<string>('')
  public stats = reactive({
    messagesReceived: 0,
    messagesSent: 0,
    reconnectCount: 0,
    lastHeartbeat: 0
  })

  constructor(config: WSConfig = {}) {
    this.config = {
      url: config.url || this.getDefaultWSUrl(),
      protocols: config.protocols || [],
      reconnectInterval: config.reconnectInterval || 3000,
      maxReconnectAttempts: config.maxReconnectAttempts || 10,
      heartbeatInterval: config.heartbeatInterval || 30000,
      enableHeartbeat: config.enableHeartbeat !== false
    }
  }

  private getDefaultWSUrl(): string {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:'
    const host = import.meta.env.VITE_WS_BASE_URL || window.location.host
    return `${protocol}//${host}/ws`
  }

  // è¿æ¥WebSocket
  public connect(): Promise<void> {
    return new Promise((resolve, reject) => {
      if (this.ws && this.ws.readyState === WebSocket.OPEN) {
        resolve()
        return
      }

      this.connecting.value = true
      this.lastError.value = ''

      try {
        // æ·»åŠ è®¤è¯tokenåˆ°URL
        const token = storage.getToken()
        const wsUrl = token 
          ? `${this.config.url}?token=${encodeURIComponent(token)}`
          : this.config.url

        this.ws = new WebSocket(wsUrl, this.config.protocols)

        this.ws.onopen = (event) => {
          console.log('WebSocketè¿æ¥æˆåŠŸ', event)
          this.connected.value = true
          this.connecting.value = false
          this.reconnectAttempts = 0
    
          // å¯åŠ¨å¿ƒè·³
          if (this.config.enableHeartbeat) {
            this.startHeartbeat()
          }

          resolve()
        }

        this.ws.onmessage = (event) => {
          this.handleMessage(event.data)
        }

        this.ws.onclose = (event) => {
          console.log('WebSocketè¿æ¥å…³é—­', event)
          this.connected.value = false
          this.connecting.value = false
          this.stopHeartbeat()

          // å¦‚æœä¸æ˜¯ä¸»åŠ¨å…³é—­ï¼Œå°è¯•é‡è¿
          if (event.code !== 1000 && this.reconnectAttempts < this.config.maxReconnectAttempts) {
            this.scheduleReconnect()
          }
        }

        this.ws.onerror = (event) => {
          console.error('WebSocketè¿æ¥é”™è¯¯', event)
          this.lastError.value = 'WebSocketè¿æ¥é”™è¯¯'
          this.connected.value = false
          this.connecting.value = false
          reject(new Error('WebSocketè¿æ¥å¤±è´¥'))
        }

      } catch (error) {
        this.connecting.value = false
        this.lastError.value = error.message
        reject(error)
      }
    })
  }

  // æ–­å¼€è¿æ¥
  public disconnect(): void {
    if (this.reconnectTimer) {
      clearTimeout(this.reconnectTimer)
      this.reconnectTimer = null
    }

    this.stopHeartbeat()

    if (this.ws) {
      this.ws.close(1000, 'ä¸»åŠ¨æ–­å¼€')
      this.ws = null
    }

    this.connected.value = false
    this.connecting.value = false
  }

  // å‘é€æ¶ˆæ¯
  public send(type: string, data?: any): boolean {
    if (!this.ws || this.ws.readyState !== WebSocket.OPEN) {
      console.warn('WebSocketæœªè¿æ¥ï¼Œæ— æ³•å‘é€æ¶ˆæ¯')
      return false
    }

    try {
      const message: WSMessage = {
        type,
        data: data || {},
        timestamp: Date.now()
      }

      this.ws.send(JSON.stringify(message))
      this.stats.messagesSent++
      return true
    } catch (error) {
      console.error('å‘é€WebSocketæ¶ˆæ¯å¤±è´¥', error)
      return false
    }
  }

  // è®¢é˜…äº‹ä»¶
  public subscribe(eventType: string, handler: WSEventHandler): () => void {
    if (!this.eventHandlers.has(eventType)) {
      this.eventHandlers.set(eventType, [])
    }

    this.eventHandlers.get(eventType)!.push(handler)

    // è¿”å›å–æ¶ˆè®¢é˜…å‡½æ•°
    return () => {
      const handlers = this.eventHandlers.get(eventType)
      if (handlers) {
        const index = handlers.indexOf(handler)
        if (index !== -1) {
          handlers.splice(index, 1)
        }
      }
    }
  }

  // å–æ¶ˆè®¢é˜…
  public unsubscribe(eventType: string, handler?: WSEventHandler): void {
    if (!handler) {
      // å–æ¶ˆæ‰€æœ‰è¯¥ç±»å‹çš„è®¢é˜…
      this.eventHandlers.delete(eventType)
      return
    }

    const handlers = this.eventHandlers.get(eventType)
    if (handlers) {
      const index = handlers.indexOf(handler)
      if (index !== -1) {
        handlers.splice(index, 1)
      }
    }
  }

  // å¤„ç†æ”¶åˆ°çš„æ¶ˆæ¯
  private handleMessage(rawData: string): void {
    try {
      const message: WSMessage = JSON.parse(rawData)
      this.stats.messagesReceived++

      // å¤„ç†å¿ƒè·³å“åº”
      if (message.type === 'pong') {
        this.stats.lastHeartbeat = Date.now()
        return
      }

      // åˆ†å‘äº‹ä»¶
      const handlers = this.eventHandlers.get(message.type)
      if (handlers && handlers.length > 0) {
        handlers.forEach(handler => {
          try {
            handler(message.data)
          } catch (error) {
            console.error(`å¤„ç†WebSocketäº‹ä»¶ ${message.type} æ—¶å‡ºé”™`, error)
          }
        })
      } else {
        console.warn(`æœªæ‰¾åˆ°WebSocketäº‹ä»¶ ${message.type} çš„å¤„ç†å™¨`)
      }

    } catch (error) {
      console.error('è§£æWebSocketæ¶ˆæ¯å¤±è´¥', error, rawData)
    }
  }

  // è®¡åˆ’é‡è¿
  private scheduleReconnect(): void {
    if (this.reconnectTimer) {
      clearTimeout(this.reconnectTimer)
    }

    this.reconnectAttempts++
    this.stats.reconnectCount++

    const delay = Math.min(
      this.config.reconnectInterval * Math.pow(2, this.reconnectAttempts - 1),
      30000 // æœ€å¤§30ç§’
    )

    console.log(`WebSocketå°†åœ¨ ${delay}ms åå°è¯•ç¬¬ ${this.reconnectAttempts} æ¬¡é‡è¿`)

    this.reconnectTimer = setTimeout(() => {
      this.connect().catch(error => {
        console.error('WebSocketé‡è¿å¤±è´¥', error)
      })
    }, delay)
  }

  // å¯åŠ¨å¿ƒè·³
  private startHeartbeat(): void {
    if (this.heartbeatTimer) {
      clearInterval(this.heartbeatTimer)
    }

    this.heartbeatTimer = setInterval(() => {
      if (this.connected.value) {
        this.send('ping')
      }
    }, this.config.heartbeatInterval)
  }

  // åœæ­¢å¿ƒè·³
  private stopHeartbeat(): void {
    if (this.heartbeatTimer) {
      clearInterval(this.heartbeatTimer)
      this.heartbeatTimer = null
    }
  }

  // è·å–è¿æ¥çŠ¶æ€
  public getStatus() {
    return {
      connected: this.connected.value,
      connecting: this.connecting.value,
      readyState: this.ws?.readyState,
      lastError: this.lastError.value,
      stats: { ...this.stats }
    }
  }
}

// åˆ›å»ºå…¨å±€WebSocketå®ä¾‹
export const wsClient = new WebSocketClient()

// è‡ªåŠ¨è¿æ¥ï¼ˆå¦‚æœå·²ç™»å½•ï¼‰
if (storage.getToken()) {
  wsClient.connect().catch(error => {
    console.error('WebSocketè‡ªåŠ¨è¿æ¥å¤±è´¥', error)
  })
}
```

#### 6.2.2 WebSocket Composable

typescript

```
// src/composables/useWebSocket.ts
import { onUnmounted } from 'vue'
import { wsClient, type WSEventHandler } from '@/api/websocket'

export function useWebSocket() {
  const unsubscribeFunctions: (() => void)[] = []

  // è®¢é˜…äº‹ä»¶
  const subscribe = (eventType: string, handler: WSEventHandler) => {
    const unsubscribe = wsClient.subscribe(eventType, handler)
    unsubscribeFunctions.push(unsubscribe)
    return unsubscribe
  }

  // å‘é€æ¶ˆæ¯
  const send = (type: string, data?: any) => {
    return wsClient.send(type, data)
  }

  // è¿æ¥WebSocket
  const connect = () => {
    return wsClient.connect()
  }

  // æ–­å¼€è¿æ¥
  const disconnect = () => {
    wsClient.disconnect()
  }

  // è·å–è¿æ¥çŠ¶æ€
  const getStatus = () => {
    return wsClient.getStatus()
  }

  // ç»„ä»¶å¸è½½æ—¶è‡ªåŠ¨å–æ¶ˆæ‰€æœ‰è®¢é˜…
  onUnmounted(() => {
    unsubscribeFunctions.forEach(unsubscribe => unsubscribe())
  })

  return {
    subscribe,
    send,
    connect,
    disconnect,
    getStatus,
    connected: wsClient.connected,
    connecting: wsClient.connecting,
    stats: wsClient.stats
  }
}
```

### 6.3 é”™è¯¯å¤„ç†æœºåˆ¶

#### 6.3.1 å…¨å±€é”™è¯¯å¤„ç†

```
// src/utils/errorHandler.ts
import { message, notification } from 'ant-design-vue'
import { useUserStore } from '@/stores/modules/user'
import router from '@/router'

export interface ErrorInfo {
  message: string
  stack?: string
  componentStack?: string
  errorBoundary?: string
}

export interface ErrorReport {
  error: Error
  errorInfo: ErrorInfo
  url: string
  userAgent: string
  timestamp: number
  userId?: string
}

class ErrorHandler {
  private errorQueue: ErrorReport[] = []
  private maxQueueSize = 100

  // å¤„ç†Vueé”™è¯¯
  public handleVueError(error: Error, instance: any, info: string) {
    console.error('Vue Error:', error, info)
  
    const errorReport: ErrorReport = {
      error,
      errorInfo: {
        message: error.message,
        stack: error.stack,
        componentStack: info
      },
      url: window.location.href,
      userAgent: navigator.userAgent,
      timestamp: Date.now()
    }

    this.reportError(errorReport)
    this.showErrorMessage(error.message)
  }

  // å¤„ç†å…¨å±€æœªæ•è·é”™è¯¯
  public handleGlobalError(event: ErrorEvent) {
    console.error('Global Error:', event.error)
  
    const errorReport: ErrorReport = {
      error: event.error || new Error(event.message),
      errorInfo: {
        message: event.message,
        stack: event.error?.stack
      },
      url: window.location.href,
      userAgent: navigator.userAgent,
      timestamp: Date.now()
    }

    this.reportError(errorReport)
    this.showErrorMessage('ç³»ç»Ÿå‘ç”ŸæœªçŸ¥é”™è¯¯')
  }

  // å¤„ç†Promiseæœªæ•è·æ‹’ç»
  public handleUnhandledRejection(event: PromiseRejectionEvent) {
    console.error('Unhandled Promise Rejection:', event.reason)
  
    const error = event.reason instanceof Error 
      ? event.reason 
      : new Error(String(event.reason))

    const errorReport: ErrorReport = {
      error,
      errorInfo: {
        message: error.message,
        stack: error.stack
      },
      url: window.location.href,
      userAgent: navigator.userAgent,
      timestamp: Date.now()
    }

    this.reportError(errorReport)
  
    // é˜²æ­¢é”™è¯¯è¢«æ‰“å°åˆ°æ§åˆ¶å°
    event.preventDefault()
  }

  // å¤„ç†APIé”™è¯¯
  public handleApiError(error: any, context?: string) {
    console.error('API Error:', error, context)
  
    let errorMessage = 'è¯·æ±‚å¤±è´¥'
  
    if (error.response) {
      const { status, data } = error.response
      errorMessage = data?.message || `è¯·æ±‚å¤±è´¥ (${status})`
  
      // ç‰¹æ®ŠçŠ¶æ€ç å¤„ç†
      switch (status) {
        case 401:
          this.handleAuthError()
          return
        case 403:
          errorMessage = 'æ²¡æœ‰æƒé™è®¿é—®è¯¥èµ„æº'
          break
        case 404:
          errorMessage = 'è¯·æ±‚çš„èµ„æºä¸å­˜åœ¨'
          break
        case 500:
          errorMessage = 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
          break
      }
    } else if (error.request) {
      errorMessage = 'ç½‘ç»œè¿æ¥å¤±è´¥'
    } else {
      errorMessage = error.message || 'æœªçŸ¥é”™è¯¯'
    }

    this.showErrorMessage(errorMessage, context)
  }

  // å¤„ç†è®¤è¯é”™è¯¯
  private handleAuthError() {
    const userStore = useUserStore()
  
    notification.error({
      message: 'è®¤è¯å¤±è´¥',
      description: 'ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•',
      duration: 3
    })

    userStore.logout().then(() => {
      router.push('/login')
    })
  }

  // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
  private showErrorMessage(errorMessage: string, context?: string) {
    const fullMessage = context ? `${context}: ${errorMessage}` : errorMessage
    message.error(fullMessage)
  }

  // ä¸ŠæŠ¥é”™è¯¯
  private reportError(errorReport: ErrorReport) {
    // æ·»åŠ ç”¨æˆ·ä¿¡æ¯
    const userStore = useUserStore()
    errorReport.userId = userStore.userInfo?.id

    // æ·»åŠ åˆ°é˜Ÿåˆ—
    this.errorQueue.push(errorReport)
  
    // é™åˆ¶é˜Ÿåˆ—å¤§å°
    if (this.errorQueue.length > this.maxQueueSize) {
      this.errorQueue.shift()
    }

    // å¼‚æ­¥ä¸ŠæŠ¥ï¼ˆå¯é€‰ï¼‰
    this.sendErrorReport(errorReport).catch(error => {
      console.error('Error reporting failed:', error)
    })
  }

  // å‘é€é”™è¯¯æŠ¥å‘Šåˆ°æœåŠ¡å™¨
  private async sendErrorReport(errorReport: ErrorReport) {
    try {
      // è¿™é‡Œå¯ä»¥å‘é€åˆ°é”™è¯¯ç›‘æ§æœåŠ¡
      await fetch('/api/errors/report', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(errorReport)
      })
    } catch (error) {
      // ä¸ŠæŠ¥å¤±è´¥ä¸åº”è¯¥å½±å“ç”¨æˆ·ä½“éªŒ
      console.warn('Failed to report error:', error)
    }
  }

  // è·å–é”™è¯¯é˜Ÿåˆ—
  public getErrorQueue() {
    return [...this.errorQueue]
  }

  // æ¸…ç©ºé”™è¯¯é˜Ÿåˆ—
  public clearErrorQueue() {
    this.errorQueue = []
  }
}

export const errorHandler = new ErrorHandler()

// è®¾ç½®å…¨å±€é”™è¯¯å¤„ç†
export function setupErrorHandler(app: any) {
  // Vueé”™è¯¯å¤„ç†
  app.config.errorHandler = (error: Error, instance: any, info: string) => {
    errorHandler.handleVueError(error, instance, info)
  }

  // å…¨å±€æœªæ•è·é”™è¯¯
  window.addEventListener('error', (event) => {
    errorHandler.handleGlobalError(event)
  })

  // Promiseæœªæ•è·æ‹’ç»
  window.addEventListener('unhandledrejection', (event) => {
    errorHandler.handleUnhandledRejection(event)
  })
}
```

## 7. æ’­æ”¾å™¨ç»„ä»¶è®¾è®¡

### 7.1 æ’­æ”¾å™¨ç®¡ç† Composable

#### 7.1.1 æ’­æ”¾å™¨ç®¡ç†æ ¸å¿ƒ

æ’­æ”¾å™¨ç»„ä»¶è®¾è®¡ï¼šJessibuca + H265Web.js åŒæ’­æ”¾å™¨æ–¹æ¡ˆ

```
// src/composables/usePlayer.ts
import { ref, computed, onUnmounted, nextTick } from 'vue'
import { message } from 'ant-design-vue'

export type PlayerType = 'jessibuca' | 'h265web'
export type PlayerStatus = 'idle' | 'loading' | 'playing' | 'paused' | 'error'

export interface PlayerConfig {
  container: string | HTMLElement
  width?: number | string
  height?: number | string
  autoPlay?: boolean
  muted?: boolean
  hasAudio?: boolean
  videoBuffer?: number
  videoBufferDelay?: number
  decoder?: string
  forceNoOffscreen?: boolean
  isResize?: boolean
  loadingTimeout?: number
  heartTimeout?: number
  timeout?: number
  pageVisibilityHiddenTimeout?: number
  debug?: boolean
}

export interface StreamURLs {
  rtsp?: string
  rtmp?: string
  flv?: string
  hls?: string
  wsflv?: string
}

export function usePlayer() {
  // æ’­æ”¾å™¨å®ä¾‹å¼•ç”¨
  const playerInstance = ref<any>(null)
  const playerRef = ref<HTMLElement>()
  const canvasRef = ref<HTMLCanvasElement>()
  
  // æ’­æ”¾å™¨çŠ¶æ€
  const currentPlayerType = ref<PlayerType>('jessibuca')
  const playerStatus = ref<PlayerStatus>('idle')
  const isPlaying = ref(false)
  const isRecording = ref(false)
  const isFullscreen = ref(false)
  const loading = ref(false)
  const error = ref('')
  
  // æ’­æ”¾å™¨ä¿¡æ¯
  const playerId = ref(`player_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`)
  const canvasId = ref(`canvas_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`)
  const streamInfo = ref<any>(null)
  
  // æ’­æ”¾å™¨é…ç½®
  const defaultConfig: PlayerConfig = {
    container: '',
    autoPlay: true,
    muted: false,
    hasAudio: true,
    videoBuffer: 0.2,
    videoBufferDelay: 1,
    isResize: true,
    loadingTimeout: 10,
    heartTimeout: 10,
    timeout: 10,
    pageVisibilityHiddenTimeout: 300,
    debug: false
  }

  // è®¡ç®—å±æ€§
  const canPlay = computed(() => 
    playerStatus.value === 'idle' || playerStatus.value === 'paused'
  )
  
  const canPause = computed(() => 
    playerStatus.value === 'playing'
  )

  // åˆå§‹åŒ–æ’­æ”¾å™¨
  const initPlayer = async (type: PlayerType, config?: Partial<PlayerConfig>) => {
    try {
      currentPlayerType.value = type
      loading.value = true
      error.value = ''
  
      // å…ˆé”€æ¯ç°æœ‰æ’­æ”¾å™¨
      if (playerInstance.value) {
        destroy()
      }
  
      // ç­‰å¾…DOMæ›´æ–°
      await nextTick()
  
      const mergedConfig = { ...defaultConfig, ...config }
  
      if (type === 'jessibuca') {
        await initJessibucaPlayer(mergedConfig)
      } else if (type === 'h265web') {
        await initH265WebPlayer(mergedConfig)
      } else {
        throw new Error(`ä¸æ”¯æŒçš„æ’­æ”¾å™¨ç±»å‹: ${type}`)
      }
  
      playerStatus.value = 'idle'
  
    } catch (err) {
      error.value = err.message || 'æ’­æ”¾å™¨åˆå§‹åŒ–å¤±è´¥'
      playerStatus.value = 'error'
      throw err
    } finally {
      loading.value = false
    }
  }

  // åˆå§‹åŒ–Jessibucaæ’­æ”¾å™¨
  const initJessibucaPlayer = async (config: PlayerConfig) => {
    // ç¡®ä¿Jessibucaå·²åŠ è½½
    if (!window.Jessibuca) {
      throw new Error('Jessibucaæ’­æ”¾å™¨æœªåŠ è½½')
    }
  
    const container = typeof config.container === 'string' 
      ? document.getElementById(config.container) || playerRef.value
      : config.container || playerRef.value
  
    if (!container) {
      throw new Error('æ’­æ”¾å™¨å®¹å™¨ä¸å­˜åœ¨')
    }

    playerInstance.value = new window.Jessibuca({
      container,
      videoBuffer: config.videoBuffer,
      videoBufferDelay: config.videoBufferDelay,
      decoder: config.decoder || '/players/jessibuca/decoder.wasm',
      forceNoOffscreen: config.forceNoOffscreen || false,
      isResize: config.isResize,
      loadingTimeout: config.loadingTimeout! * 1000,
      heartTimeout: config.heartTimeout! * 1000,
      timeout: config.timeout! * 1000,
      pageVisibilityHiddenTimeout: config.pageVisibilityHiddenTimeout! * 1000,
      debug: config.debug,
  
      // äº‹ä»¶å›è°ƒ
      onPlay: handlePlay,
      onPause: handlePause,
      onTimeUpdate: handleTimeUpdate,
      onMute: handleMute,
      onLoad: handleLoad,
      onLog: handleLog,
      onError: handleError,
      onKBps: handleKBps,
      onRecord: handleRecord,
      onBuffer: handleBuffer,
      onResolutionChange: handleResolutionChange
    })
  }

  // åˆå§‹åŒ–H265Web.jsæ’­æ”¾å™¨
  const initH265WebPlayer = async (config: PlayerConfig) => {
    // ç¡®ä¿H265Web.jså·²åŠ è½½
    if (!window.H265webjs) {
      throw new Error('H265Web.jsæ’­æ”¾å™¨æœªåŠ è½½')
    }
  
    const canvas = canvasRef.value
    if (!canvas) {
      throw new Error('Canvaså…ƒç´ ä¸å­˜åœ¨')
    }

    playerInstance.value = new window.H265webjs.Player({
      canvas: canvas,
      width: config.width || canvas.clientWidth,
      height: config.height || canvas.clientHeight,
  
      // H265ä¸“ç”¨é…ç½®
      decoder: config.decoder || '/players/h265web/h265web.wasm',
      autoPlay: config.autoPlay,
      debug: config.debug,
  
      // äº‹ä»¶å›è°ƒ
      onReady: () => {
        console.log('H265æ’­æ”¾å™¨å‡†å¤‡å°±ç»ª')
        playerStatus.value = 'idle'
      },
      onPlay: handlePlay,
      onPause: handlePause,
      onError: handleError,
      onLoadStart: () => {
        loading.value = true
        playerStatus.value = 'loading'
      },
      onLoadedData: () => {
        loading.value = false
        handleLoad()
      }
    })
  }

  // å¼€å§‹æ’­æ”¾
  const startPlay = async (url: string) => {
    if (!playerInstance.value) {
      throw new Error('æ’­æ”¾å™¨æœªåˆå§‹åŒ–')
    }
  
    try {
      loading.value = true
      error.value = ''
      playerStatus.value = 'loading'
  
      if (currentPlayerType.value === 'jessibuca') {
        playerInstance.value.play(url)
      } else if (currentPlayerType.value === 'h265web') {
        await playerInstance.value.load(url)
        if (defaultConfig.autoPlay) {
          await playerInstance.value.play()
        }
      }
  
    } catch (err) {
      error.value = err.message || 'æ’­æ”¾å¤±è´¥'
      playerStatus.value = 'error'
      loading.value = false
      throw err
    }
  }

  // åœæ­¢æ’­æ”¾
  const stopPlay = async () => {
    if (!playerInstance.value) return
  
    try {
      if (currentPlayerType.value === 'jessibuca') {
        playerInstance.value.destroy()
      } else if (currentPlayerType.value === 'h265web') {
        playerInstance.value.pause()
        playerInstance.value.stop()
      }
  
      isPlaying.value = false
      playerStatus.value = 'idle'
  
    } catch (err) {
      console.error('åœæ­¢æ’­æ”¾å¤±è´¥:', err)
    }
  }

  // åˆ‡æ¢æ’­æ”¾/æš‚åœ
  const togglePlay = async () => {
    if (!playerInstance.value) return
  
    try {
      if (isPlaying.value) {
        if (currentPlayerType.value === 'jessibuca') {
          playerInstance.value.pause()
        } else if (currentPlayerType.value === 'h265web') {
          playerInstance.value.pause()
        }
      } else {
        if (currentPlayerType.value === 'jessibuca') {
          playerInstance.value.play()
        } else if (currentPlayerType.value === 'h265web') {
          playerInstance.value.play()
        }
      }
    } catch (err) {
      error.value = err.message || 'æ’­æ”¾æ§åˆ¶å¤±è´¥'
    }
  }

  // åˆ‡æ¢å½•åƒ
  const toggleRecord = async () => {
    if (!playerInstance.value) return
  
    try {
      if (currentPlayerType.value === 'jessibuca') {
        if (isRecording.value) {
          playerInstance.value.stopRecord()
        } else {
          playerInstance.value.startRecord()
        }
      } else {
        message.warning('H265æ’­æ”¾å™¨æš‚ä¸æ”¯æŒæœ¬åœ°å½•åƒ')
      }
    } catch (err) {
      error.value = err.message || 'å½•åƒæ§åˆ¶å¤±è´¥'
    }
  }

  // åˆ‡æ¢å…¨å±
  const toggleFullscreen = async () => {
    try {
      if (isFullscreen.value) {
        if (document.exitFullscreen) {
          await document.exitFullscreen()
        }
      } else {
        const element = playerRef.value || canvasRef.value
        if (element && element.requestFullscreen) {
          await element.requestFullscreen()
        }
      }
    } catch (err) {
      console.error('å…¨å±åˆ‡æ¢å¤±è´¥:', err)
    }
  }

  // æˆªå›¾
  const screenshot = (): Promise<string> => {
    return new Promise((resolve, reject) => {
      if (!playerInstance.value) {
        reject(new Error('æ’­æ”¾å™¨æœªåˆå§‹åŒ–'))
        return
      }
  
      try {
        if (currentPlayerType.value === 'jessibuca') {
          playerInstance.value.screenshot('image/jpeg', '', 'base64', (base64: string) => {
            resolve(base64)
          })
        } else if (currentPlayerType.value === 'h265web') {
          const canvas = canvasRef.value
          if (canvas) {
            resolve(canvas.toDataURL('image/jpeg'))
          } else {
            reject(new Error('æ— æ³•è·å–ç”»å¸ƒ'))
          }
        }
      } catch (err) {
        reject(err)
      }
    })
  }

  // é”€æ¯æ’­æ”¾å™¨
  const destroy = () => {
    try {
      if (playerInstance.value) {
        if (currentPlayerType.value === 'jessibuca') {
          playerInstance.value.destroy()
        } else if (currentPlayerType.value === 'h265web') {
          playerInstance.value.destroy()
        }
        playerInstance.value = null
      }
  
      // é‡ç½®çŠ¶æ€
      isPlaying.value = false
      isRecording.value = false
      isFullscreen.value = false
      loading.value = false
      error.value = ''
      playerStatus.value = 'idle'
      streamInfo.value = null
  
    } catch (err) {
      console.error('é”€æ¯æ’­æ”¾å™¨å¤±è´¥:', err)
    }
  }

  // äº‹ä»¶å¤„ç†å‡½æ•°
  const handlePlay = () => {
    isPlaying.value = true
    playerStatus.value = 'playing'
    loading.value = false
    console.log('æ’­æ”¾å¼€å§‹')
  }

  const handlePause = () => {
    isPlaying.value = false
    playerStatus.value = 'paused'
    console.log('æ’­æ”¾æš‚åœ')
  }

  const handleLoad = () => {
    loading.value = false
    console.log('æµåŠ è½½å®Œæˆ')
  }

  const handleError = (error: any) => {
    console.error('æ’­æ”¾å™¨é”™è¯¯:', error)
    loading.value = false
    playerStatus.value = 'error'
    isPlaying.value = false
    error.value = error.message || 'æ’­æ”¾å‡ºç°é”™è¯¯'
  }

  const handleTimeUpdate = (time: number) => {
    // å¤„ç†æ—¶é—´æ›´æ–°
  }

  const handleMute = (muted: boolean) => {
    console.log('é™éŸ³çŠ¶æ€:', muted)
  }

  const handleLog = (log: any) => {
    if (defaultConfig.debug) {
      console.log('æ’­æ”¾å™¨æ—¥å¿—:', log)
    }
  }

  const handleKBps = (kbps: number) => {
    // å¤„ç†ç ç‡ä¿¡æ¯
  }

  const handleRecord = (recording: boolean) => {
    isRecording.value = recording
    console.log('å½•åƒçŠ¶æ€:', recording)
  }

  const handleBuffer = (buffer: number) => {
    // å¤„ç†ç¼“å†²ä¿¡æ¯
  }

  const handleResolutionChange = (width: number, height: number) => {
    streamInfo.value = {
      ...streamInfo.value,
      width,
      height,
      resolution: `${width}x${height}`
    }
    console.log('åˆ†è¾¨ç‡å˜åŒ–:', width, height)
  }

  // ç›‘å¬å…¨å±å˜åŒ–
  const handleFullscreenChange = () => {
    isFullscreen.value = !!document.fullscreenElement
  }

  // è®¾ç½®å…¨å±ç›‘å¬
  document.addEventListener('fullscreenchange', handleFullscreenChange)

  // ç»„ä»¶å¸è½½æ—¶æ¸…ç†
  onUnmounted(() => {
    destroy()
    document.removeEventListener('fullscreenchange', handleFullscreenChange)
  })

  return {
    // å¼•ç”¨
    playerRef,
    canvasRef,
    playerInstance,
  
    // çŠ¶æ€
    currentPlayerType,
    playerStatus,
    isPlaying,
    isRecording,
    isFullscreen,
    loading,
    error,
    streamInfo,
  
    // ID
    playerId,
    canvasId,
  
    // è®¡ç®—å±æ€§
    canPlay,
    canPause,
  
    // æ–¹æ³•
    initPlayer,
    startPlay,
    stopPlay,
    togglePlay,
    toggleRecord,
    toggleFullscreen,
    screenshot,
    destroy
  }
}
```

### 7.2 äº‘å°æ§åˆ¶ç»„ä»¶

#### 7.2.1 PTZæ§åˆ¶ç»„ä»¶

```
<!-- src/components/business/PTZControl/index.vue -->
<template>
  <div class="ptz-control-panel" :class="{ 'panel-expanded': expanded }">
    <!-- æ§åˆ¶é¢æ¿å¤´éƒ¨ -->
    <div class="panel-header" @click="toggleExpand">
      <h4>äº‘å°æ§åˆ¶</h4>
      <a-button type="text" size="small">
        <UpOutlined v-if="expanded" />
        <DownOutlined v-else />
      </a-button>
    </div>
  
    <!-- æ§åˆ¶é¢æ¿å†…å®¹ -->
    <div v-show="expanded" class="panel-content">
      <!-- æ–¹å‘æ§åˆ¶ -->
      <div class="direction-control">
        <div class="control-grid">
          <!-- ç¬¬ä¸€è¡Œ -->
          <div class="grid-row">
            <a-button 
              @mousedown="startMove('LEFT_UP')"
              @mouseup="stopMove"
              @mouseleave="stopMove"
              class="direction-btn diagonal"
            >
              <div class="arrow arrow-left-up"></div>
            </a-button>
            <a-button 
              @mousedown="startMove('UP')"
              @mouseup="stopMove"
              @mouseleave="stopMove"
              class="direction-btn"
            >
              <UpOutlined />
            </a-button>
            <a-button 
              @mousedown="startMove('RIGHT_UP')"
              @mouseup="stopMove"
              @mouseleave="stopMove"
              class="direction-btn diagonal"
            >
              <div class="arrow arrow-right-up"></div>
            </a-button>
          </div>
    
          <!-- ç¬¬äºŒè¡Œ -->
          <div class="grid-row">
            <a-button 
              @mousedown="startMove('LEFT')"
              @mouseup="stopMove"
              @mouseleave="stopMove"
              class="direction-btn"
            >
              <LeftOutlined />
            </a-button>
            <a-button 
              @click="stopMove"
              class="direction-btn center-btn"
              :class="{ 'active': isMoving }"
            >
              <BorderOutlined />
            </a-button>
            <a-button 
              @mousedown="startMove('RIGHT')"
              @mouseup="stopMove"
              @mouseleave="stopMove"
              class="direction-btn"
            >
              <RightOutlined />
            </a-button>
          </div>
    
          <!-- ç¬¬ä¸‰è¡Œ -->
          <div class="grid-row">
            <a-button 
              @mousedown="startMove('LEFT_DOWN')"
              @mouseup="stopMove"
              @mouseleave="stopMove"
              class="direction-btn diagonal"
            >
              <div class="arrow arrow-left-down"></div>
            </a-button>
            <a-button 
              @mousedown="startMove('DOWN')"
              @mouseup="stopMove"
              @mouseleave="stopMove"
              class="direction-btn"
            >
              <DownOutlined />
            </a-button>
            <a-button 
              @mousedown="startMove('RIGHT_DOWN')"
              @mouseup="stopMove"
              @mouseleave="stopMove"
              class="direction-btn diagonal"
            >
              <div class="arrow arrow-right-down"></div>
            </a-button>
          </div>
        </div>
  
        <!-- é€Ÿåº¦æ§åˆ¶ -->
        <div class="speed-control">
          <label>ç§»åŠ¨é€Ÿåº¦</label>
          <a-slider 
            v-model:value="moveSpeed" 
            :min="1" 
            :max="7" 
            :step="1"
            :marks="speedMarks"
          />
        </div>
      </div>
  
      <!-- ç¼©æ”¾æ§åˆ¶ -->
      <div class="zoom-control">
        <div class="zoom-buttons">
          <a-button 
            @mousedown="startZoom('IN')"
            @mouseup="stopZoom"
            @mouseleave="stopZoom"
            class="zoom-btn"
          >
            <PlusOutlined />
            <span>æ”¾å¤§</span>
          </a-button>
          <a-button 
            @mousedown="startZoom('OUT')"
            @mouseup="stopZoom"
            @mouseleave="stopZoom"
            class="zoom-btn"
          >
            <MinusOutlined />
            <span>ç¼©å°</span>
          </a-button>
        </div>
  
        <div class="zoom-speed">
          <label>ç¼©æ”¾é€Ÿåº¦</label>
          <a-slider 
            v-model:value="zoomSpeed" 
            :min="1" 
            :max="7" 
            :step="1"
          />
        </div>
      </div>
  
      <!-- ç„¦è·æ§åˆ¶ -->
      <div class="focus-control">
        <div class="focus-buttons">
          <a-button 
            @mousedown="startFocus('NEAR')"
            @mouseup="stopFocus"
            @mouseleave="stopFocus"
            class="focus-btn"
          >
            <span>è¿‘ç„¦</span>
          </a-button>
          <a-button 
            @mousedown="startFocus('FAR')"
            @mouseup="stopFocus"
            @mouseleave="stopFocus"
            class="focus-btn"
          >
            <span>è¿œç„¦</span>
          </a-button>
        </div>
  
        <a-button @click="autoFocus" class="auto-focus-btn">
          <AimOutlined />
          è‡ªåŠ¨å¯¹ç„¦
        </a-button>
      </div>
  
      <!-- å…‰åœˆæ§åˆ¶ -->
      <div class="iris-control">
        <div class="iris-buttons">
          <a-button 
            @mousedown="startIris('OPEN')"
            @mouseup="stopIris"
            @mouseleave="stopIris"
            class="iris-btn"
          >
            <span>å…‰åœˆ+</span>
          </a-button>
          <a-button 
            @mousedown="startIris('CLOSE')"
            @mouseup="stopIris"
            @mouseleave="stopIris"
            class="iris-btn"
          >
            <span>å…‰åœˆ-</span>
          </a-button>
        </div>
      </div>
  
      <!-- é¢„ç½®ä½æ§åˆ¶ -->
      <div class="preset-control">
        <div class="preset-header">
          <h5>é¢„ç½®ä½</h5>
          <a-button size="small" @click="loadPresets">
            <ReloadOutlined />
          </a-button>
        </div>
  
        <div class="preset-list">
          <div 
            v-for="preset in presets" 
            :key="preset.id"
            class="preset-item"
          >
            <span class="preset-name">{{ preset.name }}</span>
            <div class="preset-actions">
              <a-button size="small" @click="callPreset(preset.id)">
                è°ƒç”¨
              </a-button>
              <a-button size="small" @click="setPreset(preset.id)">
                è®¾ç½®
              </a-button>
              <a-popconfirm
                title="ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¢„ç½®ä½å—ï¼Ÿ"
                @confirm="deletePreset(preset.id)"
              >
                <a-button size="small" danger>
                  åˆ é™¤
                </a-button>
              </a-popconfirm>
            </div>
          </div>
        </div>
  
        <div class="preset-add">
          <a-input-group compact>
            <a-input 
              v-model:value="newPresetName" 
              placeholder="é¢„ç½®ä½åç§°"
              style="width: 60%"
            />
            <a-button @click="addPreset" style="width: 40%">
              <PlusOutlined />
              æ·»åŠ 
            </a-button>
          </a-input-group>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted, onUnmounted } from 'vue'
import { message } from 'ant-design-vue'
import { streamAPI } from '@/api/modules/stream'

interface Props {
  deviceId: string
  channelId: string
  disabled?: boolean
}

interface PTZPreset {
  id: number
  name: string
}

const props = defineProps<Props>()
const emit = defineEmits<{
  'command': [command: any]
}>()

// é¢æ¿çŠ¶æ€
const expanded = ref(true)

// æ§åˆ¶çŠ¶æ€
const isMoving = ref(false)
const isZooming = ref(false)
const isFocusing = ref(false)
const isIrisAdjusting = ref(false)

// æ§åˆ¶å‚æ•°
const moveSpeed = ref(4)
const zoomSpeed = ref(4)
const currentCommand = ref('')

// é¢„ç½®ä½
const presets = ref<PTZPreset[]>([])
const newPresetName = ref('')

// å®šæ—¶å™¨
const commandTimer = ref<NodeJS.Timeout | null>(null)

// é€Ÿåº¦æ ‡è®°
const speedMarks = {
  1: '1',
  4: '4', 
  7: '7'
}

// åˆ‡æ¢é¢æ¿å±•å¼€çŠ¶æ€
const toggleExpand = () => {
  expanded.value = !expanded.value
}

// å¼€å§‹ç§»åŠ¨
const startMove = (direction: string) => {
  if (props.disabled) return
  
  isMoving.value = true
  currentCommand.value = direction
  
  sendPTZCommand({
    command: direction,
    parameter1: moveSpeed.value,
    parameter2: 0,
    parameter3: 0
  })
  
  // æŒç»­å‘é€å‘½ä»¤
  commandTimer.value = setInterval(() => {
    sendPTZCommand({
      command: direction,
      parameter1: moveSpeed.value,
      parameter2: 0,
      parameter3: 0
    })
  }, 100)
}

// åœæ­¢ç§»åŠ¨
const stopMove = () => {
  if (commandTimer.value) {
    clearInterval(commandTimer.value)
    commandTimer.value = null
  }
  
  if (isMoving.value) {
    sendPTZCommand({
      command: 'STOP',
      parameter1: 0,
      parameter2: 0,
      parameter3: 0
    })
  }
  
  isMoving.value = false
  currentCommand.value = ''
}

// å¼€å§‹ç¼©æ”¾
const startZoom = (direction: 'IN' | 'OUT') => {
  if (props.disabled) return
  
  isZooming.value = true
  
  const command = direction === 'IN' ? 'ZOOM_IN' : 'ZOOM_OUT'
  sendPTZCommand({
    command,
    parameter1: zoomSpeed.value,
    parameter2: 0,
    parameter3: 0
  })
  
  commandTimer.value = setInterval(() => {
    sendPTZCommand({
      command,
      parameter1: zoomSpeed.value,
      parameter2: 0,
      parameter3: 0
    })
  }, 100)
}

// åœæ­¢ç¼©æ”¾
const stopZoom = () => {
  if (commandTimer.value) {
    clearInterval(commandTimer.value)
    commandTimer.value = null
  }
  
  if (isZooming.value) {
    sendPTZCommand({
      command: 'ZOOM_STOP',
      parameter1: 0,
      parameter2: 0,
      parameter3: 0
    })
  }
  
  isZooming.value = false
}

// å¼€å§‹è°ƒç„¦
const startFocus = (direction: 'NEAR' | 'FAR') => {
  if (props.disabled) return
  
  isFocusing.value = true
  
  const command = direction === 'NEAR' ? 'FOCUS_NEAR' : 'FOCUS_FAR'
  sendPTZCommand({
    command,
    parameter1: 4,
    parameter2: 0,
    parameter3: 0
  })
}

// åœæ­¢è°ƒç„¦
const stopFocus = () => {
  if (isFocusing.value) {
    sendPTZCommand({
      command: 'FOCUS_STOP',
      parameter1: 0,
      parameter2: 0,
      parameter3: 0
    })
  }
  
  isFocusing.value = false
}

// è‡ªåŠ¨å¯¹ç„¦
const autoFocus = () => {
  sendPTZCommand({
    command: 'AUTO_FOCUS',
    parameter1: 0,
    parameter2: 0,
    parameter3: 0
  })
  message.success('è‡ªåŠ¨å¯¹ç„¦å‘½ä»¤å·²å‘é€')
}

// å¼€å§‹è°ƒå…‰åœˆ
const startIris = (direction: 'OPEN' | 'CLOSE') => {
  if (props.disabled) return
  
  isIrisAdjusting.value = true
  
  const command = direction === 'OPEN' ? 'IRIS_OPEN' : 'IRIS_CLOSE'
  sendPTZCommand({
    command,
    parameter1: 4,
    parameter2: 0,
    parameter3: 0
  })
}

// åœæ­¢è°ƒå…‰åœˆ
const stopIris = () => {
  if (isIrisAdjusting.value) {
    sendPTZCommand({
      command: 'IRIS_STOP',
      parameter1: 0,
      parameter2: 0,
      parameter3: 0
    })
  }
  
  isIrisAdjusting.value = false
}

// è°ƒç”¨é¢„ç½®ä½
const callPreset = async (presetId: number) => {
  try {
    await sendPTZCommand({
      command: 'PRESET_CALL',
      parameter1: presetId,
      parameter2: 0,
      parameter3: 0
    })
    message.success(`é¢„ç½®ä½ ${presetId} è°ƒç”¨æˆåŠŸ`)
  } catch (error) {
    message.error('é¢„ç½®ä½è°ƒç”¨å¤±è´¥')
  }
}

// è®¾ç½®é¢„ç½®ä½
const setPreset = async (presetId: number) => {
  try {
    await sendPTZCommand({
      command: 'PRESET_SET',
      parameter1: presetId,
      parameter2: 0,
      parameter3: 0
    })
    message.success(`é¢„ç½®ä½ ${presetId} è®¾ç½®æˆåŠŸ`)
  } catch (error) {
    message.error('é¢„ç½®ä½è®¾ç½®å¤±è´¥')
  }
}

// åˆ é™¤é¢„ç½®ä½
const deletePreset = async (presetId: number) => {
  try {
    await sendPTZCommand({
      command: 'PRESET_DELETE',
      parameter1: presetId,
      parameter2: 0,
      parameter3: 0
    })
  
    // ä»åˆ—è¡¨ä¸­ç§»é™¤
    presets.value = presets.value.filter(p => p.id !== presetId)
    message.success('é¢„ç½®ä½åˆ é™¤æˆåŠŸ')
  } catch (error) {
    message.error('é¢„ç½®ä½åˆ é™¤å¤±è´¥')
  }
}

// æ·»åŠ é¢„ç½®ä½
const addPreset = async () => {
  if (!newPresetName.value.trim()) {
    message.warning('è¯·è¾“å…¥é¢„ç½®ä½åç§°')
    return
  }
  
  try {
    // æ‰¾åˆ°ä¸‹ä¸€ä¸ªå¯ç”¨ID
    const nextId = Math.max(...presets.value.map(p => p.id), 0) + 1
  
    await setPreset(nextId)
  
    // æ·»åŠ åˆ°åˆ—è¡¨
    presets.value.push({
      id: nextId,
      name: newPresetName.value.trim()
    })
  
    newPresetName.value = ''
    message.success('é¢„ç½®ä½æ·»åŠ æˆåŠŸ')
  } catch (error) {
    message.error('é¢„ç½®ä½æ·»åŠ å¤±è´¥')
  }
}

// åŠ è½½é¢„ç½®ä½åˆ—è¡¨
const loadPresets = async () => {
  try {
    const response = await streamAPI.getPTZPresets(props.deviceId, props.channelId)
    presets.value = response.data
  } catch (error) {
    console.error('åŠ è½½é¢„ç½®ä½å¤±è´¥:', error)
  }
}

// å‘é€PTZå‘½ä»¤
const sendPTZCommand = async (command: any) => {
  try {
    await streamAPI.sendPTZCommand({
      deviceId: props.deviceId,
      channelId: props.channelId,
      ...command
    })
  
    // è§¦å‘äº‹ä»¶
    emit('command', command)
  
  } catch (error) {
    console.error('PTZå‘½ä»¤å‘é€å¤±è´¥:', error)
    throw error
  }
}

// é”®ç›˜æ§åˆ¶
const handleKeyDown = (event: KeyboardEvent) => {
  if (props.disabled) return
  
  const { key } = event
  
  // é˜²æ­¢é‡å¤è§¦å‘
  if (isMoving.value) return
  
  switch (key) {
    case 'ArrowUp':
      event.preventDefault()
      startMove('UP')
      break
    case 'ArrowDown':
      event.preventDefault()
      startMove('DOWN')
      break
    case 'ArrowLeft':
      event.preventDefault()
      startMove('LEFT')
      break
    case 'ArrowRight':
      event.preventDefault()
      startMove('RIGHT')
      break
    case '+':
      event.preventDefault()
      startZoom('IN')
      break
    case '-':
      event.preventDefault()
      startZoom('OUT')
      break
  }
}

const handleKeyUp = (event: KeyboardEvent) => {
  const { key } = event
  
  if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(key)) {
    stopMove()
  } else if (['+', '-'].includes(key)) {
    stopZoom()
  }
}

// ç”Ÿå‘½å‘¨æœŸ
onMounted(() => {
  loadPresets()
  
  // æ·»åŠ é”®ç›˜ç›‘å¬
  window.addEventListener('keydown', handleKeyDown)
  window.addEventListener('keyup', handleKeyUp)
})

onUnmounted(() => {
  // æ¸…ç†å®šæ—¶å™¨
  if (commandTimer.value) {
    clearInterval(commandTimer.value)
  }
  
  // ç§»é™¤é”®ç›˜ç›‘å¬
  window.removeEventListener('keydown', handleKeyDown)
  window.removeEventListener('keyup', handleKeyUp)
})
</script>

<style lang="scss" scoped>
.ptz-control-panel {
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  overflow: hidden;
  transition: all 0.3s;

  .panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    background: #f5f5f5;
    border-bottom: 1px solid #e8e8e8;
    cursor: pointer;
    user-select: none;

    h4 {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
    }
  }

  .panel-content {
    padding: 16px;
  }

  .direction-control {
    margin-bottom: 24px;

    .control-grid {
      .grid-row {
        display: flex;
        justify-content: center;
        gap: 4px;
        margin-bottom: 4px;

        .direction-btn {
          width: 40px;
          height: 40px;
          padding: 0;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: 4px;

          &.center-btn {
            background: #f0f0f0;
      
            &.active {
              background: #ff4d4f;
              color: white;
            }
          }

          &.diagonal {
            .arrow {
              width: 0;
              height: 0;
              border: 6px solid transparent;

              &.arrow-left-up {
                border-right-color: currentColor;
                border-bottom-color: currentColor;
                transform: rotate(-45deg);
              }

              &.arrow-right-up {
                border-left-color: currentColor;
                border-bottom-color: currentColor;
                transform: rotate(45deg);
              }

              &.arrow-left-down {
                border-right-color: currentColor;
                border-top-color: currentColor;
                transform: rotate(45deg);
              }

              &.arrow-right-down {
                border-left-color: currentColor;
                border-top-color: currentColor;
                transform: rotate(-45deg);
              }
            }
          }
        }
      }
    }

    .speed-control {
      margin-top: 16px;

      label {
        display: block;
        margin-bottom: 8px;
        font-size: 12px;
        color: #666;
      }
    }
  }

  .zoom-control,
  .focus-control,
  .iris-control {
    margin-bottom: 20px;

    .zoom-buttons,
    .focus-buttons,
    .iris-buttons {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;

      .zoom-btn,
      .focus-btn,
      .iris-btn {
        flex: 1;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
      }
    }

    .auto-focus-btn {
      width: 100%;
      height: 36px;
    }

    .zoom-speed {
      label {
        display: block;
        margin-bottom: 8px;
        font-size: 12px;
        color: #666;
      }
    }
  }

  .preset-control {
    .preset-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;

      h5 {
        margin: 0;
        font-size: 13px;
        font-weight: 600;
      }
    }

    .preset-list {
      max-height: 200px;
      overflow-y: auto;
      margin-bottom: 12px;

      .preset-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #f0f0f0;

        &:last-child {
          border-bottom: none;
        }

        .preset-name {
          font-size: 12px;
          flex: 1;
        }

        .preset-actions {
          display: flex;
          gap: 4px;

          .ant-btn {
            height: 24px;
            padding: 0 8px;
            font-size: 11px;
          }
        }
      }
    }

    .preset-add {
      margin-top: 12px;
    }
  }
}

.panel-expanded {
  .panel-content {
    animation: slideDown 0.3s ease-out;
  }
}

@keyframes slideDown {
  from {
    max-height: 0;
    opacity: 0;
  }
  to {
    max-height: 1000px;
    opacity: 1;
  }
}
</style>
```

## 8. éƒ¨ç½²é…ç½®ä¸åˆ†å·¥æ–¹æ¡ˆ

### 8.1 å¼€å‘ç¯å¢ƒé…ç½®

#### 8.1.1 Viteé…ç½®

```
// vite.config.ts
import { defineConfig, loadEnv } from 'vite'
import vue from '@vitejs/plugin-vue'
import { resolve } from 'path'
import { createSvgIconsPlugin } from 'vite-plugin-svg-icons'
import { viteMockPlugin } from 'vite-plugin-mock'

export default defineConfig(({ command, mode }) => {
  const env = loadEnv(mode, process.cwd(), '')
  const isBuild = command === 'build'

  return {
    plugins: [
      vue(),
  
      // SVGå›¾æ ‡æ’ä»¶
      createSvgIconsPlugin({
        iconDirs: [resolve(process.cwd(), 'src/assets/icons')],
        symbolId: 'icon-[dir]-[name]',
      }),
  
      // Mockæ’ä»¶
      viteMockPlugin({
        mockPath: 'mock',
        localEnabled: !isBuild,
        prodEnabled: false,
        injectCode: `
          import { setupProdMockServer } from './mockProdServer';
          setupProdMockServer();
        `,
      }),
    ],

    // è·¯å¾„åˆ«å
    resolve: {
      alias: {
        '@': resolve(__dirname, 'src'),
        '@components': resolve(__dirname, 'src/components'),
        '@views': resolve(__dirname, 'src/views'),
        '@assets': resolve(__dirname, 'src/assets'),
        '@utils': resolve(__dirname, 'src/utils'),
        '@api': resolve(__dirname, 'src/api'),
        '@stores': resolve(__dirname, 'src/stores'),
        '@types': resolve(__dirname, 'src/types'),
      },
    },

    // CSSé¢„å¤„ç†å™¨
    css: {
      preprocessorOptions: {
        scss: {
          additionalData: `
            @import "@/assets/styles/variables.scss";
            @import "@/assets/styles/mixins.scss";
          `,
        },
      },
    },

    // å¼€å‘æœåŠ¡å™¨é…ç½®
    server: {
      host: '0.0.0.0',
      port: 3000,
      open: true,
      cors: true,
      proxy: {
        '/api': {
          target: env.VITE_API_BASE_URL || 'http://localhost:8000',
          changeOrigin: true,
          rewrite: (path) => path.replace(/^\/api/, ''),
        },
        '/ws': {
          target: env.VITE_WS_BASE_URL || 'ws://localhost:8000',
          ws: true,
          changeOrigin: true,
        },
      },
    },

    // æ„å»ºé…ç½®
    build: {
      target: 'es2015',
      outDir: 'dist',
      assetsDir: 'assets',
      sourcemap: false,
      minify: 'terser',
      terserOptions: {
        compress: {
          drop_console: true,
          drop_debugger: true,
        },
      },
  
      // åˆ†åŒ…ç­–ç•¥
      rollupOptions: {
        output: {
          chunkFileNames: 'assets/js/[name]-[hash].js',
          entryFileNames: 'assets/js/[name]-[hash].js',
          assetFileNames: 'assets/[ext]/[name]-[hash].[ext]',
    
          manualChunks: {
            vue: ['vue', 'vue-router', 'pinia'],
            antd: ['ant-design-vue', '@ant-design/icons-vue'],
            vendor: ['axios', 'dayjs', 'lodash-es'],
            players: ['jessibuca'],
          },
        },
      },
  
      // åˆ†åŒ…å¤§å°è­¦å‘Šé˜ˆå€¼
      chunkSizeWarningLimit: 1500,
    },

    // é¢„æ„å»ºä¼˜åŒ–
    optimizeDeps: {
      include: [
        'vue',
        'vue-router',
        'pinia',
        'ant-design-vue',
        '@ant-design/icons-vue',
        'axios',
        'dayjs',
        'lodash-es',
      ],
    },

    // ç¯å¢ƒå˜é‡å‰ç¼€
    envPrefix: 'VITE_',
  }
})
```

#### 8.1.2 ç¯å¢ƒå˜é‡é…ç½®

bash

```
# .env.development - å¼€å‘ç¯å¢ƒ
VITE_APP_TITLE=GB28181è§†é¢‘å¹³å° - å¼€å‘ç¯å¢ƒ
VITE_APP_ENV=development
VITE_API_BASE_URL=http://localhost:8000
VITE_WS_BASE_URL=ws://localhost:8000
VITE_UPLOAD_URL=http://localhost:8000/upload
VITE_APP_VERSION=1.0.0-dev

# æ’­æ”¾å™¨é…ç½®
VITE_JESSIBUCA_DECODER_PATH=/players/jessibuca/decoder.wasm
VITE_H265WEB_DECODER_PATH=/players/h265web/h265web.wasm

# å¼€å‘é…ç½®
VITE_MOCK_ENABLED=true
VITE_DEBUG_ENABLED=true
VITE_DEVTOOLS_ENABLED=true
```

```
# .env.production - ç”Ÿäº§ç¯å¢ƒ
VITE_APP_TITLE=GB28181è§†é¢‘å¹³å°
VITE_APP_ENV=production
VITE_API_BASE_URL=
VITE_WS_BASE_URL=
VITE_UPLOAD_URL=/upload
VITE_APP_VERSION=1.0.0

# æ’­æ”¾å™¨é…ç½®
VITE_JESSIBUCA_DECODER_PATH=/players/jessibuca/decoder.wasm
VITE_H265WEB_DECODER_PATH=/players/h265web/h265web.wasm

# ç”Ÿäº§é…ç½®
VITE_MOCK_ENABLED=false
VITE_DEBUG_ENABLED=false
VITE_DEVTOOLS_ENABLED=false
```

### 8.2 Dockeréƒ¨ç½²é…ç½®

#### 8.2.1 Dockerfile

```
# docker/Dockerfile
# æ„å»ºé˜¶æ®µ
FROM node:18-alpine AS builder

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶packageæ–‡ä»¶
COPY package*.json ./
COPY pnpm-lock.yaml ./

# å®‰è£…pnpm
RUN npm install -g pnpm

# å®‰è£…ä¾èµ–
RUN pnpm install --frozen-lockfile

# å¤åˆ¶æºä»£ç 
COPY . .

# æ„å»ºåº”ç”¨
RUN pnpm build

# ç”Ÿäº§é˜¶æ®µ
FROM nginx:1.25-alpine

# å®‰è£…å¿…è¦å·¥å…·
RUN apk add --no-cache \
    curl \
    tzdata \
    && cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \
    && echo "Asia/Shanghai" > /etc/timezone

# å¤åˆ¶æ„å»ºäº§ç‰©
COPY --from=builder /app/dist /usr/share/nginx/html

# å¤åˆ¶Nginxé…ç½®
COPY docker/nginx.conf /etc/nginx/nginx.conf
COPY docker/default.conf /etc/nginx/conf.d/default.conf

# å¤åˆ¶å¯åŠ¨è„šæœ¬
COPY docker/docker-entrypoint.sh /docker-entrypoint.sh
RUN chmod +x /docker-entrypoint.sh

# åˆ›å»ºæ—¥å¿—ç›®å½•
RUN mkdir -p /var/log/nginx

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:80/ || exit 1

# æš´éœ²ç«¯å£
EXPOSE 80

# å¯åŠ¨å‘½ä»¤
ENTRYPOINT ["/docker-entrypoint.sh"]
CMD ["nginx", "-g", "daemon off;"]
```

#### 8.2.2 Nginxé…ç½®

```
# docker/nginx.conf
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log notice;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
    use epoll;
    multi_accept on;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # æ—¥å¿—æ ¼å¼
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    # åŸºç¡€è®¾ç½®
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    client_max_body_size 100M;

    # Gzipå‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml;

    # åŒ…å«ç«™ç‚¹é…ç½®
    include /etc/nginx/conf.d/*.conf;
}
```

```
nginx# docker/default.conf
server {
    listen 80;
    server_name localhost;
    root /usr/share/nginx/html;
    index index.html index.htm;

    # é”™è¯¯é¡µé¢
    error_page 404 /index.html;
    error_page 500 502 503 504 /50x.html;

    # ä¸»åº”ç”¨è·¯ç”±
    location / {
        try_files $uri $uri/ /index.html;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
    }

    # é™æ€èµ„æºç¼“å­˜
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header Vary Accept-Encoding;
        access_log off;
    }

    # æ’­æ”¾å™¨èµ„æº
    location /players/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header Access-Control-Allow-Origin "*";
        add_header Access-Control-Allow-Methods "GET, OPTIONS";
        add_header Access-Control-Allow-Headers "Range";
    }

    # APIä»£ç†
    location /api/ {
        proxy_pass http://gb28181-core:8000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # WebSocketä»£ç†
    location /ws {
        proxy_pass http://gb28181-core:8000/ws;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 86400s;
    }

    # å¥åº·æ£€æŸ¥
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # å®‰å…¨å¤´
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;
}
```

#### 8.2.3 Dockerå¯åŠ¨è„šæœ¬

bash

```
#!/bin/sh
# docker/docker-entrypoint.sh

set -e

# ç¯å¢ƒå˜é‡æ›¿æ¢å‡½æ•°
envsubst_file() {
    local file="$1"
    local temp_file="${file}.tmp"
  
    envsubst < "$file" > "$temp_file"
    mv "$temp_file" "$file"
}

# æ›¿æ¢é…ç½®æ–‡ä»¶ä¸­çš„ç¯å¢ƒå˜é‡
if [ -f "/usr/share/nginx/html/config/app.config.js" ]; then
    echo "æ­£åœ¨æ›´æ–°åº”ç”¨é…ç½®..."
    envsubst_file "/usr/share/nginx/html/config/app.config.js"
fi

# åˆ›å»ºè¿è¡Œæ—¶é…ç½®
cat > /usr/share/nginx/html/config/runtime.config.js << EOF
window.APP_CONFIG = {
  apiBaseUrl: '${API_BASE_URL:-/api}',
  wsBaseUrl: '${WS_BASE_URL:-/ws}',
  uploadUrl: '${UPLOAD_URL:-/upload}',
  title: '${APP_TITLE:-GB28181è§†é¢‘å¹³å°}',
  version: '${APP_VERSION:-1.0.0}',
  env: '${APP_ENV:-production}',
  
  // æ’­æ”¾å™¨é…ç½®
  jessibucaDecoder: '${JESSIBUCA_DECODER_PATH:-/players/jessibuca/decoder.wasm}',
  h265webDecoder: '${H265WEB_DECODER_PATH:-/players/h265web/h265web.wasm}',
  
  // åŠŸèƒ½å¼€å…³
  debugEnabled: ${DEBUG_ENABLED:-false},
  mockEnabled: false
};
EOF

echo "é…ç½®æ–‡ä»¶å·²ç”Ÿæˆ"

# æ‰§è¡Œä¼ å…¥çš„å‘½ä»¤
exec "$@"
```

#### 8.2.4 Docker Composeé›†æˆ

yaml

```
# docker-compose.yml (å‰ç«¯éƒ¨åˆ†)
version: '3.8'

services:
  # å‰ç«¯åº”ç”¨
  frontend:
    build:
      context: ./web-frontend
      dockerfile: docker/Dockerfile
    container_name: gb28181-frontend
    environment:
      - API_BASE_URL=/api
      - WS_BASE_URL=/ws
      - UPLOAD_URL=/upload
      - APP_TITLE=GB28181è§†é¢‘å¹³å°
      - APP_VERSION=1.0.0
      - APP_ENV=production
      - JESSIBUCA_DECODER_PATH=/players/jessibuca/decoder.wasm
      - H265WEB_DECODER_PATH=/players/h265web/h265web.wasm
      - DEBUG_ENABLED=false
    ports:
      - "80:80"
    volumes:
      - ./web-frontend/public/players:/usr/share/nginx/html/players:ro
      - ./logs/nginx:/var/log/nginx
    depends_on:
      core-service:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - gb28181-network

networks:
  gb28181-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
```

### 8.3 æ„å»ºä¸éƒ¨ç½²æµç¨‹

#### 8.3.1 è‡ªåŠ¨åŒ–æ„å»ºè„šæœ¬

```
#!/bin/bash
# scripts/build.sh - æ„å»ºè„šæœ¬

set -e

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# æ‰“å°å¸¦é¢œè‰²çš„æ—¥å¿—
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# æ£€æŸ¥ç¯å¢ƒ
check_environment() {
    log_info "æ£€æŸ¥æ„å»ºç¯å¢ƒ..."
  
    # æ£€æŸ¥Node.jsç‰ˆæœ¬
    if ! command -v node &> /dev/null; then
        log_error "Node.jsæœªå®‰è£…"
        exit 1
    fi
  
    NODE_VERSION=$(node --version | cut -d'v' -f2 | cut -d'.' -f1)
    if [ "$NODE_VERSION" -lt 16 ]; then
        log_error "Node.jsç‰ˆæœ¬è¿‡ä½ï¼Œéœ€è¦v16+ï¼Œå½“å‰ç‰ˆæœ¬: $(node --version)"
        exit 1
    fi
  
    # æ£€æŸ¥pnpmç‰ˆæœ¬
    if ! command -v pnpm &> /dev/null; then
        log_warn "pnpmæœªå®‰è£…ï¼Œæ­£åœ¨å®‰è£…..."
        npm install -g pnpm
    fi
  
    log_info "ç¯å¢ƒæ£€æŸ¥é€šè¿‡"
}

# å®‰è£…ä¾èµ–
install_dependencies() {
    log_info "å®‰è£…é¡¹ç›®ä¾èµ–..."
  
    if [ ! -f "pnpm-lock.yaml" ]; then
        log_warn "pnpm-lock.yamlä¸å­˜åœ¨ï¼Œæ‰§è¡Œå®Œæ•´å®‰è£…"
        pnpm install
    else
        pnpm install --frozen-lockfile
    fi
  
    log_info "ä¾èµ–å®‰è£…å®Œæˆ"
}

# ä»£ç æ£€æŸ¥
code_check() {
    log_info "æ‰§è¡Œä»£ç æ£€æŸ¥..."
  
    # TypeScriptç±»å‹æ£€æŸ¥
    log_info "TypeScriptç±»å‹æ£€æŸ¥..."
    pnpm run type-check
  
    # ESLintæ£€æŸ¥
    log_info "ESLintä»£ç æ£€æŸ¥..."
    pnpm run lint
  
    # å•å…ƒæµ‹è¯•
    if [ -d "src/__tests__" ]; then
        log_info "è¿è¡Œå•å…ƒæµ‹è¯•..."
        pnpm run test:unit
    fi
  
    log_info "ä»£ç æ£€æŸ¥å®Œæˆ"
}

# æ„å»ºåº”ç”¨
build_app() {
    local env=${1:-production}
  
    log_info "æ„å»ºåº”ç”¨ (ç¯å¢ƒ: $env)..."
  
    # æ¸…ç†æ—§çš„æ„å»ºäº§ç‰©
    rm -rf dist
  
    # è®¾ç½®æ„å»ºç¯å¢ƒ
    export NODE_ENV=$env
  
    # æ‰§è¡Œæ„å»º
    pnpm run build
  
    # æ£€æŸ¥æ„å»ºäº§ç‰©
    if [ ! -d "dist" ]; then
        log_error "æ„å»ºå¤±è´¥ï¼Œdistç›®å½•ä¸å­˜åœ¨"
        exit 1
    fi
  
    log_info "åº”ç”¨æ„å»ºå®Œæˆ"
}

# æ„å»ºåˆ†æ
build_analysis() {
    log_info "æ‰§è¡Œæ„å»ºåˆ†æ..."
  
    # åŒ…å¤§å°åˆ†æ
    pnpm run build:analyze
  
    # ç”Ÿæˆæ„å»ºæŠ¥å‘Š
    cat > dist/build-info.json << EOF
{
  "buildTime": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
  "version": "$(node -p "require('./package.json').version")",
  "commit": "$(git rev-parse HEAD 2>/dev/null || echo 'unknown')",
  "branch": "$(git branch --show-current 2>/dev/null || echo 'unknown')",
  "nodeVersion": "$(node --version)",
  "environment": "${NODE_ENV:-production}"
}
EOF
  
    log_info "æ„å»ºåˆ†æå®Œæˆ"
}

# ä¸»å‡½æ•°
main() {
    local env=${1:-production}
    local skip_checks=${2:-false}
  
    log_info "å¼€å§‹æ„å»ºå‰ç«¯åº”ç”¨..."
    log_info "æ„å»ºç¯å¢ƒ: $env"
  
    # æ£€æŸ¥ç¯å¢ƒ
    check_environment
  
    # å®‰è£…ä¾èµ–
    install_dependencies
  
    # ä»£ç æ£€æŸ¥ï¼ˆå¯è·³è¿‡ï¼‰
    if [ "$skip_checks" != "true" ]; then
        code_check
    fi
  
    # æ„å»ºåº”ç”¨
    build_app "$env"
  
    # æ„å»ºåˆ†æ
    build_analysis
  
    log_info "å‰ç«¯åº”ç”¨æ„å»ºå®Œæˆï¼"
    log_info "æ„å»ºäº§ç‰©ä½ç½®: $(pwd)/dist"
}

# æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
show_help() {
    echo "ç”¨æ³•: $0 [ç¯å¢ƒ] [é€‰é¡¹]"
    echo ""
    echo "ç¯å¢ƒ:"
    echo "  development  å¼€å‘ç¯å¢ƒæ„å»º"
    echo "  production   ç”Ÿäº§ç¯å¢ƒæ„å»º (é»˜è®¤)"
    echo ""
    echo "é€‰é¡¹:"
    echo "  --skip-checks  è·³è¿‡ä»£ç æ£€æŸ¥"
    echo "  --help         æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯"
    echo ""
    echo "ç¤ºä¾‹:"
    echo "  $0                      # ç”Ÿäº§ç¯å¢ƒæ„å»º"
    echo "  $0 development          # å¼€å‘ç¯å¢ƒæ„å»º"
    echo "  $0 production --skip-checks  # ç”Ÿäº§ç¯å¢ƒæ„å»ºï¼Œè·³è¿‡æ£€æŸ¥"
}

# å¤„ç†å‘½ä»¤è¡Œå‚æ•°
case "$1" in
    --help|-h)
        show_help
        exit 0
        ;;
    development|production)
        main "$1" "$2"
        ;;
    "")
        main "production" "$1"
        ;;
    *)
        log_error "æ— æ•ˆçš„ç¯å¢ƒ: $1"
        show_help
        exit 1
        ;;
esac
```

#### 8.3.2 éƒ¨ç½²è„šæœ¬

bash

```
#!/bin/bash
# scripts/deploy.sh - éƒ¨ç½²è„šæœ¬

set -e

# é…ç½®
DOCKER_REGISTRY="${DOCKER_REGISTRY:-}"
IMAGE_NAME="${IMAGE_NAME:-gb28181-frontend}"
IMAGE_TAG="${IMAGE_TAG:-latest}"
DEPLOY_ENV="${DEPLOY_ENV:-production}"

# æ—¥å¿—å‡½æ•°
log_info() {
    echo -e "\033[0;32m[INFO]\033[0m $1"
}

log_warn() {
    echo -e "\033[1;33m[WARN]\033[0m $1"
}

log_error() {
    echo -e "\033[0;31m[ERROR]\033[0m $1"
}

# æ„å»ºDockeré•œåƒ
build_image() {
    log_info "æ„å»ºDockeré•œåƒ..."
  
    local full_image_name="$IMAGE_NAME:$IMAGE_TAG"
    if [ -n "$DOCKER_REGISTRY" ]; then
        full_image_name="$DOCKER_REGISTRY/$full_image_name"
    fi
  
    docker build \
        -f docker/Dockerfile \
        -t "$full_image_name" \
        --build-arg BUILD_ENV="$DEPLOY_ENV" \
        .
  
    log_info "Dockeré•œåƒæ„å»ºå®Œæˆ: $full_image_name"
}

# æ¨é€é•œåƒ
push_image() {
    if [ -z "$DOCKER_REGISTRY" ]; then
        log_warn "æœªé…ç½®Docker registryï¼Œè·³è¿‡é•œåƒæ¨é€"
        return
    fi
  
    log_info "æ¨é€Dockeré•œåƒåˆ°registry..."
  
    local full_image_name="$DOCKER_REGISTRY/$IMAGE_NAME:$IMAGE_TAG"
    docker push "$full_image_name"
  
    log_info "é•œåƒæ¨é€å®Œæˆ"
}

# éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
deploy_staging() {
    log_info "éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ..."
  
    # æ›´æ–°docker-composeæ–‡ä»¶
    export IMAGE_TAG
    envsubst < docker-compose.staging.yml.template > docker-compose.staging.yml
  
    # å¯åŠ¨æœåŠ¡
    docker-compose -f docker-compose.staging.yml down
    docker-compose -f docker-compose.staging.yml up -d
  
    # ç­‰å¾…æœåŠ¡å¯åŠ¨
    sleep 30
  
    # å¥åº·æ£€æŸ¥
    if curl -f http://localhost:8080/health > /dev/null 2>&1; then
        log_info "æµ‹è¯•ç¯å¢ƒéƒ¨ç½²æˆåŠŸ"
    else
        log_error "æµ‹è¯•ç¯å¢ƒéƒ¨ç½²å¤±è´¥"
        exit 1
    fi
}

# éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
deploy_production() {
    log_info "éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ..."
  
    # å®‰å…¨ç¡®è®¤
    read -p "ç¡®å®šè¦éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒå—? [y/N] " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        log_info "éƒ¨ç½²å·²å–æ¶ˆ"
        exit 0
    fi
  
    # å¤‡ä»½å½“å‰ç‰ˆæœ¬
    log_info "å¤‡ä»½å½“å‰ç‰ˆæœ¬..."
    docker tag "$IMAGE_NAME:latest" "$IMAGE_NAME:backup-$(date +%Y%m%d-%H%M%S)" || true
  
    # æ›´æ–°æœåŠ¡
    export IMAGE_TAG
    envsubst < docker-compose.production.yml.template > docker-compose.production.yml
  
    # æ»šåŠ¨æ›´æ–°
    docker-compose -f docker-compose.production.yml up -d --no-deps frontend
  
    # ç­‰å¾…æœåŠ¡å¯åŠ¨
    sleep 60
  
    # å¥åº·æ£€æŸ¥
    local retry_count=0
    local max_retries=10
  
    while [ $retry_count -lt $max_retries ]; do
        if curl -f http://localhost/health > /dev/null 2>&1; then
            log_info "ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æˆåŠŸ"
            return 0
        fi
  
        retry_count=$((retry_count + 1))
        log_warn "å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œé‡è¯• $retry_count/$max_retries"
        sleep 10
    done
  
    log_error "ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å¤±è´¥"
  
    # å›æ»š
    log_info "æ‰§è¡Œå›æ»š..."
    docker-compose -f docker-compose.production.yml down
    docker tag "$IMAGE_NAME:backup-$(date +%Y%m%d)" "$IMAGE_NAME:latest" || true
    docker-compose -f docker-compose.production.yml up -d --no-deps frontend
  
    exit 1
}

# æ¸…ç†æ—§é•œåƒ
cleanup_images() {
    log_info "æ¸…ç†æ—§çš„Dockeré•œåƒ..."
  
    # åˆ é™¤æœªä½¿ç”¨çš„é•œåƒ
    docker image prune -f
  
    # ä¿ç•™æœ€è¿‘çš„5ä¸ªç‰ˆæœ¬
    docker images "$IMAGE_NAME" --format "table {{.Tag}}\t{{.CreatedAt}}" | \
        tail -n +2 | sort -k2 -r | tail -n +6 | awk '{print $1}' | \
        xargs -I {} docker rmi "$IMAGE_NAME:{}" 2>/dev/null || true
  
    log_info "é•œåƒæ¸…ç†å®Œæˆ"
}

# ä¸»å‡½æ•°
main() {
    local action=${1:-build}
  
    case "$action" in
        build)
            build_image
            ;;
        push)
            build_image
            push_image
            ;;
        staging)
            build_image
            deploy_staging
            ;;
        production)
            build_image
            push_image
            deploy_production
            ;;
        cleanup)
            cleanup_images
            ;;
        *)
            echo "ç”¨æ³•: $0 {build|push|staging|production|cleanup}"
            echo ""
            echo "å‘½ä»¤è¯´æ˜:"
            echo "  build      - æ„å»ºDockeré•œåƒ"
            echo "  push       - æ„å»ºå¹¶æ¨é€é•œåƒ"
            echo "  staging    - éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ"
            echo "  production - éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ"
            echo "  cleanup    - æ¸…ç†æ—§é•œåƒ"
            exit 1
            ;;
    esac
}

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"
```

### 8.4 å›¢é˜Ÿåˆ†å·¥æ–¹æ¡ˆ

#### 8.4.1 å¼€å‘å›¢é˜Ÿç»“æ„

```
graph TD
    A[å‰ç«¯æŠ€æœ¯è´Ÿè´£äºº] --> B[UI/UXå¼€å‘å·¥ç¨‹å¸ˆ]
    A --> C[æ ¸å¿ƒåŠŸèƒ½å¼€å‘å·¥ç¨‹å¸ˆ]
    A --> D[æ’­æ”¾å™¨ä¸“é¡¹å·¥ç¨‹å¸ˆ]
    A --> E[æµ‹è¯•å·¥ç¨‹å¸ˆ]
    A --> F[DevOpså·¥ç¨‹å¸ˆ]
  
    B --> B1[é¡µé¢å¸ƒå±€ä¸æ ·å¼]
    B --> B2[ç»„ä»¶åº“ç»´æŠ¤]
    B --> B3[ç”¨æˆ·ä½“éªŒä¼˜åŒ–]
  
    C --> C1[ä¸šåŠ¡é€»è¾‘å¼€å‘]
    C --> C2[çŠ¶æ€ç®¡ç†]
    C --> C3[APIé›†æˆ]
  
    D --> D1[æ’­æ”¾å™¨é›†æˆ]
    D --> D2[æµåª’ä½“å¤„ç†]
    D --> D3[æ€§èƒ½ä¼˜åŒ–]
  
    E --> E1[åŠŸèƒ½æµ‹è¯•]
    E --> E2[å…¼å®¹æ€§æµ‹è¯•]
    E --> E3[æ€§èƒ½æµ‹è¯•]
  
    F --> F1[æ„å»ºéƒ¨ç½²]
    F --> F2[ç›‘æ§è¿ç»´]
    F --> F3[ç¯å¢ƒç®¡ç†]
```

8.4.2 è¯¦ç»†åˆ†å·¥è¡¨

| è§’è‰²               | ä¸»è¦èŒè´£                         | æŠ€èƒ½è¦æ±‚                       | å·¥ä½œå†…å®¹                                                            |
| ------------------ | -------------------------------- | ------------------------------ | ------------------------------------------------------------------- |
| å‰ç«¯æŠ€æœ¯è´Ÿè´£äºº     | æŠ€æœ¯æ¶æ„è®¾è®¡ã€å›¢é˜Ÿç®¡ç†ã€ä»£ç å®¡æŸ¥ | Vue3ç”Ÿæ€ã€é¡¹ç›®ç®¡ç†ã€æ¶æ„è®¾è®¡   | â€¢ æŠ€æœ¯æ–¹æ¡ˆåˆ¶å®š ``â€¢ ä»£ç è§„èŒƒåˆ¶å®š``â€¢ å›¢é˜Ÿåè°ƒ``â€¢ æŠ€æœ¯é£é™©æ§åˆ¶     |
| UI/UXå¼€å‘å·¥ç¨‹å¸ˆ    | ç”¨æˆ·ç•Œé¢å¼€å‘ã€ç”¨æˆ·ä½“éªŒä¼˜åŒ–       | Vue3ã€CSS3ã€è®¾è®¡èƒ½åŠ›           | â€¢ é¡µé¢å¸ƒå±€å®ç° ``â€¢ ç»„ä»¶æ ·å¼å¼€å‘``â€¢ å“åº”å¼é€‚é…``â€¢ äº¤äº’æ•ˆæœå®ç°   |
| æ ¸å¿ƒåŠŸèƒ½å¼€å‘å·¥ç¨‹å¸ˆ | ä¸šåŠ¡é€»è¾‘å®ç°ã€æ•°æ®å¤„ç†           | Vue3ã€TypeScriptã€ä¸šåŠ¡ç†è§£     | â€¢ è®¾å¤‡ç®¡ç†æ¨¡å— ``â€¢ ç”¨æˆ·æƒé™æ¨¡å—``â€¢ ç³»ç»Ÿé…ç½®æ¨¡å—``â€¢ ä¸šåŠ¡æµç¨‹å®ç° |
| æ’­æ”¾å™¨ä¸“é¡¹å·¥ç¨‹å¸ˆ   | è§†é¢‘æ’­æ”¾ã€æµåª’ä½“å¤„ç†             | æµåª’ä½“æŠ€æœ¯ã€WebRTCã€æ€§èƒ½ä¼˜åŒ–   | â€¢ æ’­æ”¾å™¨é›†æˆ ``â€¢ æµåª’ä½“é€‚é…``â€¢ äº‘å°æ§åˆ¶``â€¢ å½•åƒå›æ”¾åŠŸèƒ½         |
| æµ‹è¯•å·¥ç¨‹å¸ˆ         | è´¨é‡ä¿è¯ã€æµ‹è¯•ç”¨ä¾‹è®¾è®¡           | æµ‹è¯•æ–¹æ³•ã€è‡ªåŠ¨åŒ–æµ‹è¯•ã€æ€§èƒ½æµ‹è¯• | â€¢ åŠŸèƒ½æµ‹è¯• ``â€¢ å…¼å®¹æ€§æµ‹è¯•``â€¢ æ€§èƒ½æµ‹è¯•``â€¢ è‡ªåŠ¨åŒ–æµ‹è¯•             |
| DevOpså·¥ç¨‹å¸ˆ       | æ„å»ºéƒ¨ç½²ã€è¿ç»´ç›‘æ§               | Dockerã€CI/CDã€è¿ç»´å·¥å…·        | â€¢ æ„å»ºæµæ°´çº¿ ``â€¢ éƒ¨ç½²è‡ªåŠ¨åŒ–``â€¢ ç›‘æ§å‘Šè­¦``â€¢ ç¯å¢ƒç®¡ç†             |

#### 8.4.3 å¼€å‘é˜¶æ®µåˆ’åˆ†

ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€æ¶æ„æ­å»ºï¼ˆ1-2å‘¨ï¼‰* å‰ç«¯æŠ€æœ¯è´Ÿè´£äººï¼šé¡¹ç›®åˆå§‹åŒ–ã€æ¶æ„è®¾è®¡

* DevOpså·¥ç¨‹å¸ˆï¼šå¼€å‘ç¯å¢ƒæ­å»ºã€CI/CDé…ç½®
* UI/UXå¼€å‘å·¥ç¨‹å¸ˆï¼šè®¾è®¡è§„èŒƒåˆ¶å®šã€åŸºç¡€ç»„ä»¶å¼€å‘

ç¬¬äºŒé˜¶æ®µï¼šæ ¸å¿ƒåŠŸèƒ½å¼€å‘ï¼ˆ3-5å‘¨ï¼‰* æ ¸å¿ƒåŠŸèƒ½å¼€å‘å·¥ç¨‹å¸ˆï¼šè®¾å¤‡ç®¡ç†ã€ç”¨æˆ·ç®¡ç†æ¨¡å—

* æ’­æ”¾å™¨ä¸“é¡¹å·¥ç¨‹å¸ˆï¼šæ’­æ”¾å™¨é›†æˆã€åŸºç¡€æ’­æ”¾åŠŸèƒ½
* UI/UXå¼€å‘å·¥ç¨‹å¸ˆï¼šé¡µé¢å¸ƒå±€ã€ç»„ä»¶å®Œå–„

ç¬¬ä¸‰é˜¶æ®µï¼šé«˜çº§åŠŸèƒ½å¼€å‘ï¼ˆ2-3å‘¨ï¼‰* æ’­æ”¾å™¨ä¸“é¡¹å·¥ç¨‹å¸ˆï¼šäº‘å°æ§åˆ¶ã€å½•åƒå›æ”¾

* æ ¸å¿ƒåŠŸèƒ½å¼€å‘å·¥ç¨‹å¸ˆï¼šæƒé™ç®¡ç†ã€ç³»ç»Ÿé…ç½®
* æµ‹è¯•å·¥ç¨‹å¸ˆï¼šåŠŸèƒ½æµ‹è¯•ã€ç¼ºé™·ä¿®å¤

ç¬¬å››é˜¶æ®µï¼šä¼˜åŒ–ä¸æµ‹è¯•ï¼ˆ1-2å‘¨ï¼‰* å…¨å‘˜ï¼šæ€§èƒ½ä¼˜åŒ–ã€å…¼å®¹æ€§æµ‹è¯•

* æµ‹è¯•å·¥ç¨‹å¸ˆï¼šå…¨é¢æµ‹è¯•ã€å‹åŠ›æµ‹è¯•
* DevOpså·¥ç¨‹å¸ˆï¼šéƒ¨ç½²ä¼˜åŒ–ã€ç›‘æ§å®Œå–„

#### 8.4.4 ä»£ç åˆ†å·¥ç¤ºä¾‹

graph TD
A[å‰ç«¯æŠ€æœ¯è´Ÿè´£äºº] --> B[UI/UXå¼€å‘å·¥ç¨‹å¸ˆ]
A --> C[æ ¸å¿ƒåŠŸèƒ½å¼€å‘å·¥ç¨‹å¸ˆ]
A --> D[æ’­æ”¾å™¨ä¸“é¡¹å·¥ç¨‹å¸ˆ]
A --> E[æµ‹è¯•å·¥ç¨‹å¸ˆ]
A --> F[DevOpså·¥ç¨‹å¸ˆ]

```
B --> B1[é¡µé¢å¸ƒå±€ä¸æ ·å¼]
B --> B2[ç»„ä»¶åº“ç»´æŠ¤]
B --> B3[ç”¨æˆ·ä½“éªŒä¼˜åŒ–]

C --> C1[ä¸šåŠ¡é€»è¾‘å¼€å‘]
C --> C2[çŠ¶æ€ç®¡ç†]
C --> C3[APIé›†æˆ]

D --> D1[æ’­æ”¾å™¨é›†æˆ]
D --> D2[æµåª’ä½“å¤„ç†]
D --> D3[æ€§èƒ½ä¼˜åŒ–]

E --> E1[åŠŸèƒ½æµ‹è¯•]
E --> E2[å…¼å®¹æ€§æµ‹è¯•]
E --> E3[æ€§èƒ½æµ‹è¯•]

F --> F1[æ„å»ºéƒ¨ç½²]
F --> F2[ç›‘æ§è¿ç»´]
F --> F3[ç¯å¢ƒç®¡ç†]
```

#### 8.4.5 åä½œæµç¨‹è§„èŒƒ

ä»£ç æäº¤æµç¨‹ï¼š1. ä»mainåˆ†æ”¯åˆ›å»ºåŠŸèƒ½åˆ†æ”¯ï¼šfeature/æ¨¡å—å-åŠŸèƒ½æè¿°

1. æœ¬åœ°å®Œæˆå¼€å‘å’Œè‡ªæµ‹
2. æäº¤PRï¼ŒæŒ‡å®šå¯¹åº”æ¨¡å—è´Ÿè´£äººå®¡æŸ¥
3. ä»£ç å®¡æŸ¥é€šè¿‡ååˆå¹¶åˆ°developåˆ†æ”¯
4. æµ‹è¯•é€šè¿‡ååˆå¹¶åˆ°mainåˆ†æ”¯

å‘½åè§„èŒƒï¼š* åˆ†æ”¯ï¼šfeature/device-managementã€bugfix/login-error

* æäº¤ï¼šfeat(device): æ·»åŠ è®¾å¤‡åˆ—è¡¨åŠŸèƒ½ã€fix(player): ä¿®å¤æ’­æ”¾å™¨å†…å­˜æ³„æ¼
* PRï¼š[è®¾å¤‡ç®¡ç†] æ·»åŠ è®¾å¤‡CRUDåŠŸèƒ½

æ¯æ—¥åä½œï¼š* æ™¨ä¼šï¼šå„æ¨¡å—è¿›åº¦åŒæ­¥ã€é—®é¢˜è®¨è®º

* ä»£ç å®¡æŸ¥ï¼šæ¯æ—¥è‡³å°‘è¿›è¡Œä¸€æ¬¡ä»£ç å®¡æŸ¥
* é›†æˆæµ‹è¯•ï¼šæ¯æ—¥æ„å»ºå’Œé›†æˆæµ‹è¯•
* é—®é¢˜è·Ÿè¸ªï¼šä½¿ç”¨Issueè·Ÿè¸ªBugå’Œä»»åŠ¡

## 9. å‰ç«¯è®¾è®¡æ–¹æ¡ˆæ€»ç»“

### 9.1 è®¾è®¡æ–¹æ¡ˆæ€»è§ˆ

ğŸ‰ æ­å–œï¼GB28181è§†é¢‘å¹³å°å‰ç«¯è¯¦ç»†è®¾è®¡æ–¹æ¡ˆå·²å®Œæˆï¼

æˆ‘ä»¬æˆåŠŸè®¾è®¡äº†ä¸€ä¸ªå®Œæ•´çš„ã€ç”Ÿäº§å°±ç»ªçš„å‰ç«¯è§£å†³æ–¹æ¡ˆï¼Œå®Œå…¨ç¬¦åˆéœ€æ±‚æ–‡æ¡£ä¸­çš„æ‰€æœ‰è¦æ±‚ï¼š

âœ… æŠ€æœ¯æ ˆå¯¹é½: Vue3 + TypeScript + Vite + Pinia + Ant Design Vue

âœ… æ’­æ”¾å™¨é›†æˆ: Jessibuca + H265Web.js åŒæ’­æ”¾å™¨è‡ªåŠ¨åˆ‡æ¢æ–¹æ¡ˆ

âœ… è½»é‡åŒ–æ¶æ„: å•é¡µåº”ç”¨ + Dockerå®¹å™¨åŒ–éƒ¨ç½²

âœ… åŠŸèƒ½å®Œæ•´æ€§: è¦†ç›–è®¾å¤‡ç®¡ç†ã€å®æ—¶ç›‘æ§ã€å½•åƒå›æ”¾ã€äº‘å°æ§åˆ¶ã€ç”¨æˆ·æƒé™ç­‰æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½

âœ… å¯æ‰©å±•æ€§: æ’ä»¶åŒ–æ¶æ„è®¾è®¡ï¼Œæ”¯æŒäºŒæ¬¡å¼€å‘

âœ… ç”Ÿäº§å°±ç»ª: å®Œæ•´çš„æ„å»ºã€éƒ¨ç½²ã€ç›‘æ§æ–¹æ¡ˆ

### 9.2 æ ¸å¿ƒæŠ€æœ¯äº®ç‚¹

#### 9.2.1 æ™ºèƒ½æ’­æ”¾å™¨ç³»ç»Ÿ

typescript

```
// è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜æ’­æ”¾å™¨
const playerType = streamInfo.codec === 'h265' ? 'h265web' : 'jessibuca'
await initPlayer(playerType)

// å¤šåè®®æµåœ°å€æ”¯æŒ
const streamUrl = getStreamUrl(streamInfo, playerType)
// H265 â†’ HLS, H264 â†’ WebSocket-FLV
```

#### 9.2.2 é«˜æ€§èƒ½çŠ¶æ€ç®¡ç†

typescript

```
// åˆ†æ¨¡å— Pinia Store + æ™ºèƒ½ç¼“å­˜
const deviceMap = new Map<string, Device>() // O(1)æŸ¥æ‰¾
const streamProfiles = new Map<string, StreamProfile>() // æµä¿¡æ¯ç¼“å­˜
```

#### 9.2.3 å®æ—¶é€šä¿¡æ¶æ„

typescript

```
// WebSocket + è‡ªåŠ¨é‡è¿ + äº‹ä»¶åˆ†å‘
wsClient.subscribe('device-online', handleDeviceOnline)
wsClient.subscribe('stream-start', handleStreamStart)
```

#### 9.2.4 ä¼ä¸šçº§é”™è¯¯å¤„ç†

typescript

```
// å…¨å±€é”™è¯¯æ•è· + è‡ªåŠ¨ä¸ŠæŠ¥ + ç”¨æˆ·å‹å¥½æç¤º
errorHandler.handleVueError(error, instance, info)
errorHandler.handleApiError(error, context)
```

9.3 æ¶æ„ä¼˜åŠ¿åˆ†æ

| è®¾è®¡ç»´åº¦   | ä¼ ç»Ÿæ–¹æ¡ˆ      | æˆ‘ä»¬çš„æ–¹æ¡ˆ          | ä¼˜åŠ¿                  |
| ---------- | ------------- | ------------------- | --------------------- |
| æ’­æ”¾å™¨é€‰æ‹© | å•ä¸€æ’­æ”¾å™¨    | åŒæ’­æ”¾å™¨è‡ªåŠ¨åˆ‡æ¢    | æ”¯æŒH264/H265æ— ç¼åˆ‡æ¢ |
| çŠ¶æ€ç®¡ç†   | Vuexå¤æ‚é…ç½®  | Pinia + åˆ†æ¨¡å—è®¾è®¡  | ç±»å‹å®‰å…¨ + ç®€åŒ–å¼€å‘   |
| ç¼“å­˜ç­–ç•¥   | åŸºç¡€ç¼“å­˜      | å¤šçº§ç¼“å­˜ + æ™ºèƒ½æ›´æ–° | æ€§èƒ½æå‡50%+          |
| é”™è¯¯å¤„ç†   | åŸºç¡€try-catch | å…¨å±€é”™è¯¯å¤„ç†ç³»ç»Ÿ    | ç”¨æˆ·ä½“éªŒ + é—®é¢˜è¿½è¸ª   |
| éƒ¨ç½²æ–¹å¼   | ä¼ ç»Ÿéƒ¨ç½²      | Docker + è‡ªåŠ¨åŒ–     | ä¸€é”®éƒ¨ç½² + ç¯å¢ƒä¸€è‡´æ€§ |
| å›¢é˜Ÿåä½œ   | ç®€å•åˆ†å·¥      | æ¨¡å—åŒ– + æµç¨‹è§„èŒƒ   | æå‡å¼€å‘æ•ˆç‡30%+      |

### 9.4 å…³é”®æ–‡ä»¶æ¸…å•

#### 9.4.1 æ ¸å¿ƒç»„ä»¶

* src/components/business/VideoPlayer/index.vue - æ™ºèƒ½æ’­æ”¾å™¨ç»„ä»¶
* src/components/business/DeviceTree/index.vue - è®¾å¤‡æ ‘ç»„ä»¶
* src/components/business/PTZControl/index.vue - äº‘å°æ§åˆ¶ç»„ä»¶
* src/components/common/AppHeader/index.vue - åº”ç”¨å¤´éƒ¨
* src/components/common/AppSidebar/index.vue - ä¾§è¾¹æ å¯¼èˆª

#### 9.4.2 çŠ¶æ€ç®¡ç†

* src/stores/modules/user.ts - ç”¨æˆ·çŠ¶æ€ç®¡ç†
* src/stores/modules/device.ts - è®¾å¤‡çŠ¶æ€ç®¡ç†
* src/stores/modules/stream.ts - æµåª’ä½“çŠ¶æ€ç®¡ç†

#### 9.4.3 APIä¸é€šä¿¡

* src/api/request.ts - HTTPå®¢æˆ·ç«¯å°è£…
* src/api/websocket.ts - WebSocketå®¢æˆ·ç«¯
* src/api/modules/device.ts - è®¾å¤‡API
* src/api/modules/stream.ts - æµåª’ä½“API

#### 9.4.4 å·¥å…·ä¸é…ç½®

* src/composables/usePlayer.ts - æ’­æ”¾å™¨ç®¡ç†Hook
* src/composables/useWebSocket.ts - WebSocketç®¡ç†Hook
* vite.config.ts - æ„å»ºé…ç½®
* docker/Dockerfile - Dockeré…ç½®

### 9.5 å®æ–½å»ºè®®

#### 9.5.1 å¼€å‘ä¼˜å…ˆçº§

1. P0ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰ï¼šç”¨æˆ·ç™»å½•ã€è®¾å¤‡ç®¡ç†ã€è§†é¢‘æ’­æ”¾
2. P1ï¼ˆé‡è¦åŠŸèƒ½ï¼‰ï¼šäº‘å°æ§åˆ¶ã€å½•åƒå›æ”¾ã€å®æ—¶ç›‘æ§
3. P2ï¼ˆå¢å¼ºåŠŸèƒ½ï¼‰ï¼šå¤šç”»é¢ã€æƒé™ç®¡ç†ã€ç³»ç»Ÿé…ç½®

#### 9.5.2 å¼€å‘é‡Œç¨‹ç¢‘

* Week 1-2: åŸºç¡€æ¶æ„ + æ ¸å¿ƒç»„ä»¶å¼€å‘
* Week 3-4: è®¾å¤‡ç®¡ç† + æ’­æ”¾å™¨é›†æˆ
* Week 5-6: äº‘å°æ§åˆ¶ + å½•åƒåŠŸèƒ½
* Week 7-8: ä¼˜åŒ–æµ‹è¯• + éƒ¨ç½²ä¸Šçº¿

#### 9.5.3 è´¨é‡ä¿è¯

* ä»£ç å®¡æŸ¥: æ¯ä¸ªPRå¿…é¡»ç»è¿‡æ¨¡å—è´Ÿè´£äººå®¡æŸ¥
* è‡ªåŠ¨åŒ–æµ‹è¯•: å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%
* æ€§èƒ½ç›‘æ§: é¡µé¢åŠ è½½æ—¶é—´ < 3ç§’ï¼Œé¦–å±æ¸²æŸ“ < 1ç§’
* å…¼å®¹æ€§æµ‹è¯•: æ”¯æŒChrome 90+, Firefox 88+, Safari 14+

### 9.6 é£é™©æ§åˆ¶

#### 9.6.1 æŠ€æœ¯é£é™©

* æ’­æ”¾å™¨å…¼å®¹æ€§: æä¾›åŒæ’­æ”¾å™¨æ–¹æ¡ˆ + é™çº§ç­–ç•¥
* æµåª’ä½“ç¨³å®šæ€§: å®ç°è‡ªåŠ¨é‡è¿ + é”™è¯¯æ¢å¤æœºåˆ¶
* æ€§èƒ½ç“¶é¢ˆ: è™šæ‹Ÿæ»šåŠ¨ + æ‡’åŠ è½½ + ç¼“å­˜ä¼˜åŒ–
* æµè§ˆå™¨å…¼å®¹: æ¸è¿›å¼å¢å¼º + Polyfillæ”¯æŒ

#### 9.6.2 é¡¹ç›®é£é™©

* äººå‘˜é…ç½®: å…³é”®æ¨¡å—è‡³å°‘2äººæŒæ¡ï¼ŒçŸ¥è¯†å…±äº«
* è¿›åº¦å»¶è¯¯: åŠŸèƒ½ä¼˜å…ˆçº§æ˜ç¡®ï¼Œæ ¸å¿ƒåŠŸèƒ½ä¼˜å…ˆ
* éœ€æ±‚å˜æ›´: æ¨¡å—åŒ–è®¾è®¡ï¼Œé™ä½å˜æ›´å½±å“èŒƒå›´
* è´¨é‡é—®é¢˜: å®Œå–„çš„æµ‹è¯•ä½“ç³» + è‡ªåŠ¨åŒ–æ£€æŸ¥

### 9.7 æœ€ç»ˆäº¤ä»˜ç‰©

æœ¬å‰ç«¯è®¾è®¡æ–¹æ¡ˆåŒ…å«ä»¥ä¸‹å®Œæ•´äº¤ä»˜ç‰©ï¼š

ğŸ“ æŠ€æœ¯æ–¹æ¡ˆ* å®Œæ•´çš„æŠ€æœ¯æ¶æ„è®¾è®¡

* è¯¦ç»†çš„ç»„ä»¶è®¾è®¡æ–‡æ¡£
* APIæ¥å£è®¾è®¡è§„èŒƒ

ğŸ“ ä»£ç æ¨¡æ¿* é¡¹ç›®ç»“æ„ä¸é…ç½®æ–‡ä»¶

* æ ¸å¿ƒç»„ä»¶ä»£ç å®ç°
* çŠ¶æ€ç®¡ç†å®Œæ•´æ–¹æ¡ˆ

ğŸ“ éƒ¨ç½²æ–¹æ¡ˆ* Dockerå®¹å™¨åŒ–é…ç½®

* è‡ªåŠ¨åŒ–æ„å»ºè„šæœ¬
* ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æµç¨‹

ğŸ“ å›¢é˜Ÿåä½œ* è¯¦ç»†çš„åˆ†å·¥è®¡åˆ’

* å¼€å‘æµç¨‹è§„èŒƒ
* è´¨é‡ä¿è¯ä½“

* è´¨é‡ä¿è¯ä½“ç³»

---

ğŸš€ è¿™ä¸ªå‰ç«¯è®¾è®¡æ–¹æ¡ˆå·²ç»ä¸ºæ‚¨çš„GB28181è§†é¢‘å¹³å°é¡¹ç›®æä¾›äº†ä¸€ä¸ªåšå®çš„æŠ€æœ¯åŸºç¡€ã€‚å›¢é˜Ÿå¯ä»¥åŸºäºè¿™ä¸ªæ–¹æ¡ˆç›´æ¥å¼€å§‹ç¼–ç å®æ–½ï¼Œé¢„è®¡åœ¨8å‘¨å†…å®Œæˆä¸€ä¸ªé«˜è´¨é‡çš„ã€ç”Ÿäº§å°±ç»ªçš„å‰ç«¯åº”ç”¨ï¼

ğŸ’¡ å»ºè®®ä¸‹ä¸€æ­¥ï¼š1. æ ¹æ®å›¢é˜ŸæŠ€èƒ½æƒ…å†µè°ƒæ•´å…·ä½“åˆ†å·¥

1. æ­å»ºå¼€å‘ç¯å¢ƒå¹¶åˆå§‹åŒ–é¡¹ç›®
2. æŒ‰ç…§ä¼˜å…ˆçº§å¼€å§‹æ ¸å¿ƒåŠŸèƒ½å¼€å‘
3. å»ºç«‹æŒç»­é›†æˆå’Œä»£ç å®¡æŸ¥æµ

| è®¾è®¡ç»´åº¦   | ä¼ ç»Ÿæ–¹æ¡ˆ     | æˆ‘ä»¬çš„æ–¹æ¡ˆ         | ä¼˜åŠ¿                  |
| ---------- | ------------ | ------------------ | --------------------- |
| æ’­æ”¾å™¨é€‰æ‹© | å•ä¸€æ’­æ”¾å™¨   | åŒæ’­æ”¾å™¨è‡ªåŠ¨åˆ‡æ¢   | æ”¯æŒH264/H265æ— ç¼åˆ‡æ¢ |
| çŠ¶æ€ç®¡ç†   | Vuexå¤æ‚é…ç½® | Pinia + åˆ†æ¨¡å—è®¾è®¡ | ç±»å‹å®‰å…¨ + ç®€åŒ–å¼€å‘   |
