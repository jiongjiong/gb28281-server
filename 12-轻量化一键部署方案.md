# GB28181è§†é¢‘å¹³å°è½»é‡åŒ–ä¸€é”®éƒ¨ç½²æ–¹æ¡ˆ

## 1. å®Œæ•´Docker-Composeé…ç½®

### 1.1 ä¸»è¦æœåŠ¡é…ç½®

```yaml
# docker-compose.yml - è½»é‡åŒ–å®Œæ•´éƒ¨ç½²
version: '3.8'

services:
  # å‰ç«¯æœåŠ¡
  gb28181-frontend:
    build:
      context: ./web-frontend
      dockerfile: Dockerfile
    container_name: gb28181-frontend
    ports:
      - "3000:80"
    volumes:
      - ./web-frontend/nginx.conf:/etc/nginx/nginx.conf:ro
    environment:
      - API_BASE_URL=http://gb28181-core:8000
      - WS_URL=ws://gb28181-core:8000/ws
    depends_on:
      - gb28181-core
    restart: unless-stopped
    networks:
      - gb28181-network

  # æ ¸å¿ƒåç«¯æœåŠ¡
  gb28181-core:
    build:
      context: ./gb28181-core
      dockerfile: Dockerfile
    container_name: gb28181-core
    ports:
      - "8000:8000"     # HTTP API
      - "5060:5060/udp" # SIP UDP
      - "5060:5060/tcp" # SIP TCP
      - "2112:2112"     # Prometheus metrics
    volumes:
      - ./configs:/app/configs:ro
      - ./logs:/app/logs
      - ./data:/app/data
    environment:
      - DB_HOST=postgres
      - POSTGRES_USER=gb28181
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=gb28181_db
      - ZLM_PRIMARY_HOST=zlm-primary
      - ZLM_BACKUP1_HOST=zlm-backup1
      - LOG_LEVEL=info
      - PROMETHEUS_ENABLED=true
    depends_on:
      - postgres
      - zlm-primary
    restart: unless-stopped
    networks:
      - gb28181-network

  # æ•°æ®åº“æœåŠ¡
  postgres:
    image: postgres:15-alpine
    container_name: gb28181-postgres
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=gb28181
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=gb28181_db
      - POSTGRES_INITDB_ARGS=--auth-local=trust
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    restart: unless-stopped
    networks:
      - gb28181-network

  # ZLMediaKit ä¸»èŠ‚ç‚¹
  zlm-primary:
    image: zlmediakit/zlmediakit:latest
    container_name: zlm-primary
    ports:
      - "8080:80"       # HTTP API
      - "554:554"       # RTSP
      - "1935:1935"     # RTMP  
      - "8000:8000/udp" # RTP
      - "10000-10999:10000-10999/udp" # RTPç«¯å£èŒƒå›´
    volumes:
      - ./zlm-config/primary:/opt/media/conf
      - zlm-primary-data:/opt/media/bin/log
      - zlm-records:/opt/media/www/record
    environment:
      - ZLM_NODE_ROLE=primary
      - ZLM_NODE_WEIGHT=100
    restart: unless-stopped
    networks:
      - gb28181-network

  # ZLMediaKit å¤‡ç”¨èŠ‚ç‚¹1
  zlm-backup1:
    image: zlmediakit/zlmediakit:latest
    container_name: zlm-backup1
    ports:
      - "8081:80"       # HTTP API
      - "11000-11999:11000-11999/udp" # RTPç«¯å£èŒƒå›´
    volumes:
      - ./zlm-config/backup1:/opt/media/conf
      - zlm-backup1-data:/opt/media/bin/log
      - zlm-records:/opt/media/www/record
    environment:
      - ZLM_NODE_ROLE=backup
      - ZLM_NODE_WEIGHT=80
    restart: unless-stopped
    networks:
      - gb28181-network

  # Prometheus ç›‘æ§
  prometheus:
    image: prom/prometheus:v2.47.0
    container_name: gb28181-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./monitoring/prometheus/rules:/etc/prometheus/rules:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=30d'
      - '--web.enable-lifecycle'
    restart: unless-stopped
    networks:
      - gb28181-network

  # Grafana å¯è§†åŒ–
  grafana:
    image: grafana/grafana:10.1.0
    container_name: gb28181-grafana
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin123}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-simple-json-datasource
    volumes:
      - grafana-data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources:ro
    depends_on:
      - prometheus
    restart: unless-stopped
    networks:
      - gb28181-network

  # Node Exporter (ç³»ç»Ÿç›‘æ§)
  node-exporter:
    image: prom/node-exporter:v1.6.1
    container_name: gb28181-node-exporter
    ports:
      - "9100:9100"
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    command:
      - '--path.procfs=/host/proc'
      - '--path.rootfs=/rootfs'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    restart: unless-stopped
    networks:
      - gb28181-network

volumes:
  postgres-data:
    driver: local
  prometheus-data:
    driver: local
  grafana-data:
    driver: local
  zlm-primary-data:
    driver: local
  zlm-backup1-data:
    driver: local
  zlm-records:
    driver: local

networks:
  gb28181-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
```

### 1.2 ç¯å¢ƒå˜é‡é…ç½®

```bash
# .env - ç¯å¢ƒå˜é‡é…ç½®
# æ•°æ®åº“é…ç½®
POSTGRES_PASSWORD=gb28181_secure_password_2024

# Grafanaé…ç½®
GRAFANA_PASSWORD=admin123

# GB28181æ ¸å¿ƒæœåŠ¡é…ç½®
LOG_LEVEL=info
SIP_DOMAIN=3402000000
SIP_ID=34020000002000000001
SIP_PASSWORD=12345678

# ZLMediaKité…ç½®
ZLM_SECRET=035c73f7-bb6b-4889-a715-d9eb2d1925cc

# ç›‘æ§é…ç½®
PROMETHEUS_RETENTION=30d
GRAFANA_ADMIN_USER=admin
```

## 2. ç›‘æ§é…ç½®æ–‡ä»¶

### 2.1 Prometheusé…ç½®

```yaml
# monitoring/prometheus/prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

rule_files:
  - "rules/*.yml"

alerting:
  alertmanagers:
    - static_configs:
        - targets: []

scrape_configs:
  # GB28181æ ¸å¿ƒæœåŠ¡ç›‘æ§
  - job_name: 'gb28181-core'
    static_configs:
      - targets: ['gb28181-core:2112']
    scrape_interval: 15s
    metrics_path: '/metrics'
    
  # ç³»ç»Ÿç›‘æ§
  - job_name: 'node-exporter'
    static_configs:
      - targets: ['node-exporter:9100']
    
  # ZLMediaKitç›‘æ§
  - job_name: 'zlmediakit-primary'
    static_configs:
      - targets: ['zlm-primary:80']
    metrics_path: '/index/api/getStatistic'
    params:
      secret: ['035c73f7-bb6b-4889-a715-d9eb2d1925cc']
      
  - job_name: 'zlmediakit-backup1'  
    static_configs:
      - targets: ['zlm-backup1:80']
    metrics_path: '/index/api/getStatistic'
    params:
      secret: ['035c73f7-bb6b-4889-a715-d9eb2d1925cc']

  # Prometheusè‡ªèº«ç›‘æ§
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
```

### 2.2 Grafanaæ•°æ®æºé…ç½®

```yaml
# monitoring/grafana/datasources/prometheus.yml
apiVersion: 1

datasources:
  - name: Prometheus
    type: prometheus
    access: proxy
    url: http://prometheus:9090
    isDefault: true
    editable: true
```

### 2.3 Grafanaä»ªè¡¨æ¿é…ç½®

```yaml
# monitoring/grafana/dashboards/dashboard.yml
apiVersion: 1

providers:
  - name: 'default'
    orgId: 1
    folder: ''
    type: file
    disableDeletion: false
    updateIntervalSeconds: 10
    options:
      path: /etc/grafana/provisioning/dashboards
```

## 3. ä¸€é”®éƒ¨ç½²è„šæœ¬

### 3.1 éƒ¨ç½²è„šæœ¬

```bash
#!/bin/bash
# deploy.sh - ä¸€é”®éƒ¨ç½²è„šæœ¬

set -e

echo "ğŸš€ GB28181è§†é¢‘å¹³å°è½»é‡åŒ–éƒ¨ç½²å¼€å§‹..."

# æ£€æŸ¥Dockerå’ŒDocker-compose
check_dependencies() {
    echo "ğŸ“‹ æ£€æŸ¥ä¾èµ–..."
    
    if ! command -v docker &> /dev/null; then
        echo "âŒ Docker æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker"
        exit 1
    fi
    
    if ! command -v docker-compose &> /dev/null; then
        echo "âŒ Docker-compose æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker-compose"
        exit 1
    fi
    
    echo "âœ… ä¾èµ–æ£€æŸ¥å®Œæˆ"
}

# åˆ›å»ºå¿…è¦çš„ç›®å½•
create_directories() {
    echo "ğŸ“ åˆ›å»ºç›®å½•ç»“æ„..."
    
    mkdir -p {configs,logs,data,monitoring/{prometheus/rules,grafana/{dashboards,datasources}},zlm-config/{primary,backup1},database}
    
    echo "âœ… ç›®å½•åˆ›å»ºå®Œæˆ"
}

# ç”Ÿæˆé…ç½®æ–‡ä»¶
generate_configs() {
    echo "âš™ï¸  ç”Ÿæˆé…ç½®æ–‡ä»¶..."
    
    # ç”Ÿæˆ.envæ–‡ä»¶
    if [ ! -f .env ]; then
        cat > .env << EOF
POSTGRES_PASSWORD=$(openssl rand -base64 32)
GRAFANA_PASSWORD=admin123
LOG_LEVEL=info
SIP_DOMAIN=3402000000
SIP_ID=34020000002000000001
SIP_PASSWORD=12345678
ZLM_SECRET=$(uuidgen)
EOF
        echo "âœ… .env æ–‡ä»¶å·²ç”Ÿæˆ"
    fi
    
    # ç”Ÿæˆæ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
    cat > database/init.sql << 'EOF'
-- GB28181æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- è®¾å¤‡è¡¨
CREATE TABLE IF NOT EXISTS devices (
    id VARCHAR(50) PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    manufacturer VARCHAR(100),
    model VARCHAR(100),
    firmware VARCHAR(50),
    ip_address INET,
    port INTEGER,
    status VARCHAR(20) DEFAULT 'offline',
    register_time TIMESTAMP,
    keepalive_time TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- é€šé“è¡¨
CREATE TABLE IF NOT EXISTS channels (
    id VARCHAR(50) PRIMARY KEY, 
    device_id VARCHAR(50) REFERENCES devices(id),
    name VARCHAR(100),
    manufacturer VARCHAR(100),
    model VARCHAR(100),
    status VARCHAR(20) DEFAULT 'offline',
    ptz_type INTEGER DEFAULT 0,
    longitude DECIMAL(10,7),
    latitude DECIMAL(10,7),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç”¨æˆ·è¡¨
CREATE TABLE IF NOT EXISTS users (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    username VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    email VARCHAR(100),
    role VARCHAR(20) DEFAULT 'user',
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- æ’å…¥é»˜è®¤ç®¡ç†å‘˜ç”¨æˆ· (å¯†ç : admin123)
INSERT INTO users (username, password_hash, role) 
VALUES ('admin', '$2a$10$rI4eKl6O3lRCH5mLRq/zIeU8i9qPYHdEGNqH5P5p5z1Q2Q2Q2Q2Q2', 'admin')
ON CONFLICT (username) DO NOTHING;

-- åˆ›å»ºç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_devices_status ON devices(status);
CREATE INDEX IF NOT EXISTS idx_channels_device_id ON channels(device_id);
CREATE INDEX IF NOT EXISTS idx_channels_status ON channels(status);
EOF
    
    echo "âœ… é…ç½®æ–‡ä»¶ç”Ÿæˆå®Œæˆ"
}

# æ„å»ºå’Œå¯åŠ¨æœåŠ¡
deploy_services() {
    echo "ğŸ—ï¸  æ„å»ºå’Œå¯åŠ¨æœåŠ¡..."
    
    # æ„å»ºé•œåƒ
    docker-compose build --no-cache gb28181-core gb28181-frontend
    
    # å¯åŠ¨æœåŠ¡
    docker-compose up -d
    
    echo "âœ… æœåŠ¡å¯åŠ¨å®Œæˆ"
}

# ç­‰å¾…æœåŠ¡å°±ç»ª
wait_for_services() {
    echo "â³ ç­‰å¾…æœåŠ¡å°±ç»ª..."
    
    # ç­‰å¾…æ•°æ®åº“å°±ç»ª
    echo "ç­‰å¾…æ•°æ®åº“å¯åŠ¨..."
    until docker-compose exec -T postgres pg_isready -U gb28181; do
        sleep 2
    done
    
    # ç­‰å¾…æ ¸å¿ƒæœåŠ¡å°±ç»ª
    echo "ç­‰å¾…GB28181æ ¸å¿ƒæœåŠ¡å¯åŠ¨..."
    until curl -f http://localhost:8000/health >/dev/null 2>&1; do
        sleep 2
    done
    
    # ç­‰å¾…å‰ç«¯æœåŠ¡å°±ç»ª
    echo "ç­‰å¾…å‰ç«¯æœåŠ¡å¯åŠ¨..."
    until curl -f http://localhost:3000 >/dev/null 2>&1; do
        sleep 2
    done
    
    echo "âœ… æ‰€æœ‰æœåŠ¡å·²å°±ç»ª"
}

# æ˜¾ç¤ºéƒ¨ç½²ç»“æœ
show_results() {
    echo ""
    echo "ğŸ‰ GB28181è§†é¢‘å¹³å°éƒ¨ç½²å®Œæˆï¼"
    echo ""
    echo "ğŸ“± è®¿é—®åœ°å€ï¼š"
    echo "  å‰ç«¯ç®¡ç†ç•Œé¢: http://localhost:3000"
    echo "  APIæ–‡æ¡£:     http://localhost:8000/swagger"
    echo "  Grafanaç›‘æ§: http://localhost:3001 (admin/admin123)"
    echo "  Prometheus:  http://localhost:9090"
    echo ""
    echo "ğŸ”§ SIPä¿¡ä»¤é…ç½®ï¼š"
    echo "  SIPç«¯å£:     5060 (UDP/TCP)"
    echo "  åŸŸå:        3402000000"
    echo "  è®¾å¤‡ID:      34020000002000000001"
    echo "  å¯†ç :        12345678"
    echo ""
    echo "ğŸ“Š ç›‘æ§ä¿¡æ¯ï¼š"
    echo "  ç³»ç»ŸæŒ‡æ ‡:    http://localhost:9100/metrics"
    echo "  åº”ç”¨æŒ‡æ ‡:    http://localhost:2112/metrics"
    echo ""
    echo "ğŸ“‹ å¸¸ç”¨å‘½ä»¤ï¼š"
    echo "  æŸ¥çœ‹æ—¥å¿—:    docker-compose logs -f"
    echo "  é‡å¯æœåŠ¡:    docker-compose restart"
    echo "  åœæ­¢æœåŠ¡:    docker-compose down"
    echo "  æ›´æ–°æœåŠ¡:    docker-compose pull && docker-compose up -d"
    echo ""
}

# ä¸»å‡½æ•°
main() {
    check_dependencies
    create_directories
    generate_configs
    deploy_services
    wait_for_services
    show_results
}

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"
```

### 3.2 æœåŠ¡ç®¡ç†è„šæœ¬

```bash
#!/bin/bash
# manage.sh - æœåŠ¡ç®¡ç†è„šæœ¬

case "$1" in
    start)
        echo "ğŸš€ å¯åŠ¨GB28181è§†é¢‘å¹³å°..."
        docker-compose up -d
        ;;
    stop)
        echo "ğŸ›‘ åœæ­¢GB28181è§†é¢‘å¹³å°..."
        docker-compose down
        ;;
    restart)
        echo "ğŸ”„ é‡å¯GB28181è§†é¢‘å¹³å°..."
        docker-compose restart
        ;;
    status)
        echo "ğŸ“Š GB28181è§†é¢‘å¹³å°çŠ¶æ€ï¼š"
        docker-compose ps
        ;;
    logs)
        echo "ğŸ“‹ GB28181è§†é¢‘å¹³å°æ—¥å¿—ï¼š"
        docker-compose logs -f --tail=100
        ;;
    update)
        echo "â¬†ï¸  æ›´æ–°GB28181è§†é¢‘å¹³å°..."
        docker-compose pull
        docker-compose up -d
        ;;
    backup)
        echo "ğŸ’¾ å¤‡ä»½æ•°æ®..."
        mkdir -p backups/$(date +%Y%m%d_%H%M%S)
        docker-compose exec -T postgres pg_dump -U gb28181 gb28181_db > backups/$(date +%Y%m%d_%H%M%S)/database.sql
        cp -r data backups/$(date +%Y%m%d_%H%M%S)/
        echo "âœ… å¤‡ä»½å®Œæˆ"
        ;;
    cleanup)
        echo "ğŸ§¹ æ¸…ç†æœªä½¿ç”¨çš„é•œåƒå’Œå®¹å™¨..."
        docker system prune -f
        ;;
    *)
        echo "ç”¨æ³•: $0 {start|stop|restart|status|logs|update|backup|cleanup}"
        exit 1
        ;;
esac
```

## 4. éƒ¨ç½²è¯´æ˜

### 4.1 å¿«é€Ÿéƒ¨ç½²

```bash
# 1. å…‹éš†é¡¹ç›®ä»£ç 
git clone <project-repo>
cd gb28181-platform

# 2. æ‰§è¡Œä¸€é”®éƒ¨ç½²
chmod +x deploy.sh
./deploy.sh

# 3. è®¿é—®ç³»ç»Ÿ
# å‰ç«¯: http://localhost:3000
# ç›‘æ§: http://localhost:3001
```

### 4.2 ç³»ç»Ÿè¦æ±‚

- **æ“ä½œç³»ç»Ÿ**: Linux/MacOS/Windows (æ”¯æŒDocker)
- **å†…å­˜**: æœ€å°‘4GBï¼Œæ¨è8GB
- **å­˜å‚¨**: æœ€å°‘20GBå¯ç”¨ç©ºé—´
- **ç½‘ç»œ**: å¼€æ”¾ç«¯å£ 3000, 5060, 8000-8002, 9090, 9100

### 4.3 æ€§èƒ½å‚æ•°

| é…ç½®é¡¹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|--------|------|
| æœ€å¤§è®¾å¤‡æ•° | 10,000+ | æ”¯æŒå¤§è§„æ¨¡è®¾å¤‡æ¥å…¥ |
| å†…å­˜ä½¿ç”¨ | <500MB | è½»é‡åŒ–è®¾è®¡ |
| å¯åŠ¨æ—¶é—´ | 10-20ç§’ | å¿«é€Ÿå¯åŠ¨ |
| å“åº”å»¶è¿Ÿ | <50ms | é«˜æ€§èƒ½å“åº” |

### 4.4 æ•…éšœæ’é™¤

```bash
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡æ—¥å¿—
docker-compose logs gb28181-core

# é‡å¯ç‰¹å®šæœåŠ¡
docker-compose restart gb28181-core

# è¿›å…¥å®¹å™¨è°ƒè¯•
docker-compose exec gb28181-core bash
```

è¿™ä¸ªè½»é‡åŒ–éƒ¨ç½²æ–¹æ¡ˆå®ç°äº†ï¼š

âœ… **ä¸€é”®éƒ¨ç½²** - å•ä¸ªè„šæœ¬å®Œæˆæ‰€æœ‰é…ç½®
âœ… **è½»é‡åŒ–æ¶æ„** - é¿å…ä½¿ç”¨Redisç­‰é‡å‹ä¸­é—´ä»¶  
âœ… **å®Œæ•´ç›‘æ§** - Prometheus + Grafanaç›‘æ§ä½“ç³»
âœ… **é«˜å¯ç”¨ZLM** - ä¸»å¤‡åˆ‡æ¢æœºåˆ¶
âœ… **æ™ºèƒ½ç¼“å­˜** - å†…å­˜ç¼“å­˜æ›¿ä»£Redis
âœ… **å®¹å™¨åŒ–éƒ¨ç½²** - Docker-composeç®¡ç†
âœ… **è‡ªåŠ¨åŒ–è¿ç»´** - æœåŠ¡ç®¡ç†å’Œå¤‡ä»½è„šæœ¬

æ•´ä¸ªç³»ç»Ÿéƒ¨ç½²ååªéœ€è¦3ä¸ªå®¹å™¨ç»„(å‰ç«¯+åç«¯+æµåª’ä½“)ï¼Œå®Œå…¨ç¬¦åˆè½»é‡åŒ–è¦æ±‚ï¼ŒåŒæ—¶æä¾›äº†ä¼ä¸šçº§çš„ç›‘æ§å’Œè¿ç»´èƒ½åŠ›ã€‚